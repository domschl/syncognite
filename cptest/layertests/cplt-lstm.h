#ifndef _CPLT_LSTM_H
#define _CPLT_LSTM_H

#include "../testneural.h"

bool checkLSTMStepForward(floatN eps=CP_DEFAULT_NUM_EPS) {
    MatrixN x(3,4);    // N, D  // N, D, H = 3, 4, 5
    x << -0.4       , -0.25454545, -0.10909091,  0.03636364,
         0.18181818,  0.32727273,  0.47272727,  0.61818182,
         0.76363636,  0.90909091,  1.05454545,  1.2;
    MatrixN Wxh(4,4*5); // D, 4*H
    MatrixN Whh(5,4*5); // H, 4*H
    Wxh << -2.1       , -2.05696203, -2.01392405, -1.97088608, -1.9278481 ,
        -1.88481013, -1.84177215, -1.79873418, -1.7556962 , -1.71265823,
        -1.66962025, -1.62658228, -1.5835443 , -1.54050633, -1.49746835,
        -1.45443038, -1.41139241, -1.36835443, -1.32531646, -1.28227848,
        -1.23924051, -1.19620253, -1.15316456, -1.11012658, -1.06708861,
        -1.02405063, -0.98101266, -0.93797468, -0.89493671, -0.85189873,
        -0.80886076, -0.76582278, -0.72278481, -0.67974684, -0.63670886,
        -0.59367089, -0.55063291, -0.50759494, -0.46455696, -0.42151899,
        -0.37848101, -0.33544304, -0.29240506, -0.24936709, -0.20632911,
        -0.16329114, -0.12025316, -0.07721519, -0.03417722,  0.00886076,
         0.05189873,  0.09493671,  0.13797468,  0.18101266,  0.22405063,
         0.26708861,  0.31012658,  0.35316456,  0.39620253,  0.43924051,
         0.48227848,  0.52531646,  0.56835443,  0.61139241,  0.65443038,
         0.69746835,  0.74050633,  0.7835443 ,  0.82658228,  0.86962025,
         0.91265823,  0.9556962 ,  0.99873418,  1.04177215,  1.08481013,
         1.1278481 ,  1.17088608,  1.21392405,  1.25696203,  1.3;
    Whh << -0.7       , -0.67070707, -0.64141414, -0.61212121, -0.58282828,
        -0.55353535, -0.52424242, -0.49494949, -0.46565657, -0.43636364,
        -0.40707071, -0.37777778, -0.34848485, -0.31919192, -0.28989899,
        -0.26060606, -0.23131313, -0.2020202 , -0.17272727, -0.14343434,
        -0.11414141, -0.08484848, -0.05555556, -0.02626263,  0.0030303 ,
         0.03232323,  0.06161616,  0.09090909,  0.12020202,  0.14949495,
         0.17878788,  0.20808081,  0.23737374,  0.26666667,  0.2959596 ,
         0.32525253,  0.35454545,  0.38383838,  0.41313131,  0.44242424,
         0.47171717,  0.5010101 ,  0.53030303,  0.55959596,  0.58888889,
         0.61818182,  0.64747475,  0.67676768,  0.70606061,  0.73535354,
         0.76464646,  0.79393939,  0.82323232,  0.85252525,  0.88181818,
         0.91111111,  0.94040404,  0.96969697,  0.9989899 ,  1.02828283,
         1.05757576,  1.08686869,  1.11616162,  1.14545455,  1.17474747,
         1.2040404 ,  1.23333333,  1.26262626,  1.29191919,  1.32121212,
         1.35050505,  1.37979798,  1.40909091,  1.43838384,  1.46767677,
         1.4969697 ,  1.52626263,  1.55555556,  1.58484848,  1.61414141,
         1.64343434,  1.67272727,  1.7020202 ,  1.73131313,  1.76060606,
         1.78989899,  1.81919192,  1.84848485,  1.87777778,  1.90707071,
         1.93636364,  1.96565657,  1.99494949,  2.02424242,  2.05353535,
         2.08282828,  2.11212121,  2.14141414,  2.17070707,  2.2;
    MatrixN bh(1,4*5); // 4*H
    bh << 0.3       ,  0.32105263,  0.34210526,  0.36315789,  0.38421053,
        0.40526316,  0.42631579,  0.44736842,  0.46842105,  0.48947368,
        0.51052632,  0.53157895,  0.55263158,  0.57368421,  0.59473684,
        0.61578947,  0.63684211,  0.65789474,  0.67894737,  0.7;
    MatrixN h(3,5);  // N, H (prev_h)
    h << -0.3       , -0.22857143, -0.15714286, -0.08571429, -0.01428571,
         0.05714286,  0.12857143,  0.2       ,  0.27142857,  0.34285714,
         0.41428571,  0.48571429,  0.55714286,  0.62857143,  0.7;
    MatrixN hn(3,5); // N, H (next_h)
    hn << 0.24635157,  0.28610883,  0.32240467,  0.35525807,  0.38474904,
         0.49223563,  0.55611431,  0.61507696,  0.66844003,  0.7159181 ,
         0.56735664,  0.66310127,  0.74419266,  0.80889665,  0.858299;
    MatrixN c(3,5);  // N, H (prev_c)
    c << -0.4       , -0.30714286, -0.21428571, -0.12142857, -0.02857143,
         0.06428571,  0.15714286,  0.25      ,  0.34285714,  0.43571429,
         0.52857143,  0.62142857,  0.71428571,  0.80714286,  0.9;
    MatrixN cn(3,5); // N, H (next_c)
    cn << 0.32986176,  0.39145139,  0.451556  ,  0.51014116,  0.56717407,
         0.66382255,  0.76674007,  0.87195994,  0.97902709,  1.08751345,
         0.74192008,  0.90592151,  1.07717006,  1.25120233,  1.42395676;

    LSTM lstm("{name='testlstm';inputShape=[4,1];H=5;N=3}");
    *(lstm.params["Wxh"])= Wxh;
    *(lstm.params["Whh"])= Whh;
    *(lstm.params["bh"])=bh;
    t_cppl cache;
    t_cppl states;
    cppl_set(&states,"testlstm-h",new MatrixN(h));
    cppl_set(&states,"testlstm-c",new MatrixN(c));
    t_cppl cp=lstm.forward_step(x, &cache, &states, 0);
    cppl_delete(&cache);
    cppl_delete(&states);
    bool allOk=true;
    if (!matComp(hn,*(cp["testlstm-h0"]),"LSTMForwardStep",eps)) {
        allOk = false;
    }
    if (!matComp(cn,*(cp["testlstm-c0"]),"LSTMForwardStep",eps)) {
        allOk = false;
    }
    cppl_delete(&cp);
    return allOk;
}

bool checkLSTMStepBackward(float eps=CP_DEFAULT_NUM_EPS) {
    MatrixN x(4,5);     // N, D, H = 4, 5, 6
    x << 0.0871107, -0.61504182, -0.62466852, -0.1710203, 0.2413938,
        -0.42729072, 0.58361612, -0.75185921, -0.88845531, -0.81558297,
        0.39905526, -1.37877218, 0.42658499, -0.83351793, 0.2215589,
        0.26092829, 1.31782586, -0.04876825, -1.0563379, 1.90000913;
    MatrixN Wxh(5,4*6);
    Wxh << 1.67231976, 0.94457082, -1.59046386, 0.78564787, -0.26963539, 0.69146119,
        0.08774743, 1.22225406, 0.61797164, 0.23233868, -1.52093713, -0.56005574,
        0.1093506, -0.12876097, -0.27926513, 0.4327001, -0.14286482, 1.32578462,
        -0.35803341, 1.17326649, -0.06622818, -2.23492114, -0.68790401, -1.30150373,
        1.50561292, -0.19408519, 2.74818518, 0.50597622, -1.02087205, 0.86944464,
        0.67609062, 0.15769015, -1.90708282, -0.80882322, 0.02618902, -0.83189323,
        -0.25762474, 1.59241342, 1.42737598, -0.10285135, 1.49054251, 0.93913081,
        -1.370892, -1.92270299, 0.13851127, -1.87197171, 1.1774237, 0.24820509,
        -0.47323217, -1.39962245, 0.39651232, -1.68458058, -0.31738383, 1.07673547,
        -1.69629334, -0.34439286, 0.15885223, 1.15587471, -0.23605429, -1.20392132,
        0.23741647, -2.08193336, -0.95961855, 0.47222682, -0.25308625, 0.15212779,
        0.55345875, 0.76139121, 1.88106585, 1.00899556, 1.54161965, 0.98470818,
        -1.02259829, -0.27351831, 0.45549583, -1.46373186, -0.26186267, -2.07864781,
        1.64762783, 1.90406158, 0.80254508, -0.63276833, -2.29790553, 0.45499835,
        0.04195063, -0.05876303, -2.53531778, 0.03323857, -0.06649517, 1.0652346,
        1.41720668, 1.39678019, 0.04522445, 0.03600546, 0.52194698, -1.8469723,
        -1.20903461, 1.41626367, -0.78225555, 0.0267529, -0.70065832, -0.40119178,
        -0.16151207, -0.00969331, -0.5358501, -0.80213472, 1.02730102, 0.87873011,
        -1.08818975, 1.66854346, 0.97529632, 1.44925117, 0.13832278, 1.64164755,
        0.04749087, 0.63315802, 0.23268963, 0.33788006, -0.46420033, 0.28117938;
    MatrixN Whh(6,4*6);
    Whh << -0.51989091, -0.12774683, -0.97130712, -1.19988554, 0.261293, -1.08210639,
        -0.46146772, -0.51843343, 0.93203774, -0.76116735, 1.03140323, 0.25722736,
        0.25073403, -0.55331687, -0.20409439, -0.39448788, 0.55904542, 0.86158567,
        0.4312841, -0.35807549, -0.7546594, -1.4226083, 0.4362348, -0.13056774,
        0.84575395, 0.36310091, -1.05620013, 0.32641579, -0.5020443, -2.56925648,
        -0.65551937, -0.44870916, 1.27833629, -1.04005898, 1.69035204, 1.30598692,
        0.78926281, 0.62842549, 1.27774634, 0.11667877, -0.728364, 1.53007106,
        -0.29169838, -2.19240039, -1.23952473, 1.87454608, -0.85549982, -0.29380623,
        -1.40817099, 0.5359255, 0.38696549, 0.27469018, -0.44578254, 0.66676479,
        -1.57310748, -0.14064329, -0.07443006, 0.07551643, -0.38620622, -0.13837108,
        -0.8581351, 1.35437035, -1.87074544, 0.02320933, 0.22785703, 0.17938608,
        0.30867081, 0.19078725, 0.16709089, 0.00446662, -0.51175015, -0.46924069,
        1.76512656, 1.25111896, -0.6946343, 0.314578, 0.77374841, -0.20951208,
        -0.93662364, -0.13374722, 1.10314917, -1.00477867, -0.38377153, 1.70900563,
        -0.0929966, 0.10957718, -0.55405018, -0.74775287, -0.41184619, 2.17251662,
        1.01213592, -0.63528024, -0.34034862, 0.02368345, 1.68891705, 1.55206781,
        1.26335637, -1.18792282, 0.39367224, -0.24856924, 1.14380818, -0.77054535,
        0.07992548, -0.44584298, 0.07398662, 0.15624592, -0.2753091, 0.0240697,
        -0.41009994, -0.52514587, -0.58993751, -0.18565636, 0.58147075, -2.32365926,
        0.37096383, 0.73017761, -0.4773638, -1.55915118, -1.31312541, -0.37188893,
        1.51900952, -0.959909, 0.88376022, -0.70538727, 0.93194666, 0.44611254,
        0.44255143, -0.35097337, -0.9033578, 2.59103302, 0.358385, -0.39322468,
        -1.36236075, 0.91295046, -0.86221768, 1.27223908, -0.4705885, -0.49571326,
        1.6328264, -1.04997993, -2.76898417, 0.47601528, -1.17103407, -0.24339371;
    MatrixN bh(1,4*6);
    bh <<  -0.0653378, -1.32989109, -0.95406261, 0.61358856, 0.06921843, -0.7114319,
         0.81431978, -0.01520707, 0.07008937, -0.5399855, 0.00719432, -0.08391907,
         -0.44713585, 0.06168086, -0.51086977, 0.06098595, -1.40550122, 0.00192894,
         1.15226073, 0.68518931, -0.17004284, 0.06703904, 0.79842334, -0.46417552;
    MatrixN h0(4,6);
    h0 << 0.35495595, -1.10451304, 1.10057149, -0.75263449, 0.94624812, -1.24202715,
        1.04894754, 0.82888119, -0.29526206, -0.69242865, -0.96694184, 1.46484541,
        -0.98061148, 0.26810979, 0.58418927, 0.37009559, -0.70185348, 0.7601071,
        -0.31797195, -1.1400492, 1.59601903, 1.5635216, -1.87329932, 0.9532305;
    MatrixN c0(4,6);
    c0 << 0.35233796, -2.15761027,  0.05000112, -2.6656004,  -2.14164851, -0.0747306,
   0.36416211, -1.98388681,  1.94876576,  1.09490469,  0.28573774, -1.55307111,
  -1.38440604, -0.29165017, -0.14491362,  1.1871104,   0.48349733, -1.56116523,
  -0.39156165, -0.13514026,  1.84395872, -0.18494329, -0.16897181, -0.17415186;

    MatrixN dx(4,5);
    dx << -1.40294565, -0.07047986, -1.00464135, -0.98726762,  0.67941976,
   0.18956968, -0.87899967, -0.00507276,  2.36415359, -0.04458574,
  -0.34145366, -0.68223105, -0.86291759,  0.8245847,   1.17717544,
   1.16440531,  0.96858699, -1.99712481, -0.08466606, -0.54624539;
    MatrixN dWxh(5,4*6);
    dWxh << -1.57310262e-01,  1.06104468e-01,  2.24857654e-02,  5.36361887e-03,
    1.43302478e-01, -5.17691279e-02,  2.43894490e-02, -8.75716144e-02,
   -2.17518597e-02, -1.29153019e-02,  3.71261963e-02, -1.25196993e-01,
   -4.71167864e-02,  6.99470324e-02,  5.00279655e-03,  4.56454317e-02,
   -6.09810747e-03, -1.24195233e-02, -3.85758831e-01,  3.96814763e-02,
   -2.12026721e-01, -7.85227015e-02, -1.00477554e-01,  6.99571340e-02,
    5.85590114e-01, -4.39622243e-01, -9.61373370e-03,  1.44396878e-01,
   -2.54001621e-01,  1.16742402e-01, -1.37868051e-01,  4.61545207e-01,
    1.02644886e-02,  3.18247756e-01, -3.07808657e-01, -3.83499401e-02,
    1.99058132e-02, -2.86295165e-01, -1.08548623e-02,  1.55135988e-01,
   -6.16527744e-03,  9.24914858e-03,  5.81731409e-01, -3.26519550e-01,
   -1.06751073e+00, -6.76764037e-01,  1.63686995e-01, -1.01893736e-02,
   -1.80370164e-01, -1.49368193e-02,  4.45061763e-02,  2.24993302e-01,
   -2.91538601e-02, -4.93809190e-02, -2.45027564e-03,  1.13404905e-01,
   -3.37776912e-02,  3.44437855e-01, -2.52471995e-01, -2.19697521e-01,
   -1.48205568e-01, -1.87219332e-02,  5.28967145e-03,  2.89322697e-01,
   -5.24427091e-02, -2.97444869e-02, -6.92762600e-01,  7.03850805e-02,
    3.92183465e-02,  9.82181358e-02, -1.00790944e-01,  1.48249841e-01,
    2.90047323e-01, -3.13125226e-01,  3.35615195e-02,  8.92567177e-02,
    1.52308460e-01, -4.68249712e-02, -1.32925163e-01, -4.32304562e-02,
   -3.98302261e-02,  9.08965040e-02, -6.42351173e-02, -3.62804353e-01,
   -1.30900585e-01, -1.54103671e-01, -1.92176755e-02,  3.52594995e-01,
   -3.96812472e-02, -3.53335232e-02, -8.38282026e-01, -3.92431130e-02,
    8.57602495e-01,  5.84166572e-01, -2.26110883e-01,  3.14190939e-01,
   -5.23349516e-02,  7.56167088e-02,  5.44044073e-02, -1.50348008e-03,
    3.86632120e-01, -8.63145950e-02, -1.33698928e-02, -6.87111255e-02,
   -5.77875042e-02, -1.52665188e-02,  6.25553821e-02, -3.96053814e-01,
   -8.58535996e-02,  6.07339571e-02,  6.89972222e-03,  1.37412045e-01,
    5.94453528e-04, -2.52334872e-02, -6.90945662e-01, -1.27764000e-01,
   -1.54133042e+00, -8.05634037e-01, -2.18096000e-01,  1.90520431e-01;
    MatrixN dWhh(6,4*6);
    dWhh << 0.39439872, -0.17010179, -0.05959418, -0.17218494, -0.14196335,  0.10218447,
  -0.04846763,  0.0300637,   0.04934498, -0.23869013,  0.13871775,  0.28495126,
   0.16289639, -0.09899135, -0.01288238, -0.24267206,  0.04519203,  0.03546938,
   0.95717819, -0.12509455,  0.25879896,  0.04274658,  0.18429785, -0.1693167,
  -0.12173819, -0.06439702, -0.0357352,   0.25530329, -0.66207466,  0.11242051,
   0.04658635,  0.39674918,  0.05604983,  0.46781227, -0.42960874,  0.41524262,
   0.01654473, -0.09623171,  0.00617639,  0.01022414, -0.03859114,  0.01997282,
   0.72126626,  0.13891908,  0.92455735,  0.44740576,  0.33236083, -0.24691851,
  -0.19569568,  0.33275328,  0.01583391, -0.27841395,  0.51393751, -0.08945814,
   0.06935356, -0.36747447, -0.02817542, -0.47517347,  0.43378546, -0.14202101,
   0.05421843,  0.22886925,  0.0101808,  -0.23717341,  0.05601528,  0.0016954,
  -0.22563065, -0.04552109, -1.29520155, -0.71493308, -0.17308171,  0.02147143,
  -0.11725135, -0.03309697,  0.05855957,  0.27162499, -0.00622651, -0.03607991,
  -0.0121903,   0.27199206, -0.04569332,  0.45916865, -0.34129283, -0.30787496,
  -0.1521826,  -0.04323194,  0.01147095,  0.31930605, -0.04741432, -0.02913094,
  -0.59039766, -0.07598915, -1.26843923, -0.66228546, -0.07412154,  0.13949562,
   0.21640086, -0.11513823,  0.01512733, -0.23037059,  0.5085872,  -0.1070871,
  -0.09646704, -0.51583787, -0.03761958, -0.48517977,  0.42066403, -0.32611372,
  -0.04716268,  0.00856749, -0.02446042,  0.09306197,  0.00872662, -0.02765329,
  -0.93395393,  0.05092525,  1.51999224,  0.97608326, -0.3633164,   0.32435087,
  -0.25486822,  0.10233599, -0.0438111,   0.276555,   -0.78947859,  0.16109927,
   0.12179536,  0.61343985,  0.07213538,  0.57626988, -0.52239837,  0.57689171,
   0.08759523, -0.03503651,  0.02452667, -0.16250297, -0.01503818,  0.04249588,
   1.3613644,   0.03664259, -0.77374922, -0.59669917,  0.519217,   -0.46093771;
    MatrixN dbh(1,4*6);
    dbh << -0.35576894,  0.49262835, -0.05006048, -0.33156571,  0.09211247,  0.01521882,
  0.17410673, -0.25916032,  0.0454027,  -0.5079231,   0.41362445,  0.42590895,
  0.21489715,  0.2862747,   0.01915112, -0.59293469,  0.08366239,  0.04712374,
  0.93838772,  0.06989887, -0.81215466, -0.56784333,  0.16807208, -0.35722049;
    MatrixN dh0(4,6);
    dh0 << 1.47998717,  1.46677484, -0.19186037,  0.74601721,  0.36893686, -0.84248438,
  0.8996224,   0.01571788,  0.17354335,  1.7291758,  -0.255742,    0.12586002,
  0.15389183, -0.21301641,  0.75289004, -0.3565057,  -0.78261979, -1.0909945,
  1.1949185,   0.10407293, -0.18119553,  0.27922584,  1.12474144,  2.33079594;
    MatrixN dc0(4,6);
    dc0 << 0.13608108,  0.36243765, -0.08135181,  0.20644522, -0.23005649,  0.05039556,
  0.88429173, -0.05720065,  0.03019144, -0.33930842,  1.31901132, -0.33079744,
 -0.0822288,   0.30469877, -0.19032635,  0.04229486,  0.12969023, -0.20698999,
  0.00608137, -0.68885403, -0.0050103,  -0.31733399,  0.65378473,  0.90832778;

      MatrixN dhnext(4,6);  // dchain(4,6);
      dhnext << 2.27643053, -0.7885388,  -0.48256725,  1.65741074, -0.31026046, -1.86046244,
  1.08930257, -0.47004494, -0.44363876, -1.18237561, -0.89043072, -0.28649944,
  0.05262659,  1.42914342, -0.92187717, -1.2034729,   0.0572265,  -0.06849968,
 -0.59068138, -1.44350253, -0.49717128, -0.24463223, -0.35138132, -0.70493229;

      MatrixN dcnext(4,6);  // dchain(4,6);
      dcnext << -0.32148315,  0.85657749, -0.12443571,  1.90182063, -1.38133461,  0.20032047,
  0.68933673, -0.51407012,  0.58889961, -0.26869602,  1.49420135, -1.08012068,
 -1.6213349,   0.72557348, -0.09883938,  0.11600921,  0.17970186, -0.29548906,
  0.13532574, -1.56997402, -0.65726879, -0.59209996,  0.96049231,  1.87353271;

    LSTM lstm("{name='test3lstm';inputShape=[5,1];H=6;N=4}");
    *(lstm.params["Wxh"])=Wxh;
    *(lstm.params["Whh"])=Whh;
    *(lstm.params["bh"])=bh;
    t_cppl cache;
    t_cppl grads;
    t_cppl states;
    cppl_set(&states,"test3lstm-h",new MatrixN(h0));
    cppl_set(&states,"test3lstm-c",new MatrixN(c0));
    t_cppl cp=lstm.forward_step(x, &cache, &states);
    cppl_delete(&cp);
    if (!matComp(*states["test3lstm-h"], h0)) {
        cerr << endl << "h0 got changed by forward!" << endl << endl;
    }
    //cppl_update(&states,"test3lstm-h",new MatrixN(h0));
    //cppl_update(&states,"test3lstm-c",new MatrixN(c0));
    t_cppl cp2;
    cppl_set(&cp2,"test3lstm-h",new MatrixN(dhnext));
    cppl_set(&cp2,"test3lstm-c",new MatrixN(dcnext));
    MatrixN dx0=lstm.backward_step(cp2, &cache, &states, &grads);
    cppl_delete(&cp2);
    bool allOk=true;
    bool ret=matComp(dx,dx0,"LSTMStepBackward dx",eps);
    if (!ret) allOk=false;
    ret=matComp(dWxh,*(grads["Wxh"]),"LSTMStepBackward dWxh",eps);
    if (!ret) allOk=false;
    ret=matComp(dWhh,*(grads["Whh"]),"LSTMStepBackward dWhh",eps);
    if (!ret) allOk=false;
    ret=matComp(dbh,*(grads["bh"]),"LSTMStepBackward bh",eps);
    if (!ret) allOk=false;
    ret=matComp(dh0,*(grads["test3lstm-h0"]),"LSTMStepBackward h0",eps);
    if (!ret) allOk=false;
    ret=matComp(dc0,*(grads["test3lstm-c0"]),"LSTMStepBackward c0",eps);
    if (!ret) allOk=false;
    cppl_delete(&cache);
    cppl_delete(&grads);
    cppl_delete(&states);
    return allOk;
}

bool checkLSTMForward(floatN eps=CP_DEFAULT_NUM_EPS) {
    MatrixN x(2,15);   // N, D, H, T = 2, 5, 4, 3
    x << -0.4       , -0.36551724, -0.33103448, -0.29655172, -0.26206897,
         -0.22758621, -0.19310345, -0.15862069, -0.12413793, -0.08965517,
         -0.05517241, -0.02068966,  0.0137931 ,  0.04827586,  0.08275862,

          0.11724138,  0.15172414,  0.1862069 ,  0.22068966,  0.25517241,
          0.28965517,  0.32413793,  0.35862069,  0.39310345,  0.42758621,
          0.46206897,  0.49655172,  0.53103448,  0.56551724,  0.6;
    MatrixN Wxh(5,4*4);
    MatrixN Whh(4,4*4);
    Wxh << -0.2       , -0.18607595, -0.1721519 , -0.15822785, -0.1443038 ,
        -0.13037975, -0.1164557 , -0.10253165, -0.08860759, -0.07468354,
        -0.06075949, -0.04683544, -0.03291139, -0.01898734, -0.00506329,
         0.00886076,
         0.02278481,  0.03670886,  0.05063291,  0.06455696,  0.07848101,
         0.09240506,  0.10632911,  0.12025316,  0.13417722,  0.14810127,
         0.16202532,  0.17594937,  0.18987342,  0.20379747,  0.21772152,
         0.23164557,
         0.24556962,  0.25949367,  0.27341772,  0.28734177,  0.30126582,
         0.31518987,  0.32911392,  0.34303797,  0.35696203,  0.37088608,
         0.38481013,  0.39873418,  0.41265823,  0.42658228,  0.44050633,
         0.45443038,
         0.46835443,  0.48227848,  0.49620253,  0.51012658,  0.52405063,
         0.53797468,  0.55189873,  0.56582278,  0.57974684,  0.59367089,
         0.60759494,  0.62151899,  0.63544304,  0.64936709,  0.66329114,
         0.67721519,
         0.69113924,  0.70506329,  0.71898734,  0.73291139,  0.74683544,
         0.76075949,  0.77468354,  0.78860759,  0.80253165,  0.8164557 ,
         0.83037975,  0.8443038 ,  0.85822785,  0.8721519 ,  0.88607595,
         0.9;
    Whh << -3.00000000e-01,  -2.85714286e-01,  -2.71428571e-01,
         -2.57142857e-01,  -2.42857143e-01,  -2.28571429e-01,
         -2.14285714e-01,  -2.00000000e-01,  -1.85714286e-01,
         -1.71428571e-01,  -1.57142857e-01,  -1.42857143e-01,
         -1.28571429e-01,  -1.14285714e-01,  -1.00000000e-01,
         -8.57142857e-02,
         -7.14285714e-02,  -5.71428571e-02,  -4.28571429e-02,
         -2.85714286e-02,  -1.42857143e-02,  -5.55111512e-17,
          1.42857143e-02,   2.85714286e-02,   4.28571429e-02,
          5.71428571e-02,   7.14285714e-02,   8.57142857e-02,
          1.00000000e-01,   1.14285714e-01,   1.28571429e-01,
          1.42857143e-01,
          1.57142857e-01,   1.71428571e-01,   1.85714286e-01,
          2.00000000e-01,   2.14285714e-01,   2.28571429e-01,
          2.42857143e-01,   2.57142857e-01,   2.71428571e-01,
          2.85714286e-01,   3.00000000e-01,   3.14285714e-01,
          3.28571429e-01,   3.42857143e-01,   3.57142857e-01,
          3.71428571e-01,
          3.85714286e-01,   4.00000000e-01,   4.14285714e-01,
          4.28571429e-01,   4.42857143e-01,   4.57142857e-01,
          4.71428571e-01,   4.85714286e-01,   5.00000000e-01,
          5.14285714e-01,   5.28571429e-01,   5.42857143e-01,
          5.57142857e-01,   5.71428571e-01,   5.85714286e-01,
          6.00000000e-01;
    MatrixN bh(1,4*4);
    bh << 0.2       ,  0.23333333,  0.26666667,  0.3       ,  0.33333333,
        0.36666667,  0.4       ,  0.43333333,  0.46666667,  0.5       ,
        0.53333333,  0.56666667,  0.6       ,  0.63333333,  0.66666667,
        0.7;
    MatrixN h0(2,4);
    h0 << -0.4       , -0.22857143, -0.05714286,  0.11428571,
         0.28571429,  0.45714286,  0.62857143,  0.8;
    MatrixN hn(2,4*3);
    hn <<0.01764008,  0.01823233,  0.01882671,  0.0194232 ,
    0.11287491,  0.12146228,  0.13018446,  0.13902939,
    0.31358768,  0.33338627,  0.35304453,  0.37250975,
    0.45767879,  0.4761092,   0.4936887,   0.51041945,
    0.6704845,   0.69350089,  0.71486014,  0.7346449 ,
    0.81733511,  0.83677871,  0.85403753,  0.86935314 ;

//                                       D,T
    LSTM lstm("{name='lstm3';inputShape=[5,3];H=4;N=2}");
    *(lstm.params["Wxh"])= Wxh;
    *(lstm.params["Whh"])= Whh;
    *(lstm.params["bh"])=bh;
    //*(lstm.params)["ho"=h0;
    t_cppl cache;
    t_cppl states;
    states["lstm3-h"] = new MatrixN(h0);
    MatrixN hnc=lstm.forward(x, &cache, &states, 0);
    cppl_delete(&cache);
    cppl_delete(&states);
    return matComp(hn,hnc,"LSTMForward",eps);
}

bool checkLSTMBackward(float eps=CP_DEFAULT_NUM_EPS) {
    MatrixN x(2,12);   // N, D, T, H = 2, 3, 4, 5
    x << 0.92746733, -0.9685769 ,  0.91606424,
          1.83326763,  1.25242585,  0.62720743,
         -0.77013281,  2.8263833 , -1.71353491,
          0.37335361, -0.07581999,  0.98046356,

          0.34291929,  0.13352935,  1.68845151,
          1.18465235,  0.05472583,  0.15449182,
          0.71887028, -0.08940256,  0.82805809,
          1.67104987,  1.03945331,  0.8248774;
    MatrixN Wxh(3,4*5);
    Wxh << 0.59755822,  0.0299408 ,  0.48920902,  0.60498022, -0.10987215,
        -1.94573936,  0.41967211,  1.89664636, -0.58956944, -1.3496753 ,
        -1.13954436, -0.30808464,  0.72306575, -0.77982403, -0.26913473,
        -0.79269362,  0.76709561,  0.17036429,  0.04110058,  0.87273386,
        -1.25714068, -0.89067394, -1.60925803, -1.12737276, -2.5928122 ,
        -0.07952464,  0.05288236, -1.19198187, -0.6652034 , -0.16104254,
         0.59965073,  1.02426971,  0.70097063,  2.51076684, -0.52619968,
        -0.88995076, -0.67506911, -0.66030966,  0.58725267, -2.09554763,
        -1.33117678,  1.3933151 ,  0.21714211,  0.03706164, -0.50801274,
        -0.19276109,  0.24422912, -0.08007176,  1.29103385,  0.36013403,
         0.86842806, -0.40344048, -0.29616422,  1.22567213,  0.14893065,
        -0.75912988,  0.07062532,  0.41936527, -1.28152642,  2.72914257;
    MatrixN Whh(5,4*5);
    Whh << -0.08715433,  0.55363889,  0.94085724,  1.41640364, -1.72734896,
        -0.40713378, -0.44689482, -1.12374091, -0.35799068, -0.51774641,
        -1.22854244, -0.16891878, -0.21764398,  0.33792097,  2.06810238,
        -0.92121354, -0.30064101,  0.84646925, -0.05403041,  1.64279322,
         1.20791943, -1.08638391, -0.32363562, -2.16486107, -1.1909638 ,
         0.58276168,  1.24812282,  0.0206619 , -1.77167104,  0.15018242,
        -1.39896929,  0.06241989, -0.59779616,  0.01556503,  0.06985513,
        -2.01306494, -1.23459067, -0.26021549, -0.27712827, -0.84460124,
        -0.83672482, -0.76292684,  0.18757665,  1.7482225 , -1.31778154,
        -0.01252624, -0.15103499,  0.59262437, -0.96449845,  0.80656018,
        -1.05647518,  0.74128281,  1.26984638,  0.68350553, -1.04227352,
         0.90867101,  0.0593835 ,  0.9967439 , -0.34449577, -1.83933964,
         0.79336022,  0.65610549,  0.17280421,  2.1547666 ,  0.37438171,
        -0.44414701, -1.19586475, -0.71069927,  1.06635138,  0.88267652,
         0.14810427,  0.1948591 , -1.18368142,  1.10095093, -0.83953549,
        -0.86434524,  1.09103949,  1.71404559,  1.23152065,  1.03267745,
         0.35218015, -1.00146088,  2.54626021,  1.09273706,  1.24310898,
         2.27393364,  0.02494292,  0.61711553,  0.77909567, -0.39770673,
        -0.39986427, -0.76427658,  1.5477113 , -0.20739811,  0.47683499,
        -0.21235904,  1.02002551,  0.26374406, -0.21529515,  0.08904525;
    MatrixN bh(1,4*5);
    bh <<  1.03943677,  0.25377302, -0.65048676,  0.87468495,  0.4212424 ,
        0.99160751, -1.55430113,  0.90766115,  0.02544352, -0.0780568 ,
        1.71228113,  0.42441258,  1.94126182, -1.86348522,  0.30328873,
        0.1035804 , -0.5968695 , -1.65319436,  0.67191478, -0.93084548;
    MatrixN h0(2,5);
    h0 << 0.41550826,  0.07213302, -0.25127588,  0.34245905, -0.60491616,
         1.41932846,  0.80792543,  0.53469166, -0.13618706,  0.9398239;

    MatrixN dx(2,12);
    dx << 0.41415571, -0.37408703,  0.31807588,
          0.11109561, -0.10150601,  0.04126859,
          0.14975571,  0.05984319, -0.01207687,
         -0.64542964,  1.11388818,  0.07085989,

          0.30569561, -1.28586586,  0.55315075,
         -0.38599717,  0.28788504,  0.00634199,
         -0.08133051, -0.32117411,  0.25992403,
          0.23673009, -1.03328102,  0.57317788;
    MatrixN dWxh(3,4*5);
    dWxh << 0.53008931,  0.30073194, -0.63523656, -0.08529556, -0.07924989,
         0.18158438,  0.15972466,  0.04375776,  0.25308938,  0.04759408,
         0.07447521,  0.25382237, -0.00933806,  0.03414206, -0.11972579,
         0.48798004,  1.30128262,  1.01189969, -1.08332014,  0.09826348,
         0.77104579,  0.1641908 , -0.12496729, -0.10370338,  0.09920548,
         0.1804722 ,  0.24611358, -0.01576978,  0.1094831 ,  0.02696013,
         0.11533865,  0.20653169,  0.01668227,  0.02084823,  0.15219943,
        -0.53380785,  0.44507004, -0.22822415, -0.36065685,  0.06923925,
         0.12088354,  0.11912781, -0.20646291, -0.02236594, -0.14199993,
         0.16511938, -0.02414782,  0.02530796,  0.11974555,  0.02707917,
         0.17313398, -0.00452225, -0.03961192, -0.119877  , -0.16996628,
         0.24515331,  0.4374248 ,  2.9835509 , -0.57208698,  0.01959454;
    MatrixN dWhh(5,4*5);
    dWhh << -1.36608713e-01,  -7.03833929e-02,   3.62359351e-01,
          1.29285131e-02,  -6.39563939e-02,  -1.46655326e-01,
         -6.06024803e-02,   3.18520926e-04,  -3.56219057e-02,
         -7.89711054e-03,   1.02672459e-01,  -1.42714360e-01,
          5.12639479e-02,  -1.53326294e-01,  -1.55312879e-02,
          2.79359403e-01,   3.29684606e-01,   2.28708091e+00,
          1.37456554e-01,   5.46674288e-04,
          8.84242363e-02,   3.67634634e-03,   5.48848176e-02,
         -1.13212745e-02,  -2.10105954e-02,   1.91432387e-02,
          1.39935363e-02,  -4.37875419e-03,  -7.98785884e-03,
         -7.00134980e-04,   8.59179146e-02,  -3.45966734e-02,
          6.06891993e-03,  -7.94288327e-02,  -2.70669345e-03,
         -1.13723783e-01,   4.12796432e-02,   1.25630173e+00,
          4.46535185e-02,  -1.20158983e-03,
         -6.73780896e-02,  -1.24298989e-02,  -1.89064510e-01,
          1.34891539e-02,  -1.06064701e-02,  -3.19175434e-02,
         -4.13976569e-04,   7.69553360e-03,  -7.78467527e-03,
         -4.27957155e-03,   2.24163570e-02,  -2.14340682e-02,
          3.36858697e-03,  -6.31702608e-02,   5.00044474e-03,
          1.89337445e-01,  -2.19690677e-01,   7.22954247e-01,
          1.48521472e-02,  -1.34175163e-02,
         -2.19266556e-02,  -3.63234751e-03,   1.82242583e-01,
          1.24005685e-03,  -1.95635454e-02,   1.63401029e-02,
         -8.40053782e-03,  -1.05595034e-02,  -2.83697239e-02,
         -1.61858705e-03,  -1.99027594e-02,  -1.70990723e-02,
         -4.35754691e-03,   7.39362522e-03,  -2.97972652e-02,
         -1.71337573e-01,   1.13072021e-01,  -7.99774998e-02,
          1.03794093e-01,  -8.34683134e-03,
          1.74570281e-01,   6.14731616e-02,  -5.86874478e-02,
         -2.97957781e-02,   2.75571494e-02,   3.79892309e-02,
          4.93268614e-02,   2.84493209e-03,   2.53105194e-02,
          4.61742772e-03,   9.83647326e-02,   3.61850139e-02,
          1.24589688e-02,  -8.62921510e-02,   7.47740527e-02,
         -1.49861253e-02,   6.04866830e-03,   1.15961382e+00,
         -4.48883423e-02,   1.54771557e-02;
    MatrixN dbh(1,4*5);
    dbh << 0.51606585,  0.15140771, -0.61860268, -0.0508436 , -0.1373822 ,
        0.24455647,  0.15068536,  0.01544773,  0.17093857,  0.03851793,
        0.15539827,  0.09440386, -0.04667299, -0.04668085, -0.19092305,
       -0.03042517,  0.56367312,  2.03229701, -0.85385319,  0.03507221;
    MatrixN dh0(2,5);
    dh0 << 0.22480437, -0.42231929,  0.65306412,  1.20633739,  0.39402085,
         1.18823982, -0.46159436,  1.30113486,  2.52992932,  0.53729332;

    MatrixN dchain(2,20);
    dchain << 0.2575915 , -0.4453817 , -0.17335424, -0.22169436, -0.70351867,
          0.29531944,  1.04410734,  1.30715582, -0.47127793,  0.98669019,
         -0.8754827 , -0.07777912,  0.18567126, -0.37320278, -0.1432791 ,
         -1.05505874, -1.41054684,  1.84231342, -0.26433942, -0.54050279,

         -0.84774194,  0.7933158 ,  0.32789491,  1.04784878, -0.10943742,
          0.58815001,  0.25390165,  1.66226725,  0.20091379, -0.06555748,
          1.21894487,  0.20341521,  0.68888364, -0.38292364, -1.50478578,
         -1.4867672 ,  1.30026383, -0.98036198, -1.380473  ,  1.68487066;
//                                       D,T
    LSTM lstm("{name='lstm4';inputShape=[3,4];H=5;N=2}");   //inputShape=D, hidden=H
    *(lstm.params["Wxh"])=Wxh;
    *(lstm.params["Whh"])=Whh;
    *(lstm.params["bh"])=bh;

    t_cppl cache;
    t_cppl states;
    t_cppl grads;
    states["lstm4-h"] = new MatrixN(h0);
    MatrixN y=lstm.forward(x, &cache, &states);
    cppl_update(&states, "lstm4-h", &h0);
    MatrixN dx0=lstm.backward(dchain, &cache, &states, &grads);
    bool allOk=true;
    bool ret=matComp(dx,dx0,"LSTMBackward dx",eps);
    if (!ret) allOk=false;
    ret=matComp(dWxh,*(grads["Wxh"]),"LSTMBackward dWxh",eps);
    if (!ret) allOk=false;
    ret=matComp(dWhh,*(grads["Whh"]),"LSTMBackward dWhh",eps);
    if (!ret) allOk=false;
    ret=matComp(dbh,*(grads["bh"]),"LSTMBackward bh",eps);
    if (!ret) allOk=false;
    ret=matComp(dh0,*(grads["lstm4-h0"]),"LSTMBackward h0",eps); // XXX: Uhhh!
    if (!ret) allOk=false;

    cppl_delete(&cache);
    cppl_delete(&grads);
    cppl_delete(&states);
    return allOk;
}

#endif
