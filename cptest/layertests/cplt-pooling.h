#ifndef _CPLT_POOLING_H
#define _CPLT_POOLING_H

#include "../testneural.h"

bool checkPoolingForward(floatN eps=CP_DEFAULT_NUM_EPS) {
    t_cppl states;
    MatrixN x(2,3*4*4); // 2x3x4x4 NxCxHxW
    x << -0.3       , -0.29263158, -0.28526316, -0.27789474,
          -0.27052632, -0.26315789, -0.25578947, -0.24842105,
          -0.24105263, -0.23368421, -0.22631579, -0.21894737,
          -0.21157895, -0.20421053, -0.19684211, -0.18947368,

          -0.18210526, -0.17473684, -0.16736842, -0.16      ,
          -0.15263158, -0.14526316, -0.13789474, -0.13052632,
          -0.12315789, -0.11578947, -0.10842105, -0.10105263,
          -0.09368421, -0.08631579, -0.07894737, -0.07157895,

          -0.06421053, -0.05684211, -0.04947368, -0.04210526,
          -0.03473684, -0.02736842, -0.02      , -0.01263158,
          -0.00526316,  0.00210526,  0.00947368,  0.01684211,
           0.02421053,  0.03157895,  0.03894737,  0.04631579,


           0.05368421,  0.06105263,  0.06842105,  0.07578947,
           0.08315789,  0.09052632,  0.09789474,  0.10526316,
           0.11263158,  0.12      ,  0.12736842,  0.13473684,
           0.14210526,  0.14947368,  0.15684211,  0.16421053,

           0.17157895,  0.17894737,  0.18631579,  0.19368421,
           0.20105263,  0.20842105,  0.21578947,  0.22315789,
           0.23052632,  0.23789474,  0.24526316,  0.25263158,
           0.26      ,  0.26736842,  0.27473684,  0.28210526,

           0.28947368,  0.29684211,  0.30421053,  0.31157895,
           0.31894737,  0.32631579,  0.33368421,  0.34105263,
           0.34842105,  0.35578947,  0.36315789,  0.37052632,
           0.37789474,  0.38526316,  0.39263158,  0.4;
    MatrixN y(2,12);
    y << -0.26315789, -0.24842105,
         -0.20421053, -0.18947368,
         -0.14526316, -0.13052632,
         -0.08631579, -0.07157895,
         -0.02736842, -0.01263158,
          0.03157895,  0.04631579,
          0.09052632,  0.10526316,
          0.14947368,  0.16421053,
          0.20842105,  0.22315789,
          0.26736842,  0.28210526,
          0.32631579,  0.34105263,
          0.38526316,  0.4;
         // inputShape: C, H, W; kernel: F, HH=stride, WW=stride
    Pooling pl("{inputShape=[3,4,4];stride=2}");
    MatrixN y0=pl.forward(x, nullptr, &states);

    return matComp(y,y0,"PoolingForward",eps);
}

bool checkPoolingBackward(float eps=CP_DEFAULT_NUM_EPS) {
    t_cppl states;
    MatrixN x(3, 2*8*8);
    x << -0.20821944,  0.76470027, -0.42823441,  0.23081636, -0.7821132 ,
          -0.19361657, -0.25946762, -1.01735498,
          -1.21951272,  0.49819365, -0.44809611,  0.92079144, -0.56857596,
          -0.27794466, -1.88411009,  1.90659228,
          -0.47273599, -0.94183724, -1.15399693,  0.44185057,  1.3521356 ,
           0.038481  , -0.84776888,  0.05535332,
          -0.12486817,  0.48866677, -0.24764457,  0.05246682,  1.96750726,
           0.48715605,  0.17504119,  0.82134656,
          -0.42960705,  1.77148609,  0.16379425, -0.29082004,  0.52326352,
           1.47661533, -0.19514707,  1.57767945,
          -0.07487967, -1.51977691, -0.59051645, -0.22851541,  1.59730828,
          -1.04449441,  1.48661379,  0.86497631,
           0.65681371,  0.50023527, -1.68840264,  0.72449393,  0.06154832,
          -0.82007799, -0.02014138, -0.86370724,
           1.58534327,  1.14112418, -0.48090446, -0.042038  ,  0.50606844,
          -0.10656982, -0.03190944, -1.07508596,

          -0.35814308,  0.45472176, -0.23336728,  0.90551898, -0.99163112,
           0.35008976, -0.25482636,  0.19915775,
          -0.77842405, -0.82473092, -0.51410154, -0.08928771, -0.41909776,
          -1.95161101,  1.10078008,  0.11088705,
          -0.24577978,  1.09930858,  0.05714487,  1.36417158,  0.02176026,
          -1.95798167, -0.26250676, -1.19025748,
           1.09570083, -0.06226364,  0.80339967, -0.0758211 , -0.18690804,
           1.49729031, -0.82952823,  0.33878078,
           1.46551033, -1.02128691, -0.91337491,  1.23652237, -0.09419522,
          -0.17977637,  0.75537251, -0.14552913,
           0.61578288, -1.20124727, -1.85926884,  1.3757701 , -1.02581886,
           1.303463  ,  0.73080734, -1.20004489,
           0.21973867,  0.29373124,  1.99159088, -1.11957381,  0.2658984 ,
           0.26915953,  0.27556056,  0.49136136,
           0.3612057 ,  0.07358504,  0.73521503,  1.07389274,  0.60949853,
          -0.38312498,  0.89033768,  0.91623125,


          -1.76705153, -1.73491261,  0.21020303,  0.38171743, -0.48405564,
          -1.57386388,  0.87403613,  0.54136034,
           1.53814942,  0.74653043,  0.97793464,  0.05471139, -1.4336575 ,
          -0.24236267, -1.05111491, -0.94523348,
          -0.75268226,  0.0816029 , -0.05990043,  0.11669214,  0.08999444,
           0.82241626,  0.712311  ,  0.16681093,
           1.56757749,  0.84085497, -1.03778945,  0.18714578,  0.6166835 ,
           0.06464151,  1.77329425,  0.53635759,
           1.59541903, -0.10955936,  0.09776589, -0.43620696, -0.88174536,
          -0.13463976,  1.32932224, -1.5940335 ,
          -0.57096876,  0.48208184, -0.60498125,  0.4741654 ,  0.18197066,
          -1.23380724, -1.23998288, -0.50275103,
           3.49827418,  1.15780691,  0.14641761, -0.17350691, -0.18374094,
           0.3106503 ,  0.05314125,  0.87079586,
          -0.90732427, -1.20416999,  1.68494269, -2.22035246, -0.50020293,
          -0.07189888,  0.46373325, -0.05885692,

          -0.18307148,  0.17351858,  0.36120907, -0.47482548, -0.2414964 ,
           0.23315281, -1.09976171,  0.03012353,
          -1.20211889,  1.0827036 , -0.97788039, -0.67809763,  0.51644967,
          -0.27490245,  0.0478945 , -1.49470066,
          -0.036517  ,  0.33607844,  0.02106272,  0.34517926, -0.44099748,
          -1.37764821, -0.4377515 ,  2.2515369 ,
          -0.37733989, -0.36166212, -2.13904   , -0.66325432,  0.52422798,
           3.51735895, -0.09820525,  0.1784247 ,
           0.25951956,  0.94219836, -0.57460869, -0.54582794, -1.61570535,
          -0.18259026, -0.17537327,  0.81053405,
           1.72576168, -0.22244469, -0.58099542,  0.01594571,  0.55960778,
           0.37940704,  0.31612082, -0.49076277,
          -0.05711323,  1.97590329,  0.24268064, -1.02724374,  1.63612621,
          -0.43711261, -1.0679252 ,  0.17733876,
           0.08950617, -1.33003954, -1.51386604,  0.24203421,  1.57305846,
          -0.83314106,  0.38760212,  2.10037992,


           0.97310772, -0.70923623,  0.32140762, -2.75490947, -0.06021106,
          -0.11980104,  0.78990898, -0.94220543,
           1.94565408,  1.26863143,  0.9039833 , -0.19637166,  0.01524785,
           0.79755599, -1.10231533,  0.45860753,
           0.82711965, -0.45613535, -0.78245238, -0.04901804, -1.6139697 ,
          -1.99214353,  0.00877878, -0.22394173,
           1.14287009, -0.4194935 ,  0.97040715, -0.30421962,  0.78563701,
           1.04483927, -0.4125141 ,  0.1052007 ,
          -0.8521989 ,  0.6826181 ,  1.1029444 , -0.32969948, -0.06845776,
          -1.0790365 , -0.43846153, -0.15257518,
          -0.53943044,  0.58558499,  0.60449336, -0.34634213, -0.60843111,
          -1.58272669,  1.2009205 ,  0.42710111,
           1.38534904, -1.41947659, -1.16212324, -0.32895225,  0.55225572,
           1.28587717, -0.61798035,  1.07671263,
          -0.10431983, -0.0582642 ,  0.17034094, -1.39658426, -0.43604526,
          -1.84565462,  1.74213715, -0.53842971,

           0.27123878,  1.11081723,  0.67191105,  0.63904708, -1.23442157,
          -0.33489185,  1.05717369,  0.62583597,
          -0.17689927, -0.31854626,  0.22574472,  0.63169287, -2.71288479,
           1.99653206,  0.21683901,  0.74752754,
           0.12947894,  1.5077572 , -0.46006936,  1.53470713,  0.37041118,
           0.63741785, -2.37744153,  0.28781378,
          -0.2151778 , -0.09469675, -0.85938255, -2.23271977, -0.33938592,
          -1.50763285, -0.42199155,  1.18545128,
          -1.47395027,  0.05590323, -0.20287167, -1.29859336, -0.06927397,
           0.7785629 , -0.32867654,  0.75829549,
           1.19794092, -0.71202494,  0.85842106, -0.30092262,  1.17083144,
           0.24035558, -1.07172363, -0.07449393,
           0.32310846,  0.06665681, -0.88290151,  0.42169145,  0.49928071,
          -0.25150176,  0.38966503,  2.17860381,
          -1.24330528,  0.00585855, -1.17676122,  0.1536678 , -0.67161206,
           1.3949744 ,  0.30369064, -1.02368514;
    MatrixN dchain(3,2*4*4);
    dchain << 1.29374452, -0.31671873,  0.84842249, -1.4721032 ,
          -0.34921717, -1.9646576 ,  0.68748776,  1.71009631,
          -1.06116246,  0.07276335,  1.75090416,  1.21168054,
          -0.39189565,  1.30593839,  0.93956115,  0.25105781,

          -0.4560326 ,  0.97480044, -1.3597251 , -0.23181517,
           0.12403004,  0.83317537, -1.52263223,  0.15419263,
          -1.19366621, -0.95997357,  0.30999145,  1.33168829,
           0.19031117, -0.36261005,  0.46397314, -2.38480408,


          -0.58552865, -0.13871152, -0.65902429,  1.80143258,
           0.64211802, -0.01029485, -1.79380576,  0.75943923,
          -0.41885403,  0.26041765, -0.4883311 ,  0.10832315,
           0.07752951,  1.37929608,  1.15592811, -0.85945464,

          -0.51382159, -0.92172661, -1.42632614,  0.82134494,
           0.88597893, -0.33538864, -0.08146537,  1.0791449 ,
           0.1157789 , -0.06358474,  1.6672031 , -0.06467902,
          -1.23959368, -1.18716685, -0.67859249,  1.43853299,


          -0.83655323,  1.18295151, -1.62708353, -1.41749206,
           0.02751224,  0.52466305, -0.43795283, -1.44280928,
          -1.4918993 ,  0.876771  , -0.51261532,  0.69193701,
          -0.41820108,  0.84120434,  0.29369576, -0.06614878,

           0.72712383, -1.11525569, -0.13372329,  0.53674014,
          -0.38395277,  0.89723775,  0.20742629, -0.94646943,
           0.67617896,  0.52110043, -1.38125575, -0.51175397,
           1.41848186, -0.05441891, -0.62679592,  1.40399454;
    MatrixN dx(3, 2*8*8);
    dx << 0.        ,  1.29374452,  0.        ,  0.        ,  0.        ,
           0.84842249,  0.        ,  0.        ,
           0.        ,  0.        ,  0.        , -0.31671873,  0.        ,
           0.        ,  0.        , -1.4721032 ,
           0.        ,  0.        ,  0.        , -1.9646576 ,  0.        ,
           0.        ,  0.        ,  0.        ,
           0.        , -0.34921717,  0.        ,  0.        ,  0.68748776,
           0.        ,  0.        ,  1.71009631,
           0.        , -1.06116246,  0.07276335,  0.        ,  0.        ,
           0.        ,  0.        ,  1.21168054,
           0.        ,  0.        ,  0.        ,  0.        ,  1.75090416,
           0.        ,  0.        ,  0.        ,
           0.        ,  0.        ,  0.        ,  1.30593839,  0.        ,
           0.        ,  0.25105781,  0.        ,
          -0.39189565,  0.        ,  0.        ,  0.        ,  0.93956115,
           0.        ,  0.        ,  0.        ,

           0.        , -0.4560326 ,  0.        ,  0.97480044,  0.        ,
          -1.3597251 ,  0.        ,  0.        ,
           0.        ,  0.        ,  0.        ,  0.        ,  0.        ,
           0.        , -0.23181517,  0.        ,
           0.        ,  0.12403004,  0.        ,  0.83317537,  0.        ,
           0.        ,  0.        ,  0.        ,
           0.        ,  0.        ,  0.        ,  0.        ,  0.        ,
          -1.52263223,  0.        ,  0.15419263,
          -1.19366621,  0.        ,  0.        ,  0.        ,  0.        ,
           0.        ,  1.33168829,  0.        ,
           0.        ,  0.        ,  0.        , -0.95997357,  0.        ,
           0.30999145,  0.        ,  0.        ,
           0.        ,  0.        , -0.36261005,  0.        ,  0.        ,
           0.        ,  0.        ,  0.        ,
           0.19031117,  0.        ,  0.        ,  0.        ,  0.46397314,
           0.        ,  0.        , -2.38480408,


           0.        ,  0.        ,  0.        ,  0.        ,  0.        ,
           0.        ,  1.80143258,  0.        ,
          -0.58552865,  0.        , -0.13871152,  0.        ,  0.        ,
          -0.65902429,  0.        ,  0.        ,
           0.        ,  0.        ,  0.        ,  0.        ,  0.        ,
          -1.79380576,  0.        ,  0.        ,
           0.64211802,  0.        ,  0.        , -0.01029485,  0.        ,
           0.        ,  0.75943923,  0.        ,
          -0.41885403,  0.        ,  0.        ,  0.        ,  0.        ,
           0.        ,  0.10832315,  0.        ,
           0.        ,  0.        ,  0.        ,  0.26041765, -0.4883311 ,
           0.        ,  0.        ,  0.        ,
           0.07752951,  0.        ,  0.        ,  0.        ,  0.        ,
           1.15592811,  0.        , -0.85945464,
           0.        ,  0.        ,  1.37929608,  0.        ,  0.        ,
           0.        ,  0.        ,  0.        ,

           0.        ,  0.        , -0.92172661,  0.        ,  0.        ,
           0.        ,  0.        ,  0.        ,
           0.        , -0.51382159,  0.        ,  0.        , -1.42632614,
           0.        ,  0.82134494,  0.        ,
           0.        ,  0.88597893,  0.        , -0.33538864,  0.        ,
           0.        ,  0.        ,  1.0791449 ,
           0.        ,  0.        ,  0.        ,  0.        ,  0.        ,
          -0.08146537,  0.        ,  0.        ,
           0.        ,  0.        ,  0.        ,  0.        ,  0.        ,
           0.        ,  0.        , -0.06467902,
           0.1157789 ,  0.        ,  0.        , -0.06358474,  1.6672031 ,
           0.        ,  0.        ,  0.        ,
           0.        , -1.23959368, -1.18716685,  0.        , -0.67859249,
           0.        ,  0.        ,  0.        ,
           0.        ,  0.        ,  0.        ,  0.        ,  0.        ,
           0.        ,  0.        ,  1.43853299,


           0.        ,  0.        ,  0.        ,  0.        ,  0.        ,
           0.        , -1.41749206,  0.        ,
          -0.83655323,  0.        ,  1.18295151,  0.        ,  0.        ,
          -1.62708353,  0.        ,  0.        ,
           0.        ,  0.        ,  0.        ,  0.        ,  0.        ,
           0.        ,  0.        ,  0.        ,
           0.02751224,  0.        ,  0.52466305,  0.        ,  0.        ,
          -0.43795283,  0.        , -1.44280928,
           0.        , -1.4918993 ,  0.876771  ,  0.        , -0.51261532,
           0.        ,  0.        ,  0.        ,
           0.        ,  0.        ,  0.        ,  0.        ,  0.        ,
           0.        ,  0.69193701,  0.        ,
          -0.41820108,  0.        ,  0.        ,  0.        ,  0.        ,
           0.29369576,  0.        ,  0.        ,
           0.        ,  0.        ,  0.84120434,  0.        ,  0.        ,
           0.        , -0.06614878,  0.        ,

           0.        ,  0.72712383, -1.11525569,  0.        ,  0.        ,
           0.        ,  0.53674014,  0.        ,
           0.        ,  0.        ,  0.        ,  0.        ,  0.        ,
          -0.13372329,  0.        ,  0.        ,
           0.        , -0.38395277,  0.        ,  0.89723775,  0.        ,
           0.20742629,  0.        ,  0.        ,
           0.        ,  0.        ,  0.        ,  0.        ,  0.        ,
           0.        ,  0.        , -0.94646943,
           0.        ,  0.        ,  0.        ,  0.        ,  0.        ,
           0.        ,  0.        , -0.51175397,
           0.67617896,  0.        ,  0.52110043,  0.        , -1.38125575,
           0.        ,  0.        ,  0.        ,
           1.41848186,  0.        ,  0.        , -0.05441891,  0.        ,
           0.        ,  0.        ,  1.40399454,
           0.        ,  0.        ,  0.        ,  0.        ,  0.        ,
          -0.62679592,  0.        ,  0.;
    Pooling pl("{inputShape=[2,8,8];stride=2}");
    t_cppl cache;
    t_cppl grads;
    MatrixN y=pl.forward(x, &cache, &states);
    MatrixN dx0=pl.backward(dchain, &cache, &states, &grads);
    bool allOk=true;
    bool ret=matComp(dx,dx0,"PoolingBackward dx",eps);
    if (!ret) allOk=false;
    cppl_delete(&cache);
    cppl_delete(&grads);
    return allOk;
}

#endif
