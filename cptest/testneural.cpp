#include <cp-neural.h>

// Manual build:
// g++ -g -ggdb -I ../cpneural -I /usr/local/include/eigen3 testneural.cpp -L ../Build/cpneural/ -lcpneural -lpthread -o test

using std::cerr; using std::endl;

bool matComp(MatrixN& m0, MatrixN& m1, string msg="", floatN eps=1.e-6) {
    if (m0.cols() != m1.cols() || m0.rows() != m1.rows()) {
        cerr << msg << ": Incompatible shapes " << shape(m0) << "!=" << shape(m1) << endl;
        return false;
    }
    MatrixN d = m0 - m1;
    floatN dif = d.cwiseProduct(d).sum();
    if (dif < eps) {
        cerr << msg << " err=" << dif << endl;
        return true;
    } else {
        IOFormat CleanFmt(4, 0, ", ", "\n", "[", "]");
        cerr << msg << " m0:" << endl << m0.format(CleanFmt) << endl;
        cerr << msg << " m1:" << endl << m1.format(CleanFmt) << endl;
        cerr << msg << "  âˆ‚:" << endl << (m0-m1).format(CleanFmt) << endl;
        cerr << "err=" << dif << endl;
        return false;
    }
}

/*MatrixN linspace(MatrixN m0, floatN a, floatN b) {
    int n=m0.size();
    MatrixN y(m0);
    for (auto i=0; i<=y.size(); i++) { // Strang, but numpy compatible
        y(i)=(floatN)(i)/(floatN)(n) * (b-a)+a;
    }
    return y;
}
*/
bool checkAffineForward(floatN eps=CP_DEFAULT_NUM_EPS) {
    MatrixN x(2,4);
    x << -0.1       , -0.01428571,  0.07142857,  0.15714286,
          0.24285714,  0.32857143,  0.41428571,  0.5;
    MatrixN W(4,3);
    W << -0.2       , -0.15454545, -0.10909091,
         -0.06363636, -0.01818182,  0.02727273,
          0.07272727,  0.11818182,  0.16363636,
          0.20909091,  0.25454545,  0.3;
    MatrixN b(1,3);
    b << -0.3, -0.1,  0.1;
    MatrixN y(2,3);
    y << -0.24103896, -0.03584416,  0.16935065,
         -0.23480519,  0.03272727,  0.30025974;

     //Affine pe(CpParams("{inputShape=[4,3]}"));
     Affine pe("{inputShape=[4];hidden=3}");
    *(pe.params["W"])= W;
    *(pe.params["b"])=b;
    MatrixN y0=pe.forward(x, nullptr);
    return matComp(y,y0,"AffineForward",eps);
}

bool checkAffineBackward(float eps=CP_DEFAULT_NUM_EPS) {
    MatrixN x(2,4);
    x << 1.31745392, -0.61371249,  0.45447287, -0.27054087,
         0.10106874,  1.00650622,  0.47243961, -0.42940807;
    MatrixN W(4,5);
    W << -0.33297518, -0.34410449, -0.84123035, -0.04845468, -2.35649863,
          0.50012296,  0.11834242, -0.95766758,  1.03839053,  0.88182165,
         -0.08384473,  0.74101315, -0.6128059 , -0.10586676, -0.70638727,
         -0.69378517,  0.23008973, -0.16988779, -1.66077535,  0.10843451;
    MatrixN b(1,5);
    b <<  1.42152833, -0.50754731,  0.09331398,  0.83707801,  1.39097462;
    MatrixN dx(2,4);
    dx << -2.59324406, -2.10880392, -3.29279846, -2.19694245,
          -3.81171235,  4.25370933, -1.5117824 , -3.21306015;
    MatrixN dW(4,5);
    dW << 1.1393111 , -2.22498409,  3.93887327,  0.77438161,  0.35517399,
         -0.14120118,  0.51706313, -2.45941632,  1.63133349,  1.74156205,
          0.55479794, -0.98325637,  1.09937315,  1.09447527,  0.91454051,
         -0.38504418,  0.65836473, -0.56660463, -0.93167997, -0.8126062;
    MatrixN db(1,5);
    db << 1.20613441, -2.1440201 ,  2.44244227,  2.33348303,  1.9407547;
    MatrixN dchain(2,5);
    dchain << 0.83641977, -1.65103186,  3.03523817,  0.44273757,  0.13073521,
              0.36971463, -0.49298824, -0.5927959 ,  1.89074546,  1.81001949;
    Affine pe("{inputShape=[4];hidden=5}");
    *(pe.params["W"])=W;
    *(pe.params["b"])=b;
    t_cppl cache;
    t_cppl grads;
    MatrixN y=pe.forward(x, &cache);
    MatrixN dx0=pe.backward(dchain, &cache, &grads);
    bool allOk=true;
    bool ret=matComp(dx,dx0,"AffineBackward dx",eps);
    if (!ret) allOk=false;
    ret=matComp(dW,*(grads["W"]),"AffineBackward dW",eps);
    if (!ret) allOk=false;
    ret=matComp(db,*(grads["b"]),"AffineBackward bx",eps);
    if (!ret) allOk=false;
    cppl_delete(&cache);
    cppl_delete(&grads);
    return allOk;
}

bool checkReluForward(floatN eps=CP_DEFAULT_NUM_EPS) {
    MatrixN x(3,4);
    x << -0.5       , -0.40909091, -0.31818182, -0.22727273,
         -0.13636364, -0.04545455,  0.04545455,  0.13636364,
          0.22727273,  0.31818182,  0.40909091,  0.5;

    MatrixN y(3,4);
    y << 0.        ,  0.        ,  0.        ,  0.        ,
         0.        ,  0.        ,  0.04545455,  0.13636364,
         0.22727273,  0.31818182,  0.40909091,  0.5;

    Relu rl(CpParams("{inputShape=[4]}"));
    MatrixN y0=rl.forward(x, nullptr);
    return matComp(y,y0,"ReluForward",eps);
}

bool checkReluBackward(float eps=CP_DEFAULT_NUM_EPS) {
    MatrixN x(4,4);
    x << -0.56204781, -0.30204112,  0.7685022 , -0.74405281,
         -1.46482614, -0.3824993 ,  0.23478267,  0.81716411,
         -0.7702258 ,  0.25433918,  0.33381382,  0.22000994,
          0.43154112, -0.2128072 ,  0.90312084,  1.32935976;
    MatrixN dx(4,4);
    dx << -0.        , -0.        ,  1.23506749,  0.,
          -0.        ,  0.        , -0.68054398,  2.23784401,
          -0.        ,  0.36303492, -0.08854093,  0.63582723,
          -0.07389104, -0.        , -1.18782779, -0.8492151;
    MatrixN dchain(4,4);
    dchain << -0.53996216, -1.18478937,  1.23506749,  0.0695497,
              -1.10965119,  0.24569561, -0.68054398,  2.23784401,
              -0.39696365,  0.36303492, -0.08854093,  0.63582723,
              -0.07389104, -0.38178744, -1.18782779, -0.8492151;
    Relu rl("{inputShape=[4]}");
    t_cppl cache;
    t_cppl grads;
    MatrixN y=rl.forward(x, &cache);
    MatrixN dx0=rl.backward(dchain, &cache, &grads);
    bool allOk=true;
    bool ret=matComp(dx,dx0,"ReluBackward dx",eps);
    if (!ret) allOk=false;
    cppl_delete(&cache);
    cppl_delete(&grads);
    return allOk;
}

bool checkNonlinearityForward(floatN eps=CP_DEFAULT_NUM_EPS) {
    bool allOk=true;
    MatrixN x(3,4);
    x << -0.5       , -0.40909091, -0.31818182, -0.22727273,
         -0.13636364, -0.04545455,  0.04545455,  0.13636364,
          0.22727273,  0.31818182,  0.40909091,  0.5;

    MatrixN y(3,4);
    y << 0.        ,  0.        ,  0.        ,  0.        ,
         0.        ,  0.        ,  0.04545455,  0.13636364,
         0.22727273,  0.31818182,  0.40909091,  0.5;

    Nonlinearity  nlr("{inputShape=[4];type='relu'}");
    MatrixN y0=nlr.forward(x, nullptr);
    if (!matComp(y,y0,"NonlinearityForwardRelu",eps)) allOk=false;

    x << -0.5,        -0.40909091, -0.31818182, -0.22727273,
         -0.13636364, -0.04545455,  0.04545455,  0.13636364,
          0.22727273,  0.31818182,  0.40909091,  0.5;

    y << 0.37754067,  0.39913012,  0.42111892,  0.44342513,
         0.46596182,  0.48863832,  0.51136168,  0.53403818,
         0.55657487,  0.57888108,  0.60086988,  0.62245933;

    Nonlinearity  nlr2("{inputShape=[4];type='sigmoid'}");
    y0=nlr2.forward(x, nullptr);
    if (!matComp(y,y0,"NonlinearityForwardSigmoid",eps)) allOk=false;

    x << -0.5       , -0.40909091, -0.31818182, -0.22727273,
         -0.13636364, -0.04545455,  0.04545455,  0.13636364,
          0.22727273,  0.31818182,  0.40909091,  0.5;

    y << -0.46211716, -0.38770051, -0.30786199, -0.22343882,
         -0.13552465, -0.04542327,  0.04542327,  0.13552465,
          0.22343882,  0.30786199,  0.38770051,  0.46211716;

    Nonlinearity  nlr3(CpParams("{inputShape=[4];type='tanh'}"));
    y0=nlr3.forward(x, nullptr);
    if (!matComp(y,y0,"NonlinearityForwardTanh",eps)) allOk=false;

    return allOk;
}

bool checkNonlinearityBackward(float eps=CP_DEFAULT_NUM_EPS) {
    MatrixN x(4,4);
    x << -0.56204781, -0.30204112,  0.7685022 , -0.74405281,
         -1.46482614, -0.3824993 ,  0.23478267,  0.81716411,
         -0.7702258 ,  0.25433918,  0.33381382,  0.22000994,
          0.43154112, -0.2128072 ,  0.90312084,  1.32935976;
    MatrixN dx(4,4);
    dx << -0.        , -0.        ,  1.23506749,  0.,
          -0.        ,  0.        , -0.68054398,  2.23784401,
          -0.        ,  0.36303492, -0.08854093,  0.63582723,
          -0.07389104, -0.        , -1.18782779, -0.8492151;
    MatrixN dchain(4,4);
    dchain << -0.53996216, -1.18478937,  1.23506749,  0.0695497,
              -1.10965119,  0.24569561, -0.68054398,  2.23784401,
              -0.39696365,  0.36303492, -0.08854093,  0.63582723,
              -0.07389104, -0.38178744, -1.18782779, -0.8492151;
    Nonlinearity nl("{inputShape=[4];type='relu'}");
    t_cppl cache;
    t_cppl grads;
    MatrixN y=nl.forward(x, &cache);
    MatrixN dx0=nl.backward(dchain, &cache, &grads);
    bool allOk=true;
    bool ret=matComp(dx,dx0,"NonlinearityBackward (relu) dx",eps);
    if (!ret) allOk=false;
    cppl_delete(&cache);
    cppl_delete(&grads);

    x << 1.43767491,  1.80314254,  0.6648782 ,  0.07930361,
         -0.04041539,  2.0385067 ,  0.95919656,  0.78136866,
         -0.60190026, -0.59705516,  0.46964069,  2.49260531,
          1.81210733, -0.75791144, -0.05050857,  2.18823795;

    dx << -0.14967124,  0.10171973, -0.04627804,  0.21278199,
          0.18218001, -0.02431661,  0.09598144,  0.33520963,
          0.06603975, -0.09736881, -0.06869742,  0.02529933,
         -0.24602253,  0.18381851,  0.39258962, -0.14610137;

    dchain << -0.96513598,  0.83750624, -0.20633479,  0.85246687,
         0.72901767, -0.23853026,  0.47921611,  1.55612321,
         0.28881523, -0.42522819, -0.29022231,  0.35862906,
        -2.03870191,  0.84601717,  1.57136025, -1.61173135;

    Nonlinearity nl2("{inputShape=[4];type='sigmoid'}");
    y=nl2.forward(x, &cache);
    dx0=nl2.backward(dchain, &cache, &grads);
    ret=matComp(dx,dx0,"NonlinearityBackward (sigmoid) dx",eps);
    if (!ret) allOk=false;
    cppl_delete(&cache);
    cppl_delete(&grads);


    x << 0.62237522, -0.67630521, -0.73180118,  0.09480968,
         -0.38519315,  0.54151353,  0.20554376, -0.83341587,
          0.50075282, -0.298898  , -0.61444481, -1.43827731,
         -0.51080252,  1.01150184,  0.33966994, -0.04912771;

    dx << 1.86839943,  0.98946334, -1.34211481, -1.81021704,
         -0.36344808,  0.362766  , -0.13229278,  0.04144855,
          0.93192044,  1.57711458,  0.37771666, -0.45210137,
         -0.87189663, -0.2880611 , -0.33361629, -0.33249507;

    dchain <<  2.69053302,  1.51538108, -2.19868614, -1.82653767,
         -0.42009465,  0.47995538, -0.13796107,  0.0775524,
          1.18579972,  1.72226031,  0.53919526, -2.23895634,
         -1.11987843, -0.69806274, -0.37361077, -0.3332982;

    Nonlinearity nl3("{inputShape=[4];type='tanh'}");
    y=nl3.forward(x, &cache);
    dx0=nl3.backward(dchain, &cache, &grads);
    ret=matComp(dx,dx0,"NonlinearityBackward (tanh) dx",eps);
    if (!ret) allOk=false;
    cppl_delete(&cache);
    cppl_delete(&grads);

    return allOk;
}


bool checkBatchNormForward(floatN eps=CP_DEFAULT_NUM_EPS) {
    t_cppl cache;
    bool allOk=true;
    MatrixN x(10,3);
    x << -1.76682167,  0.76232051, -1.31336665,
         -1.5949946 ,  0.96014   ,  0.71301837,
          1.64497495,  2.10628039, -0.79136981,
         -0.06795316, -0.47106827,  1.18868314,
          0.92155587, -0.08303236,  0.52682692,
         -3.12821021,  2.16827829, -0.93670303,
         -0.6552201 ,  0.35542666,  0.52397302,
         -3.60689284,  2.35628056,  1.01625476,
          0.38807454, -0.35816073,  0.69088183,
          1.06266819,  1.04606173, -0.53434315;

    MatrixN xn(10,3);
    xn << -0.6369156 , -0.12222813, -1.65495685,
         -0.53619278,  0.07607152,  0.70380848,
          1.36303558,  1.22499387, -1.04733883,
          0.35893921, -1.35861064,  1.25749474,
          0.93897664, -0.96963287,  0.48707675,
         -1.434944  ,  1.28714225, -1.21651051,
          0.01469091, -0.53010961,  0.48375473,
         -1.71554159,  1.47560085,  1.05678359,
          0.62625677, -1.24542905,  0.67804096,
          1.02169486,  0.1622018 , -0.74815305;

    BatchNorm bn("{inputShape=[3];train=true}");
    //bn.setPar("trainMode", true);
    MatrixN xn0=bn.forward(x, &cache);
    MatrixN mean=xn0.colwise().mean();
    cerr << "Mean:" << mean << endl;
    MatrixN xme = xn0.rowwise() - RowVectorN(mean.row(0));
    MatrixN xmsq = ((xme.array() * xme.array()).colwise().sum()/xn0.rows()).array().sqrt();
    cerr << "StdDev:" << xmsq << endl;

    if (!matComp(xn,xn0,"BatchNormForward",eps)) {
        cerr << "BatchNorm forward failed" << endl;
        allOk=false;
    }  else {
        cerr << "  BatchNorm forward ok." << endl;
    }

    MatrixN runmean(1,3);
    runmean << -0.06802819,  0.08842527,  0.01083855;
    MatrixN runvar(1,3);
    runvar << 0.170594  ,  0.09975786,  0.08590872;
    if (!matComp(*(cache["running_mean"]),runmean)) {
        cerr << "BatchNorm running-mean failed" << endl;
        allOk=false;
    } else {
        cerr << "  BatchNorm running mean ok." << endl;
    }
    if (!matComp(*(cache["running_var"]),runvar)) {
        cerr << "BatchNorm running-var failed" << endl;
        allOk=false;
    } else {
        cerr << "  BatchNorm running var ok." << endl;
    }
    cppl_delete(&cache);

    t_cppl cache2;
    MatrixN xn2(10,3);
    xn2 << 10.3630844 ,  11.75554375,   8.03512946,
           10.46380722,  12.15214304,  15.11142543,
           12.36303558,  14.44998773,   9.8579835 ,
           11.35893921,   9.28277872,  16.77248423,
           11.93897664,  10.06073426,  14.46123025,
            9.565056  ,  14.5742845 ,   9.35046847,
           11.01469091,  10.93978079,  14.45126418,
            9.28445841,  14.95120171,  16.17035077,
           11.62625677,   9.5091419 ,  15.03412288,
           12.02169486,  12.3244036 ,  10.75554084;


    BatchNorm bn2("{inputShape=[3];train=true}");
    *(bn2.params["gamma"]) << 1.0, 2.0, 3.0;
    *(bn2.params["beta"]) << 11.0, 12.0, 13.0;
    //bn.setPar("trainMode", true);
    MatrixN xn20=bn2.forward(x, &cache2);
    MatrixN mean2=xn20.colwise().mean();
    cerr << "Mean:" << mean2 << endl;
    MatrixN xme2 = xn20.rowwise() - RowVectorN(mean2.row(0));
    MatrixN xmsq2 = ((xme2.array() * xme2.array()).colwise().sum()/xn20.rows()).array().sqrt();
    cerr << "StdDev:" << xmsq2 << endl;

    if (!matComp(xn2,xn20,"BatchNormForward",eps)) {
        cerr << "BatchNorm with beta/gamma forward failed" << endl;
        allOk=false;
    }  else {
        cerr << "  BatchNorm beta/gamma forward ok." << endl;
    }

    MatrixN runmean2(1,3);
    runmean2 << -0.06802819,  0.08842527,  0.01083855;
    MatrixN runvar2(1,3);
    runvar2 << 0.170594  ,  0.09975786,  0.08590872;
    if (!matComp(*(cache2["running_mean"]),runmean2)) {
        cerr << "BatchNorm running-mean2 failed" << endl;
        allOk=false;
    } else {
        cerr << "  BatchNorm running mean2 ok." << endl;
    }
    if (!matComp(*(cache2["running_var"]),runvar2)) {
        cerr << "BatchNorm running-var2 failed" << endl;
        allOk=false;
    } else {
        cerr << "  BatchNorm running var2 ok." << endl;
    }
    cppl_delete(&cache2);

    t_cppl cache3;
    int nnr=200;
    MatrixN xt(nnr,3);
    BatchNorm bn3("{inputShape=[3];train=true}");
    *(bn3.params["gamma"]) << 1.0, 2.0, 3.0;
    *(bn3.params["beta"]) << 0.0, -1.0, 4.0;
    for (int i=0; i<nnr; i++) {
        xt.setRandom();
        bn3.forward(xt,&cache3);
    }
    cerr << "  Running mean after " << nnr << " cycl: " << *(cache3["running_mean"]) << endl;
    cerr << "  Running stdvar after " << nnr << " cycl: " << *(cache3["running_var"]) << endl;
    cerr << "switching test" << endl;
    bn3.cp.setPar("train", false);
    if (bn3.cp.getPar("train", true)) cerr << "INTERNAL ERROR: parSet boolean failed!" << endl;
    xt.setRandom();
    MatrixN xn30=bn3.forward(xt, &cache3);
    MatrixN mean3=xn30.colwise().mean();
    cerr << "  Mean:" << mean3 << endl;
    if (!matComp(*(bn3.params["beta"]), mean3, "Batchnorm train/test sequence: mean", 0.1)) {
        allOk=0;
    }
    MatrixN xme3 = xn30.rowwise() - RowVectorN(mean3.row(0));
    MatrixN xmsq3 = ((xme3.array() * xme3.array()).colwise().sum()/xn30.rows()).array().sqrt();
    cerr << "  StdDev:" << xmsq3 << endl;
    if (!matComp(*(bn3.params["gamma"]), xmsq3, "Batchnorm train/test sequence: stdderi", 0.1)) {
        allOk=0;
    }
    cppl_delete(&cache3);

    return allOk;
}

bool checkBatchNormBackward(float eps=CP_DEFAULT_NUM_EPS) {
    bool allOk=true;
    MatrixN x(4,5);
    x << 15.70035538,  10.9836183 ,  12.60007796,   8.40461897, 6.73940903,
         18.85269464,  17.58441018,  14.44920968,   7.33474882, 11.35816205,
         17.20864889,   5.43166315,  14.90657023,  13.22667748, 15.03122597,
          4.33556564,   2.44751717,  12.06870335,   5.74243521, 12.16941296;
    MatrixN gamma(1,5);
    gamma << 0.31896744,  1.67004399,  1.57384876, -0.79775794,  0.15197293;
    MatrixN beta(1,5);
    beta << 1.6099422 ,  1.55804396,  0.88364562,  1.21053159,  0.50543461;

    MatrixN dx(4,5);
    dx << -0.04546749,  0.126882  ,  0.4864624 ,  0.18757926,  0.02899233,
          -0.01486729, -0.09133611, -0.26401447, -0.24233534, -0.0726569 ,
           0.05690624,  0.10035256,  0.13037742, -0.01516446,  0.03441372,
           0.00342854, -0.13589844, -0.35282534,  0.06992054,  0.00925085;
    MatrixN dgamma(1,5);
    dgamma << -1.20718803, -1.45268518, -0.05539113, -2.07077292,  0.89780683;
    MatrixN dbeta(1,5);
    dbeta << -4.45908107, -1.23582122,  0.04775023,  3.14325285,  1.0989124;

    MatrixN dchain(4,5);
    dchain << -2.01650781,  0.01176043,  0.39260716,  0.17978038,  0.49731936,
              -1.63610541, -1.15773852, -0.19987901,  1.88290138, -1.14657413,
              -0.26565248,  0.26942709,  0.09496168, -0.00460701,  1.22847938,
              -0.54081537, -0.35927023, -0.23993959,  1.0851781 ,  0.51968779;

    BatchNorm bn("{inputShape=[5];train=true}");
    *(bn.params["gamma"])=gamma;
    *(bn.params["beta"])=beta;

    t_cppl cache;
    t_cppl grads;
    MatrixN y=bn.forward(x, &cache);
    MatrixN dx0=bn.backward(dchain, &cache, &grads);

    bool ret=matComp(dx,dx0,"BatchNormBackward dx",eps);
    if (!ret) allOk=false;
    ret=matComp(dgamma,*grads["gamma"],"BatchNormBackward dgamma",eps);
    if (!ret) allOk=false;
    ret=matComp(dbeta,*grads["beta"],"BatchNormBackward dbeta",eps);
    if (!ret) allOk=false;

    cppl_delete(&cache);
    cppl_delete(&grads);
    return allOk;
}

bool checkDropout(float eps=3.0e-2) {
    bool allOk=true;
    MatrixN x(500,500);
    x.setRandom();
    floatN dl=10.0;
    floatN dop=0.8;
    x.array() += dl;

    Dropout dp("{inputShape=[500];train=true}");
    dp.cp.setPar("drop",dop);
    MatrixN y=dp.forward(x, nullptr);
    dp.cp.setPar("train",false);
    MatrixN yt=dp.forward(x, nullptr);

    floatN xm=x.mean();
    floatN ym=y.mean();
    floatN ytm=yt.mean();

    cerr << "Dropout: x-mean:" << xm << endl;
    cerr << "  y-mean:" << ym << endl;
    cerr << "  yt-mean:" << ytm << endl;
    cerr << "  drop:" << dop << endl;
    cerr << "  offs:" << dl << endl;

    floatN err1=std::abs(ytm-ym);
    if (err1 > eps) {
        allOk=false;
        cerr << "Dropout: difference between test-mean:" << ytm << " and train-mean:" << ym << " too high:" << err1 << endl;
    }
    floatN err2=std::abs(xm-dl);
    if (err2 > eps) {
        allOk=false;
        cerr << "Dropout: difference between x-mean and random-offset too high:"  << err2 << endl;
    }
    floatN err3=std::abs(dl*dop-ym);
    if (err3 > eps) {
        allOk=false;
        cerr << "Dropout: difference between y-mean*offset and droprate too high"  << err3 << endl;
    }
    if (allOk) cerr << "Dropout: statistics tests ok, err1:" << err1 << " err2:" << err2 << " err3:" << err3 << endl;
    return allOk;
}

bool checkConvolutionForwardMin(floatN eps=CP_DEFAULT_NUM_EPS) {
    MatrixN x(2,48); // 2x3x4x4 NxCxHxW
    x << -0.1       , -0.09368421, -0.08736842, -0.08105263,
          -0.07473684, -0.06842105, -0.06210526, -0.05578947,
          -0.04947368, -0.04315789, -0.03684211, -0.03052632,
          -0.02421053, -0.01789474, -0.01157895, -0.00526316,

           0.00105263,  0.00736842,  0.01368421,  0.02      ,
           0.02631579,  0.03263158,  0.03894737,  0.04526316,
           0.05157895,  0.05789474,  0.06421053,  0.07052632,
           0.07684211,  0.08315789,  0.08947368,  0.09578947,

           0.10210526,  0.10842105,  0.11473684,  0.12105263,
           0.12736842,  0.13368421,  0.14      ,  0.14631579,
           0.15263158,  0.15894737,  0.16526316,  0.17157895,
           0.17789474,  0.18421053,  0.19052632,  0.19684211,


           0.20315789,  0.20947368,  0.21578947,  0.22210526,
           0.22842105,  0.23473684,  0.24105263,  0.24736842,
           0.25368421,  0.26      ,  0.26631579,  0.27263158,
           0.27894737,  0.28526316,  0.29157895,  0.29789474,

           0.30421053,  0.31052632,  0.31684211,  0.32315789,
           0.32947368,  0.33578947,  0.34210526,  0.34842105,
           0.35473684,  0.36105263,  0.36736842,  0.37368421,
           0.38      ,  0.38631579,  0.39263158,  0.39894737,

           0.40526316,  0.41157895,  0.41789474,  0.42421053,
           0.43052632,  0.43684211,  0.44315789,  0.44947368,
           0.45578947,  0.46210526,  0.46842105,  0.47473684,
           0.48105263,  0.48736842,  0.49368421,  0.5;

    MatrixN W(3,48); // 3x3x4x4 FxCxHHxWW
    W << -0.2       , -0.1965035 , -0.19300699, -0.18951049,
          -0.18601399, -0.18251748, -0.17902098, -0.17552448,
          -0.17202797, -0.16853147, -0.16503497, -0.16153846,
          -0.15804196, -0.15454545, -0.15104895, -0.14755245,

          -0.14405594, -0.14055944, -0.13706294, -0.13356643,
          -0.13006993, -0.12657343, -0.12307692, -0.11958042,
          -0.11608392, -0.11258741, -0.10909091, -0.10559441,
          -0.1020979 , -0.0986014 , -0.0951049 , -0.09160839,

          -0.08811189, -0.08461538, -0.08111888, -0.07762238,
          -0.07412587, -0.07062937, -0.06713287, -0.06363636,
          -0.06013986, -0.05664336, -0.05314685, -0.04965035,
          -0.04615385, -0.04265734, -0.03916084, -0.03566434,


          -0.03216783, -0.02867133, -0.02517483, -0.02167832,
          -0.01818182, -0.01468531, -0.01118881, -0.00769231,
          -0.0041958 , -0.0006993 ,  0.0027972 ,  0.00629371,
           0.00979021,  0.01328671,  0.01678322,  0.02027972,

           0.02377622,  0.02727273,  0.03076923,  0.03426573,
           0.03776224,  0.04125874,  0.04475524,  0.04825175,
           0.05174825,  0.05524476,  0.05874126,  0.06223776,
           0.06573427,  0.06923077,  0.07272727,  0.07622378,

           0.07972028,  0.08321678,  0.08671329,  0.09020979,
           0.09370629,  0.0972028 ,  0.1006993 ,  0.1041958 ,
           0.10769231,  0.11118881,  0.11468531,  0.11818182,
           0.12167832,  0.12517483,  0.12867133,  0.13216783,


           0.13566434,  0.13916084,  0.14265734,  0.14615385,
           0.14965035,  0.15314685,  0.15664336,  0.16013986,
           0.16363636,  0.16713287,  0.17062937,  0.17412587,
           0.17762238,  0.18111888,  0.18461538,  0.18811189,

           0.19160839,  0.1951049 ,  0.1986014 ,  0.2020979 ,
           0.20559441,  0.20909091,  0.21258741,  0.21608392,
           0.21958042,  0.22307692,  0.22657343,  0.23006993,
           0.23356643,  0.23706294,  0.24055944,  0.24405594,

           0.24755245,  0.25104895,  0.25454545,  0.25804196,
           0.26153846,  0.26503497,  0.26853147,  0.27202797,
           0.27552448,  0.27902098,  0.28251748,  0.28601399,
           0.28951049,  0.29300699,  0.2965035 ,  0.3;

    MatrixN b(3,1);
    b << -0.1 ,  0.05,  0.2;

    MatrixN y(2,12);
    y << -0.08759809, -0.10987781,
        -0.18387192, -0.2109216 ,
         0.21027089,  0.21661097,
         0.22847626,  0.23004637,
         0.50813986,  0.54309974,
         0.64082444,  0.67101435,
        -0.98053589, -1.03143541,
        -1.19128892, -1.24695841,
         0.69108355,  0.66880383,
         0.59480972,  0.56776003,
         2.36270298,  2.36904306,
         2.38090835,  2.38247847;

         // inputShape: C, H, W; kernel: F, HH, WW
    Convolution cv("{inputShape=[3,4,4];kernel=[3,4,4];stride=2;pad=1}");
    *(cv.params["W"])= W;
    *(cv.params["b"])=b;
    MatrixN y0=cv.forward(x, nullptr);

    return matComp(y,y0,"ConvolutionForward",eps);



}

bool checkConvolutionForward(floatN eps=CP_DEFAULT_NUM_EPS) {
    MatrixN x(7,108); // 2x3x4x4 NxCxHxW
    x << -1.00000000e-01,  -9.92052980e-02,  -9.84105960e-02,
           -9.76158940e-02,  -9.68211921e-02,  -9.60264901e-02,
           -9.52317881e-02,  -9.44370861e-02,  -9.36423841e-02,
           -9.28476821e-02,  -9.20529801e-02,  -9.12582781e-02,
           -9.04635762e-02,  -8.96688742e-02,  -8.88741722e-02,
           -8.80794702e-02,  -8.72847682e-02,  -8.64900662e-02,
           -8.56953642e-02,  -8.49006623e-02,  -8.41059603e-02,
           -8.33112583e-02,  -8.25165563e-02,  -8.17218543e-02,
           -8.09271523e-02,  -8.01324503e-02,  -7.93377483e-02,
           -7.85430464e-02,  -7.77483444e-02,  -7.69536424e-02,
           -7.61589404e-02,  -7.53642384e-02,  -7.45695364e-02,
           -7.37748344e-02,  -7.29801325e-02,  -7.21854305e-02,

           -7.13907285e-02,  -7.05960265e-02,  -6.98013245e-02,
           -6.90066225e-02,  -6.82119205e-02,  -6.74172185e-02,
           -6.66225166e-02,  -6.58278146e-02,  -6.50331126e-02,
           -6.42384106e-02,  -6.34437086e-02,  -6.26490066e-02,
           -6.18543046e-02,  -6.10596026e-02,  -6.02649007e-02,
           -5.94701987e-02,  -5.86754967e-02,  -5.78807947e-02,
           -5.70860927e-02,  -5.62913907e-02,  -5.54966887e-02,
           -5.47019868e-02,  -5.39072848e-02,  -5.31125828e-02,
           -5.23178808e-02,  -5.15231788e-02,  -5.07284768e-02,
           -4.99337748e-02,  -4.91390728e-02,  -4.83443709e-02,
           -4.75496689e-02,  -4.67549669e-02,  -4.59602649e-02,
           -4.51655629e-02,  -4.43708609e-02,  -4.35761589e-02,

           -4.27814570e-02,  -4.19867550e-02,  -4.11920530e-02,
           -4.03973510e-02,  -3.96026490e-02,  -3.88079470e-02,
           -3.80132450e-02,  -3.72185430e-02,  -3.64238411e-02,
           -3.56291391e-02,  -3.48344371e-02,  -3.40397351e-02,
           -3.32450331e-02,  -3.24503311e-02,  -3.16556291e-02,
           -3.08609272e-02,  -3.00662252e-02,  -2.92715232e-02,
           -2.84768212e-02,  -2.76821192e-02,  -2.68874172e-02,
           -2.60927152e-02,  -2.52980132e-02,  -2.45033113e-02,
           -2.37086093e-02,  -2.29139073e-02,  -2.21192053e-02,
           -2.13245033e-02,  -2.05298013e-02,  -1.97350993e-02,
           -1.89403974e-02,  -1.81456954e-02,  -1.73509934e-02,
           -1.65562914e-02,  -1.57615894e-02,  -1.49668874e-02,


           -1.41721854e-02,  -1.33774834e-02,  -1.25827815e-02,
           -1.17880795e-02,  -1.09933775e-02,  -1.01986755e-02,
           -9.40397351e-03,  -8.60927152e-03,  -7.81456954e-03,
           -7.01986755e-03,  -6.22516556e-03,  -5.43046358e-03,
           -4.63576159e-03,  -3.84105960e-03,  -3.04635762e-03,
           -2.25165563e-03,  -1.45695364e-03,  -6.62251656e-04,
            1.32450331e-04,   9.27152318e-04,   1.72185430e-03,
            2.51655629e-03,   3.31125828e-03,   4.10596026e-03,
            4.90066225e-03,   5.69536424e-03,   6.49006623e-03,
            7.28476821e-03,   8.07947020e-03,   8.87417219e-03,
            9.66887417e-03,   1.04635762e-02,   1.12582781e-02,
            1.20529801e-02,   1.28476821e-02,   1.36423841e-02,

            1.44370861e-02,   1.52317881e-02,   1.60264901e-02,
            1.68211921e-02,   1.76158940e-02,   1.84105960e-02,
            1.92052980e-02,   2.00000000e-02,   2.07947020e-02,
            2.15894040e-02,   2.23841060e-02,   2.31788079e-02,
            2.39735099e-02,   2.47682119e-02,   2.55629139e-02,
            2.63576159e-02,   2.71523179e-02,   2.79470199e-02,
            2.87417219e-02,   2.95364238e-02,   3.03311258e-02,
            3.11258278e-02,   3.19205298e-02,   3.27152318e-02,
            3.35099338e-02,   3.43046358e-02,   3.50993377e-02,
            3.58940397e-02,   3.66887417e-02,   3.74834437e-02,
            3.82781457e-02,   3.90728477e-02,   3.98675497e-02,
            4.06622517e-02,   4.14569536e-02,   4.22516556e-02,

            4.30463576e-02,   4.38410596e-02,   4.46357616e-02,
            4.54304636e-02,   4.62251656e-02,   4.70198675e-02,
            4.78145695e-02,   4.86092715e-02,   4.94039735e-02,
            5.01986755e-02,   5.09933775e-02,   5.17880795e-02,
            5.25827815e-02,   5.33774834e-02,   5.41721854e-02,
            5.49668874e-02,   5.57615894e-02,   5.65562914e-02,
            5.73509934e-02,   5.81456954e-02,   5.89403974e-02,
            5.97350993e-02,   6.05298013e-02,   6.13245033e-02,
            6.21192053e-02,   6.29139073e-02,   6.37086093e-02,
            6.45033113e-02,   6.52980132e-02,   6.60927152e-02,
            6.68874172e-02,   6.76821192e-02,   6.84768212e-02,
            6.92715232e-02,   7.00662252e-02,   7.08609272e-02,


            7.16556291e-02,   7.24503311e-02,   7.32450331e-02,
            7.40397351e-02,   7.48344371e-02,   7.56291391e-02,
            7.64238411e-02,   7.72185430e-02,   7.80132450e-02,
            7.88079470e-02,   7.96026490e-02,   8.03973510e-02,
            8.11920530e-02,   8.19867550e-02,   8.27814570e-02,
            8.35761589e-02,   8.43708609e-02,   8.51655629e-02,
            8.59602649e-02,   8.67549669e-02,   8.75496689e-02,
            8.83443709e-02,   8.91390728e-02,   8.99337748e-02,
            9.07284768e-02,   9.15231788e-02,   9.23178808e-02,
            9.31125828e-02,   9.39072848e-02,   9.47019868e-02,
            9.54966887e-02,   9.62913907e-02,   9.70860927e-02,
            9.78807947e-02,   9.86754967e-02,   9.94701987e-02,

            1.00264901e-01,   1.01059603e-01,   1.01854305e-01,
            1.02649007e-01,   1.03443709e-01,   1.04238411e-01,
            1.05033113e-01,   1.05827815e-01,   1.06622517e-01,
            1.07417219e-01,   1.08211921e-01,   1.09006623e-01,
            1.09801325e-01,   1.10596026e-01,   1.11390728e-01,
            1.12185430e-01,   1.12980132e-01,   1.13774834e-01,
            1.14569536e-01,   1.15364238e-01,   1.16158940e-01,
            1.16953642e-01,   1.17748344e-01,   1.18543046e-01,
            1.19337748e-01,   1.20132450e-01,   1.20927152e-01,
            1.21721854e-01,   1.22516556e-01,   1.23311258e-01,
            1.24105960e-01,   1.24900662e-01,   1.25695364e-01,
            1.26490066e-01,   1.27284768e-01,   1.28079470e-01,

            1.28874172e-01,   1.29668874e-01,   1.30463576e-01,
            1.31258278e-01,   1.32052980e-01,   1.32847682e-01,
            1.33642384e-01,   1.34437086e-01,   1.35231788e-01,
            1.36026490e-01,   1.36821192e-01,   1.37615894e-01,
            1.38410596e-01,   1.39205298e-01,   1.40000000e-01,
            1.40794702e-01,   1.41589404e-01,   1.42384106e-01,
            1.43178808e-01,   1.43973510e-01,   1.44768212e-01,
            1.45562914e-01,   1.46357616e-01,   1.47152318e-01,
            1.47947020e-01,   1.48741722e-01,   1.49536424e-01,
            1.50331126e-01,   1.51125828e-01,   1.51920530e-01,
            1.52715232e-01,   1.53509934e-01,   1.54304636e-01,
            1.55099338e-01,   1.55894040e-01,   1.56688742e-01,


            1.57483444e-01,   1.58278146e-01,   1.59072848e-01,
            1.59867550e-01,   1.60662252e-01,   1.61456954e-01,
            1.62251656e-01,   1.63046358e-01,   1.63841060e-01,
            1.64635762e-01,   1.65430464e-01,   1.66225166e-01,
            1.67019868e-01,   1.67814570e-01,   1.68609272e-01,
            1.69403974e-01,   1.70198675e-01,   1.70993377e-01,
            1.71788079e-01,   1.72582781e-01,   1.73377483e-01,
            1.74172185e-01,   1.74966887e-01,   1.75761589e-01,
            1.76556291e-01,   1.77350993e-01,   1.78145695e-01,
            1.78940397e-01,   1.79735099e-01,   1.80529801e-01,
            1.81324503e-01,   1.82119205e-01,   1.82913907e-01,
            1.83708609e-01,   1.84503311e-01,   1.85298013e-01,

            1.86092715e-01,   1.86887417e-01,   1.87682119e-01,
            1.88476821e-01,   1.89271523e-01,   1.90066225e-01,
            1.90860927e-01,   1.91655629e-01,   1.92450331e-01,
            1.93245033e-01,   1.94039735e-01,   1.94834437e-01,
            1.95629139e-01,   1.96423841e-01,   1.97218543e-01,
            1.98013245e-01,   1.98807947e-01,   1.99602649e-01,
            2.00397351e-01,   2.01192053e-01,   2.01986755e-01,
            2.02781457e-01,   2.03576159e-01,   2.04370861e-01,
            2.05165563e-01,   2.05960265e-01,   2.06754967e-01,
            2.07549669e-01,   2.08344371e-01,   2.09139073e-01,
            2.09933775e-01,   2.10728477e-01,   2.11523179e-01,
            2.12317881e-01,   2.13112583e-01,   2.13907285e-01,

            2.14701987e-01,   2.15496689e-01,   2.16291391e-01,
            2.17086093e-01,   2.17880795e-01,   2.18675497e-01,
            2.19470199e-01,   2.20264901e-01,   2.21059603e-01,
            2.21854305e-01,   2.22649007e-01,   2.23443709e-01,
            2.24238411e-01,   2.25033113e-01,   2.25827815e-01,
            2.26622517e-01,   2.27417219e-01,   2.28211921e-01,
            2.29006623e-01,   2.29801325e-01,   2.30596026e-01,
            2.31390728e-01,   2.32185430e-01,   2.32980132e-01,
            2.33774834e-01,   2.34569536e-01,   2.35364238e-01,
            2.36158940e-01,   2.36953642e-01,   2.37748344e-01,
            2.38543046e-01,   2.39337748e-01,   2.40132450e-01,
            2.40927152e-01,   2.41721854e-01,   2.42516556e-01,


            2.43311258e-01,   2.44105960e-01,   2.44900662e-01,
            2.45695364e-01,   2.46490066e-01,   2.47284768e-01,
            2.48079470e-01,   2.48874172e-01,   2.49668874e-01,
            2.50463576e-01,   2.51258278e-01,   2.52052980e-01,
            2.52847682e-01,   2.53642384e-01,   2.54437086e-01,
            2.55231788e-01,   2.56026490e-01,   2.56821192e-01,
            2.57615894e-01,   2.58410596e-01,   2.59205298e-01,
            2.60000000e-01,   2.60794702e-01,   2.61589404e-01,
            2.62384106e-01,   2.63178808e-01,   2.63973510e-01,
            2.64768212e-01,   2.65562914e-01,   2.66357616e-01,
            2.67152318e-01,   2.67947020e-01,   2.68741722e-01,
            2.69536424e-01,   2.70331126e-01,   2.71125828e-01,

            2.71920530e-01,   2.72715232e-01,   2.73509934e-01,
            2.74304636e-01,   2.75099338e-01,   2.75894040e-01,
            2.76688742e-01,   2.77483444e-01,   2.78278146e-01,
            2.79072848e-01,   2.79867550e-01,   2.80662252e-01,
            2.81456954e-01,   2.82251656e-01,   2.83046358e-01,
            2.83841060e-01,   2.84635762e-01,   2.85430464e-01,
            2.86225166e-01,   2.87019868e-01,   2.87814570e-01,
            2.88609272e-01,   2.89403974e-01,   2.90198675e-01,
            2.90993377e-01,   2.91788079e-01,   2.92582781e-01,
            2.93377483e-01,   2.94172185e-01,   2.94966887e-01,
            2.95761589e-01,   2.96556291e-01,   2.97350993e-01,
            2.98145695e-01,   2.98940397e-01,   2.99735099e-01,

            3.00529801e-01,   3.01324503e-01,   3.02119205e-01,
            3.02913907e-01,   3.03708609e-01,   3.04503311e-01,
            3.05298013e-01,   3.06092715e-01,   3.06887417e-01,
            3.07682119e-01,   3.08476821e-01,   3.09271523e-01,
            3.10066225e-01,   3.10860927e-01,   3.11655629e-01,
            3.12450331e-01,   3.13245033e-01,   3.14039735e-01,
            3.14834437e-01,   3.15629139e-01,   3.16423841e-01,
            3.17218543e-01,   3.18013245e-01,   3.18807947e-01,
            3.19602649e-01,   3.20397351e-01,   3.21192053e-01,
            3.21986755e-01,   3.22781457e-01,   3.23576159e-01,
            3.24370861e-01,   3.25165563e-01,   3.25960265e-01,
            3.26754967e-01,   3.27549669e-01,   3.28344371e-01,


            3.29139073e-01,   3.29933775e-01,   3.30728477e-01,
            3.31523179e-01,   3.32317881e-01,   3.33112583e-01,
            3.33907285e-01,   3.34701987e-01,   3.35496689e-01,
            3.36291391e-01,   3.37086093e-01,   3.37880795e-01,
            3.38675497e-01,   3.39470199e-01,   3.40264901e-01,
            3.41059603e-01,   3.41854305e-01,   3.42649007e-01,
            3.43443709e-01,   3.44238411e-01,   3.45033113e-01,
            3.45827815e-01,   3.46622517e-01,   3.47417219e-01,
            3.48211921e-01,   3.49006623e-01,   3.49801325e-01,
            3.50596026e-01,   3.51390728e-01,   3.52185430e-01,
            3.52980132e-01,   3.53774834e-01,   3.54569536e-01,
            3.55364238e-01,   3.56158940e-01,   3.56953642e-01,

            3.57748344e-01,   3.58543046e-01,   3.59337748e-01,
            3.60132450e-01,   3.60927152e-01,   3.61721854e-01,
            3.62516556e-01,   3.63311258e-01,   3.64105960e-01,
            3.64900662e-01,   3.65695364e-01,   3.66490066e-01,
            3.67284768e-01,   3.68079470e-01,   3.68874172e-01,
            3.69668874e-01,   3.70463576e-01,   3.71258278e-01,
            3.72052980e-01,   3.72847682e-01,   3.73642384e-01,
            3.74437086e-01,   3.75231788e-01,   3.76026490e-01,
            3.76821192e-01,   3.77615894e-01,   3.78410596e-01,
            3.79205298e-01,   3.80000000e-01,   3.80794702e-01,
            3.81589404e-01,   3.82384106e-01,   3.83178808e-01,
            3.83973510e-01,   3.84768212e-01,   3.85562914e-01,

            3.86357616e-01,   3.87152318e-01,   3.87947020e-01,
            3.88741722e-01,   3.89536424e-01,   3.90331126e-01,
            3.91125828e-01,   3.91920530e-01,   3.92715232e-01,
            3.93509934e-01,   3.94304636e-01,   3.95099338e-01,
            3.95894040e-01,   3.96688742e-01,   3.97483444e-01,
            3.98278146e-01,   3.99072848e-01,   3.99867550e-01,
            4.00662252e-01,   4.01456954e-01,   4.02251656e-01,
            4.03046358e-01,   4.03841060e-01,   4.04635762e-01,
            4.05430464e-01,   4.06225166e-01,   4.07019868e-01,
            4.07814570e-01,   4.08609272e-01,   4.09403974e-01,
            4.10198675e-01,   4.10993377e-01,   4.11788079e-01,
            4.12582781e-01,   4.13377483e-01,   4.14172185e-01,


            4.14966887e-01,   4.15761589e-01,   4.16556291e-01,
            4.17350993e-01,   4.18145695e-01,   4.18940397e-01,
            4.19735099e-01,   4.20529801e-01,   4.21324503e-01,
            4.22119205e-01,   4.22913907e-01,   4.23708609e-01,
            4.24503311e-01,   4.25298013e-01,   4.26092715e-01,
            4.26887417e-01,   4.27682119e-01,   4.28476821e-01,
            4.29271523e-01,   4.30066225e-01,   4.30860927e-01,
            4.31655629e-01,   4.32450331e-01,   4.33245033e-01,
            4.34039735e-01,   4.34834437e-01,   4.35629139e-01,
            4.36423841e-01,   4.37218543e-01,   4.38013245e-01,
            4.38807947e-01,   4.39602649e-01,   4.40397351e-01,
            4.41192053e-01,   4.41986755e-01,   4.42781457e-01,

            4.43576159e-01,   4.44370861e-01,   4.45165563e-01,
            4.45960265e-01,   4.46754967e-01,   4.47549669e-01,
            4.48344371e-01,   4.49139073e-01,   4.49933775e-01,
            4.50728477e-01,   4.51523179e-01,   4.52317881e-01,
            4.53112583e-01,   4.53907285e-01,   4.54701987e-01,
            4.55496689e-01,   4.56291391e-01,   4.57086093e-01,
            4.57880795e-01,   4.58675497e-01,   4.59470199e-01,
            4.60264901e-01,   4.61059603e-01,   4.61854305e-01,
            4.62649007e-01,   4.63443709e-01,   4.64238411e-01,
            4.65033113e-01,   4.65827815e-01,   4.66622517e-01,
            4.67417219e-01,   4.68211921e-01,   4.69006623e-01,
            4.69801325e-01,   4.70596026e-01,   4.71390728e-01,

            4.72185430e-01,   4.72980132e-01,   4.73774834e-01,
            4.74569536e-01,   4.75364238e-01,   4.76158940e-01,
            4.76953642e-01,   4.77748344e-01,   4.78543046e-01,
            4.79337748e-01,   4.80132450e-01,   4.80927152e-01,
            4.81721854e-01,   4.82516556e-01,   4.83311258e-01,
            4.84105960e-01,   4.84900662e-01,   4.85695364e-01,
            4.86490066e-01,   4.87284768e-01,   4.88079470e-01,
            4.88874172e-01,   4.89668874e-01,   4.90463576e-01,
            4.91258278e-01,   4.92052980e-01,   4.92847682e-01,
            4.93642384e-01,   4.94437086e-01,   4.95231788e-01,
            4.96026490e-01,   4.96821192e-01,   4.97615894e-01,
            4.98410596e-01,   4.99205298e-01,   5.00000000e-01;

    MatrixN W(5,48); // 3x3x4x4 FxCxHHxWW
    W << -0.2       , -0.19790795, -0.1958159 , -0.19372385,
          -0.1916318 , -0.18953975, -0.1874477 , -0.18535565,
          -0.1832636 , -0.18117155, -0.1790795 , -0.17698745,
          -0.1748954 , -0.17280335, -0.1707113 , -0.16861925,

          -0.1665272 , -0.16443515, -0.1623431 , -0.16025105,
          -0.158159  , -0.15606695, -0.1539749 , -0.15188285,
          -0.14979079, -0.14769874, -0.14560669, -0.14351464,
          -0.14142259, -0.13933054, -0.13723849, -0.13514644,

          -0.13305439, -0.13096234, -0.12887029, -0.12677824,
          -0.12468619, -0.12259414, -0.12050209, -0.11841004,
          -0.11631799, -0.11422594, -0.11213389, -0.11004184,
          -0.10794979, -0.10585774, -0.10376569, -0.10167364,


          -0.09958159, -0.09748954, -0.09539749, -0.09330544,
          -0.09121339, -0.08912134, -0.08702929, -0.08493724,
          -0.08284519, -0.08075314, -0.07866109, -0.07656904,
          -0.07447699, -0.07238494, -0.07029289, -0.06820084,

          -0.06610879, -0.06401674, -0.06192469, -0.05983264,
          -0.05774059, -0.05564854, -0.05355649, -0.05146444,
          -0.04937238, -0.04728033, -0.04518828, -0.04309623,
          -0.04100418, -0.03891213, -0.03682008, -0.03472803,

          -0.03263598, -0.03054393, -0.02845188, -0.02635983,
          -0.02426778, -0.02217573, -0.02008368, -0.01799163,
          -0.01589958, -0.01380753, -0.01171548, -0.00962343,
          -0.00753138, -0.00543933, -0.00334728, -0.00125523,


           0.00083682,  0.00292887,  0.00502092,  0.00711297,
           0.00920502,  0.01129707,  0.01338912,  0.01548117,
           0.01757322,  0.01966527,  0.02175732,  0.02384937,
           0.02594142,  0.02803347,  0.03012552,  0.03221757,

           0.03430962,  0.03640167,  0.03849372,  0.04058577,
           0.04267782,  0.04476987,  0.04686192,  0.04895397,
           0.05104603,  0.05313808,  0.05523013,  0.05732218,
           0.05941423,  0.06150628,  0.06359833,  0.06569038,

           0.06778243,  0.06987448,  0.07196653,  0.07405858,
           0.07615063,  0.07824268,  0.08033473,  0.08242678,
           0.08451883,  0.08661088,  0.08870293,  0.09079498,
           0.09288703,  0.09497908,  0.09707113,  0.09916318,


           0.10125523,  0.10334728,  0.10543933,  0.10753138,
           0.10962343,  0.11171548,  0.11380753,  0.11589958,
           0.11799163,  0.12008368,  0.12217573,  0.12426778,
           0.12635983,  0.12845188,  0.13054393,  0.13263598,

           0.13472803,  0.13682008,  0.13891213,  0.14100418,
           0.14309623,  0.14518828,  0.14728033,  0.14937238,
           0.15146444,  0.15355649,  0.15564854,  0.15774059,
           0.15983264,  0.16192469,  0.16401674,  0.16610879,

           0.16820084,  0.17029289,  0.17238494,  0.17447699,
           0.17656904,  0.17866109,  0.18075314,  0.18284519,
           0.18493724,  0.18702929,  0.18912134,  0.19121339,
           0.19330544,  0.19539749,  0.19748954,  0.19958159,


           0.20167364,  0.20376569,  0.20585774,  0.20794979,
           0.21004184,  0.21213389,  0.21422594,  0.21631799,
           0.21841004,  0.22050209,  0.22259414,  0.22468619,
           0.22677824,  0.22887029,  0.23096234,  0.23305439,

           0.23514644,  0.23723849,  0.23933054,  0.24142259,
           0.24351464,  0.24560669,  0.24769874,  0.24979079,
           0.25188285,  0.2539749 ,  0.25606695,  0.258159  ,
           0.26025105,  0.2623431 ,  0.26443515,  0.2665272 ,

           0.26861925,  0.2707113 ,  0.27280335,  0.2748954 ,
           0.27698745,  0.2790795 ,  0.28117155,  0.2832636 ,
           0.28535565,  0.2874477 ,  0.28953975,  0.2916318 ,
           0.29372385,  0.2958159 ,  0.29790795,  0.3;

    MatrixN b(5,1);
    b << -0.1  , -0.025,  0.05 ,  0.125,  0.2;

    MatrixN y(7,45);
    y << 1.76779739e-01,   2.65259996e-01,   1.70990551e-01,
            2.41224417e-01,   3.49327828e-01,   2.32607720e-01,
            1.32183990e-01,   2.04901216e-01,   1.25048131e-01,

            7.33009781e-02,   1.06597661e-01,   7.39758098e-02,
            1.04108814e-01,   1.47252819e-01,   1.04110809e-01,
            6.74893458e-02,   9.79510377e-02,   6.68175067e-02,

           -3.01777827e-02,  -5.20646734e-02,  -2.30389315e-02,
           -3.30067888e-02,  -5.48221896e-02,  -2.43861010e-02,
            2.79470199e-03,  -8.99914101e-03,   8.58688243e-03,

           -1.33656544e-01,  -2.10727008e-01,  -1.20053673e-01,
           -1.70122392e-01,  -2.56897199e-01,  -1.52883011e-01,
           -6.18999418e-02,  -1.15949320e-01,  -4.96437419e-02,

           -2.37135304e-01,  -3.69389343e-01,  -2.17068414e-01,
           -3.07237995e-01,  -4.58972208e-01,  -2.81379922e-01,
           -1.26594586e-01,  -2.22899498e-01,  -1.07874366e-01,


           -1.60642079e-01,  -1.87867771e-01,  -1.71279282e-01,
           -2.21599379e-01,  -2.72079914e-01,  -2.36680096e-01,
           -2.24629887e-01,  -2.74082629e-01,  -2.36613760e-01,

           -3.14161379e-02,  -3.62571698e-02,  -3.55893208e-02,
           -4.84420461e-02,  -6.04576741e-02,  -5.49040705e-02,
           -5.66198288e-02,  -7.07598714e-02,  -6.21396825e-02,

            9.78098035e-02,   1.15353432e-01,   1.00100640e-01,
            1.24715287e-01,   1.51164565e-01,   1.26871955e-01,
            1.11390230e-01,   1.32562886e-01,   1.12334396e-01,

            2.27035745e-01,   2.66964033e-01,   2.35790601e-01,
            2.97872620e-01,   3.62786805e-01,   3.08647981e-01,
            2.79400288e-01,   3.35885644e-01,   2.86808473e-01,

            3.56261686e-01,   4.18574635e-01,   3.71480562e-01,
            4.71029954e-01,   5.74409044e-01,   4.90424007e-01,
            4.47410347e-01,   5.39208401e-01,   4.61282551e-01,


           -4.98063898e-01,  -6.40995539e-01,  -5.13549115e-01,
           -6.84423176e-01,  -8.93487656e-01,  -7.05967913e-01,
           -5.81443764e-01,  -7.53066475e-01,  -5.98275652e-01,

           -1.36133254e-01,  -1.79112001e-01,  -1.45154451e-01,
           -2.00992906e-01,  -2.68168168e-01,  -2.13918950e-01,
           -1.80729003e-01,  -2.39470781e-01,  -1.91096872e-01,

            2.25797390e-01,   2.82771537e-01,   2.23240212e-01,
            2.82437363e-01,   3.57151320e-01,   2.78130012e-01,
            2.19985757e-01,   2.74124913e-01,   2.16081909e-01,

            5.87728033e-01,   7.44655075e-01,   5.91634875e-01,
            7.65867633e-01,   9.82470808e-01,   7.70178974e-01,
            6.20700518e-01,   7.87720607e-01,   6.23260689e-01,

            9.49658677e-01,   1.20653861e+00,   9.60029538e-01,
            1.24929790e+00,   1.60779030e+00,   1.26222794e+00,
            1.02141528e+00,   1.30131630e+00,   1.03043947e+00,


           -8.35485716e-01,  -1.09412331e+00,  -8.55818948e-01,
           -1.14724697e+00,  -1.51489540e+00,  -1.17525573e+00,
           -9.38257641e-01,  -1.23205032e+00,  -9.59937543e-01,

           -2.40850370e-01,  -3.21966832e-01,  -2.54719582e-01,
           -3.53543767e-01,  -4.75878661e-01,  -3.72933830e-01,
           -3.04838178e-01,  -4.08181690e-01,  -3.20054061e-01,

            3.53784976e-01,   4.50189642e-01,   3.46379783e-01,
            4.40159439e-01,   5.63138075e-01,   4.29388068e-01,
            3.28581285e-01,   4.15686941e-01,   3.19829422e-01,

            9.48420322e-01,   1.22234612e+00,   9.47479149e-01,
            1.23386265e+00,   1.60215481e+00,   1.23170997e+00,
            9.62000748e-01,   1.23955557e+00,   9.59712904e-01,

            1.54305567e+00,   1.99450259e+00,   1.54857851e+00,
            2.02756585e+00,   2.64117155e+00,   2.03403187e+00,
            1.59542021e+00,   2.06342420e+00,   1.59959639e+00,


           -1.17290753e+00,  -1.54725107e+00,  -1.19808878e+00,
           -1.61007077e+00,  -2.13630314e+00,  -1.64454355e+00,
           -1.29507152e+00,  -1.71103417e+00,  -1.32159943e+00,

           -3.45567486e-01,  -4.64821663e-01,  -3.64284713e-01,
           -5.06094627e-01,  -6.83589155e-01,  -5.31948710e-01,
           -4.28947352e-01,  -5.76892599e-01,  -4.49011250e-01,

            4.81772562e-01,   6.17607748e-01,   4.69519355e-01,
            5.97881515e-01,   7.69124830e-01,   5.80646125e-01,
            4.37176813e-01,   5.57248968e-01,   4.23576935e-01,

            1.30911261e+00,   1.70003716e+00,   1.30332342e+00,
            1.70185766e+00,   2.22183882e+00,   1.69324096e+00,
            1.30330098e+00,   1.69139053e+00,   1.29616512e+00,

            2.13645266e+00,   2.78246657e+00,   2.13712749e+00,
            2.80583380e+00,   3.67455280e+00,   2.80583579e+00,
            2.16942514e+00,   2.82553210e+00,   2.16875330e+00,


           -1.51032935e+00,  -2.00037884e+00,  -1.54035861e+00,
           -2.07289457e+00,  -2.75771088e+00,  -2.11383136e+00,
           -1.65188539e+00,  -2.19001801e+00,  -1.68326133e+00,

           -4.50284602e-01,  -6.07676494e-01,  -4.73849843e-01,
           -6.58645488e-01,  -8.91299648e-01,  -6.90963590e-01,
           -5.53056527e-01,  -7.45603508e-01,  -5.77968439e-01,

            6.09760149e-01,   7.85025853e-01,   5.92658927e-01,
            7.55603591e-01,   9.75111585e-01,   7.31904181e-01,
            5.45772341e-01,   6.98810995e-01,   5.27324448e-01,

            1.66980490e+00,   2.17772820e+00,   1.65916770e+00,
            2.16985267e+00,   2.84152282e+00,   2.15477195e+00,
            1.64460121e+00,   2.14322550e+00,   1.63261733e+00,

            2.72984965e+00,   3.57043055e+00,   2.72567647e+00,
            3.58410175e+00,   4.70793405e+00,   3.57763972e+00,
            2.74343008e+00,   3.58764000e+00,   2.73791022e+00,


           -1.84775117e+00,  -2.45350661e+00,  -1.88262845e+00,
           -2.53571836e+00,  -3.37911862e+00,  -2.58311918e+00,
           -2.00869927e+00,  -2.66900186e+00,  -2.04492322e+00,

           -5.55001718e-01,  -7.50531325e-01,  -5.83414974e-01,
           -8.11196348e-01,  -1.09901014e+00,  -8.49978470e-01,
           -6.77165701e-01,  -9.14314417e-01,  -7.06925628e-01,

            7.37747735e-01,   9.52443958e-01,   7.15798498e-01,
            9.13325667e-01,   1.18109834e+00,   8.83162238e-01,
            6.54367868e-01,   8.40373022e-01,   6.31071961e-01,

            2.03049719e+00,   2.65541924e+00,   2.01501197e+00,
            2.63784768e+00,   3.46120682e+00,   2.61630295e+00,
            1.98590144e+00,   2.59506046e+00,   1.96906955e+00,

            3.32324664e+00,   4.35839452e+00,   3.31422544e+00,
            4.36236970e+00,   5.74131530e+00,   4.34944365e+00,
            3.31743501e+00,   4.34974790e+00,   3.30706714e+00;

         // inputShape: C, H, W; Kernel: F, HH, WW
    Convolution cv("{inputShape=[3,6,6];kernel=[5,4,4];stride=2;pad=1}");
    *(cv.params["W"])= W;
    *(cv.params["b"])=b;
    MatrixN y0=cv.forward(x, nullptr);

    return matComp(y,y0,"ConvolutionForward",eps);
}

bool checkConvolutionBackward(float eps=CP_DEFAULT_NUM_EPS) {
    MatrixN x(4, 75);
    x << 4.06278962e-01,  -7.20029839e-01,  -8.77595062e-01,
           -5.69242505e-01,  -8.21071312e-02,
            3.02672415e-01,   3.11544794e-01,   6.78850317e-01,
            3.05781256e-01,  -7.35247080e-01,
            8.45416516e-01,   6.30175765e-01,   8.86099717e-01,
            4.06562604e-01,  -6.02540397e-01,
            7.59952834e-01,  -1.40269820e+00,   1.55009322e+00,
           -2.13764150e-01,  -1.63679882e+00,
            9.37892883e-01,   9.34623693e-01,   2.29637694e-01,
           -3.94409953e-01,   3.19363695e-01,

            1.40073427e+00,   7.65295699e-02,   2.59006411e+00,
            1.18691543e+00,   4.27904098e-01,
           -5.25571140e-02,   1.07981772e+00,   5.96898409e-01,
            1.25859787e+00,  -3.11337115e-01,
            5.49745455e-01,  -1.50192516e-01,   2.49671770e+00,
           -5.76520517e-01,   2.90206527e-01,
            6.83069753e-01,  -1.20577354e+00,  -7.83062617e-02,
           -3.57863145e-02,  -6.89859016e-01,
           -1.27705615e+00,  -3.38617839e-01,   6.57145506e-01,
           -7.13872291e-01,  -2.25710594e-01,

           -5.84950028e-01,   7.83725053e-01,   1.09521467e+00,
            1.58652641e+00,  -6.59051523e-01,
           -6.93647850e-01,  -4.62172438e-02,  -9.68867074e-01,
            1.04253518e-01,   3.65878113e-01,
           -6.20436137e-01,  -5.21133678e-01,  -4.51238975e-01,
           -8.66231129e-01,  -9.77512021e-02,
           -3.97595314e-01,   8.32288960e-02,   8.38346031e-02,
           -9.61101576e-01,   5.56323841e-01,
           -1.49203774e+00,  -7.62849617e-01,  -1.31800939e+00,
           -1.01578863e-01,  -1.34451982e+00,


            1.11629214e-02,   3.71619500e-01,   6.25515403e-01,
            5.44265433e-01,   2.58030608e+00,
           -2.89689208e+00,   1.03056164e+00,   1.43447215e+00,
            6.74738238e-01,  -1.84511911e+00,
           -3.22239263e-01,   1.74348499e+00,  -3.08882289e-01,
            7.95603854e-01,   6.47311433e-01,
           -3.02989147e+00,   9.76613215e-01,   8.84297919e-01,
           -1.45695523e+00,  -4.42325369e-01,
            1.18824527e+00,  -1.96667526e+00,  -1.05092338e+00,
            1.30854716e+00,  -4.53888024e-01,

           -3.79884804e-01,  -2.91014221e-01,   4.55696906e-01,
            3.18405851e-01,  -9.25646477e-01,
           -7.16927311e-01,  -2.01962127e-01,  -6.92560414e-01,
            8.30975784e-01,   7.22272760e-02,
           -9.96090540e-01,   3.99141248e-01,   3.61328510e-01,
           -1.40803404e+00,   6.65305291e-01,
           -1.59518843e-01,   4.43236368e-01,   2.04742247e-01,
           -9.62888055e-01,  -1.09431312e+00,
            1.28505241e-01,   8.07790580e-01,  -4.49374715e-01,
           -4.32796239e-01,   2.52893798e-01,

           -9.76817124e-02,   3.01471234e-02,  -2.82646447e-01,
           -1.18352895e+00,  -1.29873542e+00,
            8.43541861e-01,  -2.12674598e+00,   3.51783908e-01,
            7.14241258e-01,  -4.46955064e-01,
            6.92582940e-01,   1.45896797e+00,  -1.38710841e-01,
           -3.30895817e-01,   1.76373937e+00,
           -6.07684612e-02,  -2.27203416e+00,   7.18466352e-01,
            2.66887655e-02,  -8.60609702e-01,
            1.19592511e-01,  -6.65513272e-02,  -8.71728299e-01,
            8.29179762e-01,   1.32132812e+00,


           -9.84332692e-01,   1.62471472e+00,   6.49340001e-02,
            4.34797318e-01,  -1.35201297e-02,
            3.39988538e-01,   7.18879625e-01,   2.27799525e-01,
            7.55022197e-01,   2.25099181e-01,
           -3.31853138e-01,   6.92662234e-01,  -6.04908597e-01,
            8.29683534e-01,   1.29697634e+00,
           -5.56083891e-01,  -2.21421171e+00,   3.04101703e-01,
            7.72354427e-01,  -1.55229213e+00,
            1.89806416e+00,   7.26569169e-01,   6.54962282e-01,
           -1.08347656e+00,   1.15445419e+00,

            7.14851333e-01,   1.11924154e+00,   9.18968653e-01,
            1.45678203e+00,  -1.91415949e+00,
           -9.37495099e-01,   3.73281474e-01,   2.85868528e-01,
            4.31681231e-01,   6.62499088e-02,
           -1.48617873e+00,   5.57715334e-01,  -4.81057503e-01,
            6.87051463e-01,  -1.12790482e+00,
           -9.85240951e-01,  -1.67914658e+00,  -3.37574029e-01,
           -6.03822018e-02,  -6.09262194e-01,
            3.25978304e-01,   1.28333212e+00,  -5.41023192e-01,
            1.69426400e+00,  -2.74843013e-01,

           -1.27214735e+00,   6.93215016e-01,   7.16647831e-01,
           -1.09714483e+00,   1.23395484e+00,
            1.24751835e+00,   8.02806678e-01,   3.16606600e-01,
            1.90285586e+00,  -4.29496923e-01,
            2.51115376e-01,  -2.81213797e-01,   1.33733071e+00,
            5.71380011e-01,   5.58810987e-01,
           -6.41888643e-02,  -1.19084509e+00,   1.30599784e+00,
            1.08158035e+00,  -3.00621112e-01,
           -1.88638872e+00,   7.65711879e-01,  -6.86007084e-01,
            1.20789193e+00,   1.09465112e-03,


            4.42305847e-01,  -3.20980999e-01,   1.72799329e-01,
           -8.09578504e-01,   1.32848119e+00,
           -1.27895152e+00,   7.48160611e-01,   1.78569662e+00,
           -1.29630689e-01,  -6.57212483e-02,
           -5.68001480e-01,  -9.61151324e-01,   5.45035751e-01,
           -4.23175743e-01,   5.69798706e-01,
            1.84703153e+00,   2.20249121e-01,  -9.85408467e-01,
            1.42521634e-01,  -7.85362836e-01,
           -5.01210976e-01,   6.94574909e-01,  -8.23125847e-01,
            5.60644174e-01,  -7.49678428e-01,

           -1.93092403e+00,   1.11070681e+00,  -2.03649206e+00,
            4.50199934e-01,  -1.61569811e+00,
            6.62548119e-01,   1.99394670e+00,  -3.52990460e-01,
            1.87800598e+00,   1.10399472e-01,
            4.17827766e-01,   1.29448810e+00,   1.17098064e+00,
            1.62768992e+00,  -3.23464275e-01,
           -4.80745974e-01,  -1.87674952e-01,  -1.55835540e+00,
            5.59698707e-01,  -1.61064340e+00,
           -2.88041566e-01,  -4.98061608e-01,  -4.33308895e-01,
           -3.04804433e-01,  -2.01560459e-01,

            1.18815415e+00,  -3.61940600e-01,  -6.77218261e-01,
            8.11354952e-01,  -1.55021295e-01,
           -5.11231428e-01,  -3.66514256e-01,   1.36405386e+00,
            1.76692645e+00,   1.25480705e+00,
           -3.89975255e-01,   8.44315729e-02,   9.87579716e-01,
            3.72766182e-01,   1.01085418e+00,
           -1.96303607e+00,   9.59423670e-02,  -4.86589955e-02,
           -7.59032117e-01,  -1.44189138e-01,
           -1.36984009e+00,  -4.54511774e-01,   1.13057305e+00,
           -1.98191411e+00,  -3.29108429e-02;
    MatrixN W(2,27);
    W << -0.35513837,  1.08467349, -0.35145376,
          -0.72134629, -0.57565924, -2.01889725,
           0.71046437,  1.40272846,  0.87700153,

           0.10473475, -1.24258858, -2.13811078,
           0.12652192,  0.58375631,  0.52330807,
           0.19711781,  2.00618897,  0.02234399,

           0.62735645,  1.38290462,  0.05514387,
          -0.0482102 , -1.38552821, -0.58664296,
          -0.05557414, -0.81669299,  0.08555432,


          -0.33726335, -0.35330311, -0.27365944,
           0.752816  , -0.02478639,  0.88443971,
           0.02507951,  0.38114787, -0.53996567,

           0.9637172 ,  0.66837392,  0.04000791,
           0.87730628, -0.78766236,  0.09188994,
           0.74565225,  0.07085615, -0.05643064,

           0.07628749, -0.71903468, -0.59633026,
           0.16882438, -1.63386718,  0.05015518,
           1.20848431, -0.93531694,  0.80268051;
    MatrixN b(2,1);
    b <<  -0.48903285, -0.39030338;
    MatrixN dx(4, 75);
    dx << -1.05124493e+00,  -2.29874859e+00,  -9.73966637e-01,
           -3.37391974e+00,  -6.32150176e-01,
            1.60616065e+00,   2.15316518e+00,   3.20621313e-01,
            1.13937584e-01,  -3.21442956e+00,
            2.24212655e+00,  -4.42366045e+00,   1.32103657e+00,
           -2.19160747e+00,  -3.04093836e+00,
           -7.29661319e-01,   1.66222856e+00,   3.28816635e-01,
           -1.59753791e+00,  -1.33415970e+00,
            2.56879843e-01,   1.27687306e+00,   3.78606241e-01,
           -1.94462219e-01,   1.12236159e+00,

            2.49715723e+00,  -2.79149068e+00,  -1.05936217e+00,
           -3.51867321e+00,   5.95934762e-01,
           -3.02576129e+00,  -2.51966245e+00,   1.90066609e+00,
           -4.19301715e+00,  -2.48896161e+00,
           -1.42982951e+00,   7.66906326e-01,   1.66484653e+00,
           -1.29710099e+00,  -2.40306365e+00,
            2.89544608e+00,   2.07347535e+00,   9.32642406e-01,
           -2.45991624e+00,   1.39608510e+00,
           -5.38411133e-01,   2.18724772e+00,   5.36120619e+00,
           -6.59577634e-01,  -3.44781960e+00,

           -1.45689068e+00,  -1.86508989e+00,   8.26057589e-01,
           -1.22345977e+00,   4.16844969e+00,
           -1.20883333e+00,  -3.16983941e+00,   1.35396590e+00,
           -3.61262425e+00,   6.35665455e+00,
           -3.88149445e+00,   1.52888318e+00,  -5.12807222e-01,
           -1.53637746e+00,   2.64847781e-01,
           -4.62258725e+00,   5.06798935e+00,  -2.52076588e+00,
           -6.33453363e+00,  -2.43650195e-01,
           -4.24293924e+00,   2.36201816e+00,  -3.99325433e+00,
           -4.99940613e+00,   4.44596711e+00,


           -5.79238458e-01,  -1.33661598e+00,   4.65564246e+00,
            2.95987665e+00,   2.14203246e+00,
            1.69120963e+00,  -1.00955270e+00,  -1.56959716e+00,
           -4.80704379e+00,  -3.58121519e+00,
            1.61607936e+00,   3.97857094e+00,   2.50857403e+00,
            1.42249803e+00,   2.35444446e+00,
           -2.47712038e-01,  -5.86756713e+00,  -2.44594050e+00,
           -1.83816661e+00,  -1.45681870e-01,
           -1.28534449e+00,  -3.05204753e-01,  -1.09084146e+00,
            1.33737462e+00,   1.12182440e+00,

            3.60100014e+00,   6.75735422e-01,  -5.51404057e+00,
           -2.58088363e+00,  -7.02856364e-01,
            6.31473410e+00,  -1.15029320e+00,   3.64919006e+00,
            2.89944274e+00,  -2.45077934e+00,
           -5.54874511e+00,  -4.82090962e+00,  -1.69319209e+00,
            3.25013436e-01,   3.12000720e-01,
           -2.42610232e+00,  -2.73301586e+00,  -4.91398320e-01,
           -1.42607512e+00,  -9.53401124e-01,
            5.10246591e-04,   2.95690939e+00,   3.77013647e-01,
            1.87054330e+00,   2.72208545e+00,

           -5.03891926e-01,  -2.51765436e-01,  -1.11797102e+00,
           -3.17096204e-01,   3.49341593e+00,
            1.79220668e+00,  -1.57405679e+00,   2.08514649e+00,
            1.74235469e+00,   8.98609184e-01,
            2.55306356e+00,  -1.07878915e+00,   3.78724641e+00,
            1.76701943e+00,  -2.45530386e+00,
            2.29703711e+00,   4.65073974e+00,   1.34026012e+00,
           -6.42727069e-01,  -3.04798824e+00,
           -2.72556843e+00,   1.58668575e-01,  -3.55042552e+00,
            1.24294202e+00,   6.04326193e-03,


            1.46164065e+00,  -2.13003289e+00,   1.65809409e+00,
           -2.63070942e+00,   9.51286555e-01,
            2.63777114e+00,  -3.86190648e+00,   3.83261085e+00,
            1.09964350e+00,  -8.17842653e-01,
           -2.21345155e+00,  -4.18793533e+00,   3.41899518e+00,
           -3.07799721e+00,   1.36377794e+00,
            2.00054365e+00,   7.59555538e-01,  -9.32959063e-01,
           -5.92048740e-01,   1.89336573e+00,
            1.27429784e+00,   9.35228356e-01,   1.98937016e+00,
            2.43316250e+00,  -1.59694729e-01,

           -1.15985782e+00,  -2.28389966e+00,   2.21404222e+00,
           -7.82713570e-02,   4.08077281e-01,
           -3.57324982e+00,  -4.51360523e+00,   5.17732440e+00,
           -1.32316465e+00,  -1.65582742e-01,
            4.19573522e+00,  -3.82004696e+00,  -3.09166608e+00,
            3.24012426e+00,   3.34803889e+00,
            5.71596737e+00,  -6.19345957e+00,   4.75712600e+00,
            4.04089454e+00,   3.13782543e-02,
            8.06086994e-02,  -3.15779825e+00,   3.60781644e+00,
           -1.93018150e+00,   9.71445495e-01,

            1.98980950e+00,  -1.17287648e+00,   1.36591250e+00,
           -1.96444065e-01,  -2.18003084e+00,
            2.03618880e+00,  -1.43101590e+00,   5.30990912e+00,
            9.20580520e-01,  -4.20831837e+00,
           -6.89307507e+00,   1.48581582e+00,   3.39243604e+00,
           -1.16846891e+00,  -7.63470010e-01,
           -3.46039040e+00,  -3.40441746e+00,   9.60571960e-01,
            5.59337395e-01,  -3.13771560e+00,
            2.90251298e+00,  -5.41293335e+00,   8.64403001e+00,
           -1.58639128e-02,  -2.26159459e+00,


            8.20516613e-01,  -1.41506452e+00,  -1.73812035e+00,
           -1.82298142e+00,  -4.63543831e+00,
            8.56015738e-01,   5.82692858e-01,   2.80887781e-01,
            4.43001557e+00,   1.95440071e+00,
           -8.07785952e-01,  -2.24514804e+00,   2.55516978e+00,
           -1.17418985e+00,   3.52573378e+00,
            3.87510665e+00,   2.05495609e+00,  -1.73932865e+00,
           -3.54592589e+00,   1.65528346e+00,
           -2.96614012e+00,  -4.39427109e+00,  -3.03805747e+00,
           -2.42601391e-01,  -8.07440715e-01,

            2.02703143e+00,  -1.24179770e+00,  -1.36030480e+00,
            5.85247950e+00,  -1.51857521e+00,
            3.68622334e+00,  -4.01367285e+00,   1.61578132e-01,
            6.10189585e+00,   4.33120913e+00,
            1.64988685e+00,   3.16788640e+00,  -4.08750855e+00,
            2.96251526e+00,  -1.55318546e+00,
            2.02963383e-01,  -6.39720240e+00,  -2.54262042e+00,
           -3.99168408e+00,   1.69465793e+00,
            1.20834842e+00,   1.77218343e+00,   2.62972331e+00,
           -2.73859387e+00,   9.98315627e-01,

            2.23445472e+00,   9.39657519e-01,  -3.27009717e+00,
            1.26660541e+00,  -3.48211453e+00,
            7.13634600e+00,  -3.95823798e+00,  -2.40368353e+00,
            2.06784867e+00,  -2.29939699e+00,
            8.36871307e-01,  -4.39283210e+00,   2.55545879e+00,
            4.32675205e+00,  -1.84820468e+00,
            5.52361859e+00,   1.00335734e+00,  -3.77979654e-02,
            3.98715622e+00,  -4.14629493e+00,
            2.32110000e+00,  -2.31618185e+00,  -2.40899216e+00,
           -3.90533589e+00,   2.69809612e-01;
    MatrixN dW(2,27);
    dW << 7.76312149,   4.66733323,   8.1890197 ,
           -4.37454191,  -8.17503308,   9.13918729,
           15.45904902,  10.25547064,  -5.66654275,

            2.5788164 ,  -0.52958419,   5.25793559,
           -5.94902815,  -2.16831493,   4.49496134,
           12.40914405,  -2.33356582,   7.40659252,

           -5.33814293,   0.80389108,  -6.77465292,
          -10.76069027,   0.76758755,  -1.65334302,
            3.82291043,  14.45696049, -10.832082  ,


            1.8697618 , -10.03973545, -17.97308064,
           -2.74154261,  12.05158818,  -3.25524939,
           -4.35128392,  19.07935165,   6.61602367,

           -0.86482772,  -1.00336309, -17.05030267,
            0.64635664,  -9.738997  , -21.12904455,
           -0.13885334,   2.11260808,  -8.50269923,

           -1.70975933, -11.79444595,  -0.87365394,
            6.52065458, -11.94349945, -15.29530413,
           -7.73371842,   3.40362722,  -8.78586713;
    MatrixN db(2,1);
    db << 17.65964691,  -5.23295028;
    MatrixN dchain(4,50);
    dchain << 0.24836283,  0.33590279,  1.63346454,  0.21689593, -1.62253881,
          -0.03400353,  1.11333587,  0.29573696,  0.51460659, -1.33410048,
           1.64547739, -0.1804801 ,  1.24025162, -0.45958495, -0.20283745,
           1.03576165, -0.15000759,  0.68291561,  0.7009178 , -1.4762639 ,
          -0.53490811,  1.4532825 ,  1.05732343, -0.43142658, -0.90043725,

           0.06497122,  0.78454725, -1.37572605,  0.02429663, -1.81137879,
           2.45372871, -0.13105885, -0.24501502, -0.55008119, -0.80020087,
          -0.02043736, -0.18257312, -0.04522444, -0.60268432, -0.583198  ,
           0.48290751, -1.52625924,  0.77698356,  1.34897691, -0.22028905,
           1.02520125, -0.6235423 ,  0.6826662 ,  2.25821506, -0.16988704,


           1.92547065, -0.7597674 ,  0.02650591,  0.48386609, -1.49018314,
          -0.66160909,  0.56016673,  0.63646527, -0.16713383,  0.67827109,
          -0.11408664, -0.46282622, -0.12305173, -0.2496889 ,  0.0981504 ,
           0.83435664,  0.26198835,  0.60408632,  0.24423178,  0.93440163,
           1.14636587,  0.37361258,  0.51775075,  0.05434362, -0.05941737,

          -1.13597924,  0.98548132,  2.31747878,  1.39949287, -0.12533536,
          -0.87270972,  0.53574251, -2.23364113, -1.25404886,  0.33237128,
           1.25517806,  0.17953582, -0.11638751, -0.03338221,  0.4097034 ,
          -1.70492966, -1.62322879, -0.83435909,  0.36162776,  1.38937947,
          -0.1061854 , -1.36092404,  1.12713214, -0.77828978, -1.06868978,


          -0.18555716,  0.30072344,  0.91104691, -0.37014742,  1.00090184,
           0.77200082, -1.02904854,  0.57819312,  0.1680283 ,  0.44558377,
           2.48122876, -1.66522128,  0.7411329 ,  0.847575  , -0.51789978,
          -0.98162056,  1.05644732,  1.09088424, -1.62324965,  1.24645441,
          -0.67473992, -0.18413263, -1.07650479,  0.27888282, -0.82877504,

          -0.77243645,  0.10673591, -0.20076532,  1.05422291,  0.32635894,
          -0.13274228, -0.65980658, -1.44102273, -0.03213447,  1.63368114,
           0.55986992, -0.25727178, -1.04349709, -0.24595085, -0.01306534,
           0.97272734,  0.82970104, -2.10186315,  0.75964172,  0.37648694,
          -0.55357048,  1.29400895, -2.55335323, -0.1089839 ,  1.43315407,


           1.10654948, -1.27725299,  1.60625794,  1.11783959,  0.35670366,
          -0.56180823,  1.2036319 , -1.54174391,  1.01668209, -0.36368006,
           1.03223669, -0.5135541 , -0.01485799, -1.71322876,  0.87569716,
          -0.52929955, -0.40194623,  0.71189275, -1.06158617,  0.58602659,
           1.30356907,  1.15644221,  0.38860402,  0.89430991, -0.63994114,

          -1.25225268,  1.13437715, -0.12101369, -1.47669536,  1.00405199,
          -2.06014007,  0.11820221,  0.30668661, -0.34604699,  0.52438995,
          -0.20236412,  0.91509269, -1.12761561, -1.68432089,  1.57649879,
          -0.31282652,  0.71725415,  0.03513737,  0.10890985, -0.99803075,
          -1.6124455 , -0.3881734 ,  0.90206887,  1.34225259,  0.37395634;

    Convolution cv("{inputShape=[3,5,5];kernel=[2,3,3];stride=1;pad=1}");
    *(cv.params["W"])=W;
    *(cv.params["b"])=b;
    t_cppl cache;
    t_cppl grads;
    MatrixN y=cv.forward(x, &cache);
    MatrixN dx0=cv.backward(dchain, &cache, &grads);
    bool allOk=true;
    bool ret=matComp(dx,dx0,"ConvolutionBackward dx",eps);
    if (!ret) allOk=false;
    ret=matComp(dW,*(grads["W"]),"ConvolutionBackward dW",eps);
    if (!ret) allOk=false;
    ret=matComp(db,*(grads["b"]),"ConvolutionBackward bx",eps);
    if (!ret) allOk=false;
    cppl_delete(&cache);
    cppl_delete(&grads);
    return allOk;
}

bool checkPoolingForward(floatN eps=CP_DEFAULT_NUM_EPS) {
    MatrixN x(2,3*4*4); // 2x3x4x4 NxCxHxW
    x << -0.3       , -0.29263158, -0.28526316, -0.27789474,
          -0.27052632, -0.26315789, -0.25578947, -0.24842105,
          -0.24105263, -0.23368421, -0.22631579, -0.21894737,
          -0.21157895, -0.20421053, -0.19684211, -0.18947368,

          -0.18210526, -0.17473684, -0.16736842, -0.16      ,
          -0.15263158, -0.14526316, -0.13789474, -0.13052632,
          -0.12315789, -0.11578947, -0.10842105, -0.10105263,
          -0.09368421, -0.08631579, -0.07894737, -0.07157895,

          -0.06421053, -0.05684211, -0.04947368, -0.04210526,
          -0.03473684, -0.02736842, -0.02      , -0.01263158,
          -0.00526316,  0.00210526,  0.00947368,  0.01684211,
           0.02421053,  0.03157895,  0.03894737,  0.04631579,


           0.05368421,  0.06105263,  0.06842105,  0.07578947,
           0.08315789,  0.09052632,  0.09789474,  0.10526316,
           0.11263158,  0.12      ,  0.12736842,  0.13473684,
           0.14210526,  0.14947368,  0.15684211,  0.16421053,

           0.17157895,  0.17894737,  0.18631579,  0.19368421,
           0.20105263,  0.20842105,  0.21578947,  0.22315789,
           0.23052632,  0.23789474,  0.24526316,  0.25263158,
           0.26      ,  0.26736842,  0.27473684,  0.28210526,

           0.28947368,  0.29684211,  0.30421053,  0.31157895,
           0.31894737,  0.32631579,  0.33368421,  0.34105263,
           0.34842105,  0.35578947,  0.36315789,  0.37052632,
           0.37789474,  0.38526316,  0.39263158,  0.4;
    MatrixN y(2,12);
    y << -0.26315789, -0.24842105,
         -0.20421053, -0.18947368,
         -0.14526316, -0.13052632,
         -0.08631579, -0.07157895,
         -0.02736842, -0.01263158,
          0.03157895,  0.04631579,
          0.09052632,  0.10526316,
          0.14947368,  0.16421053,
          0.20842105,  0.22315789,
          0.26736842,  0.28210526,
          0.32631579,  0.34105263,
          0.38526316,  0.4;
         // inputShape: C, H, W; kernel: F, HH=stride, WW=stride
    Pooling pl("{inputShape=[3,4,4];stride=2}");
    MatrixN y0=pl.forward(x, nullptr);

    return matComp(y,y0,"PoolingForward",eps);
}

bool checkPoolingBackward(float eps=CP_DEFAULT_NUM_EPS) {
    MatrixN x(3, 2*8*8);
    x << -0.20821944,  0.76470027, -0.42823441,  0.23081636, -0.7821132 ,
          -0.19361657, -0.25946762, -1.01735498,
          -1.21951272,  0.49819365, -0.44809611,  0.92079144, -0.56857596,
          -0.27794466, -1.88411009,  1.90659228,
          -0.47273599, -0.94183724, -1.15399693,  0.44185057,  1.3521356 ,
           0.038481  , -0.84776888,  0.05535332,
          -0.12486817,  0.48866677, -0.24764457,  0.05246682,  1.96750726,
           0.48715605,  0.17504119,  0.82134656,
          -0.42960705,  1.77148609,  0.16379425, -0.29082004,  0.52326352,
           1.47661533, -0.19514707,  1.57767945,
          -0.07487967, -1.51977691, -0.59051645, -0.22851541,  1.59730828,
          -1.04449441,  1.48661379,  0.86497631,
           0.65681371,  0.50023527, -1.68840264,  0.72449393,  0.06154832,
          -0.82007799, -0.02014138, -0.86370724,
           1.58534327,  1.14112418, -0.48090446, -0.042038  ,  0.50606844,
          -0.10656982, -0.03190944, -1.07508596,

          -0.35814308,  0.45472176, -0.23336728,  0.90551898, -0.99163112,
           0.35008976, -0.25482636,  0.19915775,
          -0.77842405, -0.82473092, -0.51410154, -0.08928771, -0.41909776,
          -1.95161101,  1.10078008,  0.11088705,
          -0.24577978,  1.09930858,  0.05714487,  1.36417158,  0.02176026,
          -1.95798167, -0.26250676, -1.19025748,
           1.09570083, -0.06226364,  0.80339967, -0.0758211 , -0.18690804,
           1.49729031, -0.82952823,  0.33878078,
           1.46551033, -1.02128691, -0.91337491,  1.23652237, -0.09419522,
          -0.17977637,  0.75537251, -0.14552913,
           0.61578288, -1.20124727, -1.85926884,  1.3757701 , -1.02581886,
           1.303463  ,  0.73080734, -1.20004489,
           0.21973867,  0.29373124,  1.99159088, -1.11957381,  0.2658984 ,
           0.26915953,  0.27556056,  0.49136136,
           0.3612057 ,  0.07358504,  0.73521503,  1.07389274,  0.60949853,
          -0.38312498,  0.89033768,  0.91623125,


          -1.76705153, -1.73491261,  0.21020303,  0.38171743, -0.48405564,
          -1.57386388,  0.87403613,  0.54136034,
           1.53814942,  0.74653043,  0.97793464,  0.05471139, -1.4336575 ,
          -0.24236267, -1.05111491, -0.94523348,
          -0.75268226,  0.0816029 , -0.05990043,  0.11669214,  0.08999444,
           0.82241626,  0.712311  ,  0.16681093,
           1.56757749,  0.84085497, -1.03778945,  0.18714578,  0.6166835 ,
           0.06464151,  1.77329425,  0.53635759,
           1.59541903, -0.10955936,  0.09776589, -0.43620696, -0.88174536,
          -0.13463976,  1.32932224, -1.5940335 ,
          -0.57096876,  0.48208184, -0.60498125,  0.4741654 ,  0.18197066,
          -1.23380724, -1.23998288, -0.50275103,
           3.49827418,  1.15780691,  0.14641761, -0.17350691, -0.18374094,
           0.3106503 ,  0.05314125,  0.87079586,
          -0.90732427, -1.20416999,  1.68494269, -2.22035246, -0.50020293,
          -0.07189888,  0.46373325, -0.05885692,

          -0.18307148,  0.17351858,  0.36120907, -0.47482548, -0.2414964 ,
           0.23315281, -1.09976171,  0.03012353,
          -1.20211889,  1.0827036 , -0.97788039, -0.67809763,  0.51644967,
          -0.27490245,  0.0478945 , -1.49470066,
          -0.036517  ,  0.33607844,  0.02106272,  0.34517926, -0.44099748,
          -1.37764821, -0.4377515 ,  2.2515369 ,
          -0.37733989, -0.36166212, -2.13904   , -0.66325432,  0.52422798,
           3.51735895, -0.09820525,  0.1784247 ,
           0.25951956,  0.94219836, -0.57460869, -0.54582794, -1.61570535,
          -0.18259026, -0.17537327,  0.81053405,
           1.72576168, -0.22244469, -0.58099542,  0.01594571,  0.55960778,
           0.37940704,  0.31612082, -0.49076277,
          -0.05711323,  1.97590329,  0.24268064, -1.02724374,  1.63612621,
          -0.43711261, -1.0679252 ,  0.17733876,
           0.08950617, -1.33003954, -1.51386604,  0.24203421,  1.57305846,
          -0.83314106,  0.38760212,  2.10037992,


           0.97310772, -0.70923623,  0.32140762, -2.75490947, -0.06021106,
          -0.11980104,  0.78990898, -0.94220543,
           1.94565408,  1.26863143,  0.9039833 , -0.19637166,  0.01524785,
           0.79755599, -1.10231533,  0.45860753,
           0.82711965, -0.45613535, -0.78245238, -0.04901804, -1.6139697 ,
          -1.99214353,  0.00877878, -0.22394173,
           1.14287009, -0.4194935 ,  0.97040715, -0.30421962,  0.78563701,
           1.04483927, -0.4125141 ,  0.1052007 ,
          -0.8521989 ,  0.6826181 ,  1.1029444 , -0.32969948, -0.06845776,
          -1.0790365 , -0.43846153, -0.15257518,
          -0.53943044,  0.58558499,  0.60449336, -0.34634213, -0.60843111,
          -1.58272669,  1.2009205 ,  0.42710111,
           1.38534904, -1.41947659, -1.16212324, -0.32895225,  0.55225572,
           1.28587717, -0.61798035,  1.07671263,
          -0.10431983, -0.0582642 ,  0.17034094, -1.39658426, -0.43604526,
          -1.84565462,  1.74213715, -0.53842971,

           0.27123878,  1.11081723,  0.67191105,  0.63904708, -1.23442157,
          -0.33489185,  1.05717369,  0.62583597,
          -0.17689927, -0.31854626,  0.22574472,  0.63169287, -2.71288479,
           1.99653206,  0.21683901,  0.74752754,
           0.12947894,  1.5077572 , -0.46006936,  1.53470713,  0.37041118,
           0.63741785, -2.37744153,  0.28781378,
          -0.2151778 , -0.09469675, -0.85938255, -2.23271977, -0.33938592,
          -1.50763285, -0.42199155,  1.18545128,
          -1.47395027,  0.05590323, -0.20287167, -1.29859336, -0.06927397,
           0.7785629 , -0.32867654,  0.75829549,
           1.19794092, -0.71202494,  0.85842106, -0.30092262,  1.17083144,
           0.24035558, -1.07172363, -0.07449393,
           0.32310846,  0.06665681, -0.88290151,  0.42169145,  0.49928071,
          -0.25150176,  0.38966503,  2.17860381,
          -1.24330528,  0.00585855, -1.17676122,  0.1536678 , -0.67161206,
           1.3949744 ,  0.30369064, -1.02368514;
    MatrixN dchain(3,2*4*4);
    dchain << 1.29374452, -0.31671873,  0.84842249, -1.4721032 ,
          -0.34921717, -1.9646576 ,  0.68748776,  1.71009631,
          -1.06116246,  0.07276335,  1.75090416,  1.21168054,
          -0.39189565,  1.30593839,  0.93956115,  0.25105781,

          -0.4560326 ,  0.97480044, -1.3597251 , -0.23181517,
           0.12403004,  0.83317537, -1.52263223,  0.15419263,
          -1.19366621, -0.95997357,  0.30999145,  1.33168829,
           0.19031117, -0.36261005,  0.46397314, -2.38480408,


          -0.58552865, -0.13871152, -0.65902429,  1.80143258,
           0.64211802, -0.01029485, -1.79380576,  0.75943923,
          -0.41885403,  0.26041765, -0.4883311 ,  0.10832315,
           0.07752951,  1.37929608,  1.15592811, -0.85945464,

          -0.51382159, -0.92172661, -1.42632614,  0.82134494,
           0.88597893, -0.33538864, -0.08146537,  1.0791449 ,
           0.1157789 , -0.06358474,  1.6672031 , -0.06467902,
          -1.23959368, -1.18716685, -0.67859249,  1.43853299,


          -0.83655323,  1.18295151, -1.62708353, -1.41749206,
           0.02751224,  0.52466305, -0.43795283, -1.44280928,
          -1.4918993 ,  0.876771  , -0.51261532,  0.69193701,
          -0.41820108,  0.84120434,  0.29369576, -0.06614878,

           0.72712383, -1.11525569, -0.13372329,  0.53674014,
          -0.38395277,  0.89723775,  0.20742629, -0.94646943,
           0.67617896,  0.52110043, -1.38125575, -0.51175397,
           1.41848186, -0.05441891, -0.62679592,  1.40399454;
    MatrixN dx(3, 2*8*8);
    dx << 0.        ,  1.29374452,  0.        ,  0.        ,  0.        ,
           0.84842249,  0.        ,  0.        ,
           0.        ,  0.        ,  0.        , -0.31671873,  0.        ,
           0.        ,  0.        , -1.4721032 ,
           0.        ,  0.        ,  0.        , -1.9646576 ,  0.        ,
           0.        ,  0.        ,  0.        ,
           0.        , -0.34921717,  0.        ,  0.        ,  0.68748776,
           0.        ,  0.        ,  1.71009631,
           0.        , -1.06116246,  0.07276335,  0.        ,  0.        ,
           0.        ,  0.        ,  1.21168054,
           0.        ,  0.        ,  0.        ,  0.        ,  1.75090416,
           0.        ,  0.        ,  0.        ,
           0.        ,  0.        ,  0.        ,  1.30593839,  0.        ,
           0.        ,  0.25105781,  0.        ,
          -0.39189565,  0.        ,  0.        ,  0.        ,  0.93956115,
           0.        ,  0.        ,  0.        ,

           0.        , -0.4560326 ,  0.        ,  0.97480044,  0.        ,
          -1.3597251 ,  0.        ,  0.        ,
           0.        ,  0.        ,  0.        ,  0.        ,  0.        ,
           0.        , -0.23181517,  0.        ,
           0.        ,  0.12403004,  0.        ,  0.83317537,  0.        ,
           0.        ,  0.        ,  0.        ,
           0.        ,  0.        ,  0.        ,  0.        ,  0.        ,
          -1.52263223,  0.        ,  0.15419263,
          -1.19366621,  0.        ,  0.        ,  0.        ,  0.        ,
           0.        ,  1.33168829,  0.        ,
           0.        ,  0.        ,  0.        , -0.95997357,  0.        ,
           0.30999145,  0.        ,  0.        ,
           0.        ,  0.        , -0.36261005,  0.        ,  0.        ,
           0.        ,  0.        ,  0.        ,
           0.19031117,  0.        ,  0.        ,  0.        ,  0.46397314,
           0.        ,  0.        , -2.38480408,


           0.        ,  0.        ,  0.        ,  0.        ,  0.        ,
           0.        ,  1.80143258,  0.        ,
          -0.58552865,  0.        , -0.13871152,  0.        ,  0.        ,
          -0.65902429,  0.        ,  0.        ,
           0.        ,  0.        ,  0.        ,  0.        ,  0.        ,
          -1.79380576,  0.        ,  0.        ,
           0.64211802,  0.        ,  0.        , -0.01029485,  0.        ,
           0.        ,  0.75943923,  0.        ,
          -0.41885403,  0.        ,  0.        ,  0.        ,  0.        ,
           0.        ,  0.10832315,  0.        ,
           0.        ,  0.        ,  0.        ,  0.26041765, -0.4883311 ,
           0.        ,  0.        ,  0.        ,
           0.07752951,  0.        ,  0.        ,  0.        ,  0.        ,
           1.15592811,  0.        , -0.85945464,
           0.        ,  0.        ,  1.37929608,  0.        ,  0.        ,
           0.        ,  0.        ,  0.        ,

           0.        ,  0.        , -0.92172661,  0.        ,  0.        ,
           0.        ,  0.        ,  0.        ,
           0.        , -0.51382159,  0.        ,  0.        , -1.42632614,
           0.        ,  0.82134494,  0.        ,
           0.        ,  0.88597893,  0.        , -0.33538864,  0.        ,
           0.        ,  0.        ,  1.0791449 ,
           0.        ,  0.        ,  0.        ,  0.        ,  0.        ,
          -0.08146537,  0.        ,  0.        ,
           0.        ,  0.        ,  0.        ,  0.        ,  0.        ,
           0.        ,  0.        , -0.06467902,
           0.1157789 ,  0.        ,  0.        , -0.06358474,  1.6672031 ,
           0.        ,  0.        ,  0.        ,
           0.        , -1.23959368, -1.18716685,  0.        , -0.67859249,
           0.        ,  0.        ,  0.        ,
           0.        ,  0.        ,  0.        ,  0.        ,  0.        ,
           0.        ,  0.        ,  1.43853299,


           0.        ,  0.        ,  0.        ,  0.        ,  0.        ,
           0.        , -1.41749206,  0.        ,
          -0.83655323,  0.        ,  1.18295151,  0.        ,  0.        ,
          -1.62708353,  0.        ,  0.        ,
           0.        ,  0.        ,  0.        ,  0.        ,  0.        ,
           0.        ,  0.        ,  0.        ,
           0.02751224,  0.        ,  0.52466305,  0.        ,  0.        ,
          -0.43795283,  0.        , -1.44280928,
           0.        , -1.4918993 ,  0.876771  ,  0.        , -0.51261532,
           0.        ,  0.        ,  0.        ,
           0.        ,  0.        ,  0.        ,  0.        ,  0.        ,
           0.        ,  0.69193701,  0.        ,
          -0.41820108,  0.        ,  0.        ,  0.        ,  0.        ,
           0.29369576,  0.        ,  0.        ,
           0.        ,  0.        ,  0.84120434,  0.        ,  0.        ,
           0.        , -0.06614878,  0.        ,

           0.        ,  0.72712383, -1.11525569,  0.        ,  0.        ,
           0.        ,  0.53674014,  0.        ,
           0.        ,  0.        ,  0.        ,  0.        ,  0.        ,
          -0.13372329,  0.        ,  0.        ,
           0.        , -0.38395277,  0.        ,  0.89723775,  0.        ,
           0.20742629,  0.        ,  0.        ,
           0.        ,  0.        ,  0.        ,  0.        ,  0.        ,
           0.        ,  0.        , -0.94646943,
           0.        ,  0.        ,  0.        ,  0.        ,  0.        ,
           0.        ,  0.        , -0.51175397,
           0.67617896,  0.        ,  0.52110043,  0.        , -1.38125575,
           0.        ,  0.        ,  0.        ,
           1.41848186,  0.        ,  0.        , -0.05441891,  0.        ,
           0.        ,  0.        ,  1.40399454,
           0.        ,  0.        ,  0.        ,  0.        ,  0.        ,
          -0.62679592,  0.        ,  0.;
    Pooling pl("{inputShape=[2,8,8];stride=2}");
    t_cppl cache;
    t_cppl grads;
    MatrixN y=pl.forward(x, &cache);
    MatrixN dx0=pl.backward(dchain, &cache, &grads);
    bool allOk=true;
    bool ret=matComp(dx,dx0,"PoolingBackward dx",eps);
    if (!ret) allOk=false;
    cppl_delete(&cache);
    cppl_delete(&grads);
    return allOk;
}
/*
bool checkSpatialBatchNormForward(floatN eps=CP_DEFAULT_NUM_EPS) {
    t_cppl cache;
    bool allOk=true;
    int N=2,C=3,H=4,W=5;
    MatrixN x(N,C*H*W);
    x << 8.78962706,   8.0291637 ,  11.60778889,   4.99186032,
            6.13744244],
         [ 14.59732005,  14.10668797,  13.37234881,   3.00249161,
            9.62136543],
         [  4.22327468,  10.00268404,  14.81851005,   9.75125777,
           11.43856752],
         [  3.51450781,  16.89735717,  12.65431168,   6.38401118,
           12.2657403 ]],

        [[ 10.87153462,   8.68198036,   6.73262304,   0.5534183 ,
            4.27954268],
         [  8.69555438,   6.40090306,   6.73451431,  11.92334719,
           17.68919521],
         [ 13.45727092,   7.89658869,   1.4195175 ,  11.61283967,
           10.72618318],
         [ 15.11274493,   7.51741157,  12.75017856,  10.5682995 ,
           -0.03013656]],

        [[  4.88465059,   6.40105871,  10.05622138,  12.837527  ,
           11.16735146],
         [ 13.57428873,   8.56767183,   9.9347655 ,  16.26914829,
            6.9370306 ],
         [ 14.17225379,   6.19287826,  17.23022609,   7.06608598,
           13.95560841],
         [ 16.40296331,   3.98507805,  15.32086583,   2.56310822,
            7.72864566]]],


       [[[  5.85471718,   2.72990482,   4.54645332,   9.44162877,
           13.86911841],
         [ 14.07873185,   8.54849704,  11.180672  ,   5.63914828,
           10.28946611],
         [ 16.42387985,   6.37100762,  11.14480784,  19.79021647,
           13.78566717],
         [ 15.67697588,   5.64131222,  10.28372126,   5.28879624,
           10.75321074]],

        [[  8.98089762,   7.86301729,   5.23153917,   9.30918146,
            7.16110546],
         [  0.51168663,   5.85359042,   9.99794186,   7.05953747,
            5.54801046],
         [ 17.26655238,  12.44949015,  12.79318267,  14.58963923,
            9.6533302 ],
         [ 13.68057759,   2.97747567,   6.33454499,   6.39428531,
           13.38036783]],

        [[  3.22744799,  15.85551598,   7.15545571,   9.47726025,
            7.500317  ],
         [ 12.32933878,   2.98779115,  17.81234035,  12.13771252,
           12.78516613],
         [  8.60556051,  11.55277572,   9.64684081,   7.15129868,
           10.71853786],
         [  7.70506503,   2.78056639,   5.40666492,   5.97151951,
            8.66736087;

    MatrixN xn(10,3);
    xn << ;

    SpatialBatchNorm sbn("{inputShape=[3];train=true}");
    //bn.setPar("trainMode", true);
    MatrixN xn0=sbn.forward(x, &cache);
    MatrixN mean=xn0.colwise().mean();
    cerr << "Mean:" << mean << endl;
    MatrixN xme = xn0.rowwise() - RowVectorN(mean.row(0));
    MatrixN xmsq = ((xme.array() * xme.array()).colwise().sum()/xn0.rows()).array().sqrt();
    cerr << "StdDev:" << xmsq << endl;

    if (!matComp(xn,xn0,"SpatialBatchNormForward",eps)) {
        cerr << "SpatialBatchNorm forward failed" << endl;
        allOk=false;
    }  else {
        cerr << "  SpatialBatchNorm forward ok." << endl;
    }

    MatrixN runmean(1,3);
    runmean << ;
    MatrixN runvar(1,3);
    runvar << ;
    if (!matComp(*(cache["running_mean"]),runmean)) {
        cerr << "SpatialBatchNorm running-mean failed" << endl;
        allOk=false;
    } else {
        cerr << "  SpatialBatchNorm running mean ok." << endl;
    }
    if (!matComp(*(cache["running_var"]),runvar)) {
        cerr << "SpatialBatchNorm running-var failed" << endl;
        allOk=false;
    } else {
        cerr << "  SpatialBatchNorm running var ok." << endl;
    }
    cppl_delete(&cache);

    t_cppl cache2;
    MatrixN xn2(10,3);
    xn2 << ;


    SpatialBatchNorm sbn2("{inputShape=[3];train=true}");
    *(sbn2.params["gamma"]) << 1.0, 2.0, 3.0;
    *(sbn2.params["beta"]) << 11.0, 12.0, 13.0;
    //bn.setPar("trainMode", true);
    MatrixN xn20=sbn2.forward(x, &cache2);
    MatrixN mean2=xn20.colwise().mean();
    cerr << "Mean:" << mean2 << endl;
    MatrixN xme2 = xn20.rowwise() - RowVectorN(mean2.row(0));
    MatrixN xmsq2 = ((xme2.array() * xme2.array()).colwise().sum()/xn20.rows()).array().sqrt();
    cerr << "StdDev:" << xmsq2 << endl;

    if (!matComp(xn2,xn20,"SpatialBatchNormForward",eps)) {
        cerr << "SpatialBatchNorm with beta/gamma forward failed" << endl;
        allOk=false;
    }  else {
        cerr << "  SpatialBatchNorm beta/gamma forward ok." << endl;
    }

    MatrixN runmean2(1,3);
    runmean2 << ;
    MatrixN runvar2(1,3);
    runvar2 << ;
    if (!matComp(*(cache2["running_mean"]),runmean2)) {
        cerr << "SpatialBatchNorm running-mean2 failed" << endl;
        allOk=false;
    } else {
        cerr << "  SpatialBatchNorm running mean2 ok." << endl;
    }
    if (!matComp(*(cache2["running_var"]),runvar2)) {
        cerr << "SpatialBatchNorm running-var2 failed" << endl;
        allOk=false;
    } else {
        cerr << "  SpatialBatchNorm running var2 ok." << endl;
    }
    cppl_delete(&cache2);

    t_cppl cache3;
    int nnr=200;
    MatrixN xt(nnr,3);
    BatchNorm sbn3("{inputShape=[3];train=true}");
    *(sbn3.params["gamma"]) << 1.0, 2.0, 3.0;
    *(sbn3.params["beta"]) << 0.0, -1.0, 4.0;
    for (int i=0; i<nnr; i++) {
        xt.setRandom();
        sbn3.forward(xt,&cache3);
    }
    cerr << "  Running mean after " << nnr << " cycl: " << *(cache3["running_mean"]) << endl;
    cerr << "  Running stdvar after " << nnr << " cycl: " << *(cache3["running_var"]) << endl;
    cerr << "switching test" << endl;
    sbn3.cp.setPar("train", false);
    if (sbn3.cp.getPar("train", true)) cerr << "INTERNAL ERROR: parSet boolean failed!" << endl;
    xt.setRandom();
    MatrixN xn30=sbn3.forward(xt, &cache3);
    MatrixN mean3=xn30.colwise().mean();
    cerr << "  Mean:" << mean3 << endl;
    if (!matComp(*(bn3.params["beta"]), mean3, "SpatialBatchnorm train/test sequence: mean", 0.1)) {
        allOk=0;
    }
    MatrixN xme3 = xn30.rowwise() - RowVectorN(mean3.row(0));
    MatrixN xmsq3 = ((xme3.array() * xme3.array()).colwise().sum()/xn30.rows()).array().sqrt();
    cerr << "  StdDev:" << xmsq3 << endl;
    if (!matComp(*(bn3.params["gamma"]), xmsq3, "SpatialBatchnorm train/test sequence: stdderi", 0.1)) {
        allOk=0;
    }
    cppl_delete(&cache3);

    return allOk;
}

bool checkSpatialBatchNormBackward(float eps=CP_DEFAULT_NUM_EPS) {
    bool allOk=true;
    MatrixN x(4,5);
    x << ;
    MatrixN gamma(1,5);
    gamma << ;
    MatrixN beta(1,5);
    beta << ;

    MatrixN dx(4,5);
    dx << ;
    MatrixN dgamma(1,5);
    dgamma << ;
    MatrixN dbeta(1,5);
    dbeta << ;

    MatrixN dchain(4,5);
    dchain << ;

    SpatialBatchNorm sbn("{inputShape=[5];train=true}");
    *(sbn.params["gamma"])=gamma;
    *(sbn.params["beta"])=beta;

    t_cppl cache;
    t_cppl grads;
    MatrixN y=sbn.forward(x, &cache);
    MatrixN dx0=sbn.backward(dchain, &cache, &grads);

    bool ret=matComp(dx,dx0,"SpatialBatchNormBackward dx",eps);
    if (!ret) allOk=false;
    ret=matComp(dgamma,*grads["gamma"],"SpatialBatchNormBackward dgamma",eps);
    if (!ret) allOk=false;
    ret=matComp(dbeta,*grads["beta"],"SpatialBatchNormBackward dbeta",eps);
    if (!ret) allOk=false;

    cppl_delete(&cache);
    cppl_delete(&grads);
    return allOk;
}

*/

bool checkAffineRelu(float eps=CP_DEFAULT_NUM_EPS) {
    bool allOk=true;
    MatrixN x(2,4);
    x << -2.44826954,  0.81707546,  1.31506197, -0.0965869,
         -1.58810595,  0.61785734, -0.44616526, -0.82397868;
    MatrixN W(4,5);
    W << 0.86699529, -1.01282323, -0.38693827, -0.74054919, -1.1270489,
        -2.27456327,  0.190157  , -1.26097006, -0.33208802,  0.16781256,
         0.08560445, -0.24551482,  0.30694568, -1.61658197, -3.02608437,
         0.18890925,  1.7598865 , -0.14769698, -0.59141176, -0.85895842;
    MatrixN b(1,5);
    b << 1.81489966,  1.27103839,  1.58359929, -0.8527733 ,  1.24037006;
    MatrixN y(2,5);
    y << 0.        ,  3.41322609,  1.91853897,  0.        ,  0.24028072,
         0.        ,  1.65643012,  1.40374932,  1.32668765,  5.19182449;

    AffineRelu arl("{inputShape=[4];hidden=5}");
    t_cppl cache;
    t_cppl grads;
    *(arl.params["af-W"])=W;
    *(arl.params["af-b"])=b;
    MatrixN y0=arl.forward(x, &cache);
    bool ret=matComp(y,y0,"AffineRelu",eps);
    if (!ret) allOk=false;

    MatrixN dx(2,4);
    dx << 2.29906266, -1.48504925,  6.47154972,  1.00439731,
          1.8610674 , -0.74000018, -0.6322688 , -4.68601953;
    MatrixN dW(4,5);
    dW << 0.        ,  4.7081366 , -2.63137168,  0.27607488,  4.10764656,
          0.        , -1.78497082,  0.90776884, -0.10740775, -1.32401681,
          0.        ,  0.6314218 ,  0.97587313,  0.07756096, -2.89927552,
          0.        ,  2.03769315, -0.36020745,  0.1432397 , -0.24398387;
    MatrixN db(1,5);
    db << 0.        , -2.77768192,  1.19310997, -0.17383908, -1.49039921;
    MatrixN dchain(2,5);
    dchain << -1.08201385, -0.34514762,  0.8563332 ,  0.7021515 , -2.02372516,
              -0.26158065, -2.43253431,  0.33677677, -0.17383908,  0.53332595;

    MatrixN dx0=arl.backward(dchain, &cache, &grads);

    ret=matComp(dx,dx0,"AffineRelu dx",eps);
    if (!ret) allOk=false;
    ret=matComp(dW,*(grads["af-W"]),"AffineRelu dW",eps);
    if (!ret) allOk=false;
    ret=matComp(db,*(grads["af-b"]),"AffineRelu db",eps);
    if (!ret) allOk=false;

    cppl_delete(&cache);
    cppl_delete(&grads);

    return allOk;
}

bool checkSoftmax(float eps=CP_DEFAULT_NUM_EPS) {
    bool allOk=true;
    MatrixN x(10,5);
    x << -5.53887846e-04,  -1.66357895e-05,   9.78587865e-04, -1.32038284e-03,   4.77159634e-04,
          9.20053947e-04,  -7.19330590e-05,  -5.98042560e-04, -2.20287950e-03,  -1.90102146e-03,
         -2.50299417e-04,   4.90923653e-04,  -1.20710791e-04, -1.59583803e-03,   7.76216493e-04,
          5.69312741e-04,   1.04067712e-03,   7.80831584e-04, 1.59436445e-04,  -4.02010213e-04,
         -1.92711171e-04,   4.38969012e-04,   3.51890037e-04, 8.72617659e-04,  -2.67204717e-04,
         -1.93907739e-04,   5.80622659e-05,  -1.35256160e-03, 6.45579573e-04,   3.07149694e-04,
          7.88018217e-05,  -5.08851258e-04,  -5.68082221e-04, -9.08716816e-04,  -4.28502983e-04,
         -7.81674859e-05,   2.58156281e-04,   9.68529476e-04, 7.02486610e-04,   1.02575914e-03,
          7.97130342e-04,  -7.56924427e-04,  -5.05724689e-05, -4.83491308e-04,   5.32065794e-04,
         -4.82766795e-04,   5.50968630e-05,   5.90486482e-04, 4.08029314e-04,   2.16114208e-04;
    MatrixN y(10,1);
    y << 2, 2, 1, 4, 2, 3, 2, 3, 4, 1;
    MatrixN probs(10,5);
    probs << 0.19990659,  0.20001402,  0.20021317,  0.19975342,  0.20011281,
             0.20033832,  0.20013968,  0.20003441,  0.19971365,  0.19977394,
             0.19997786,  0.20012615,  0.20000378,  0.19970897,  0.20018325,
             0.20002791,  0.20012222,  0.20007022,  0.19994594,  0.19983371,
             0.19991332,  0.20003964,  0.20002222,  0.2001264 ,  0.19989842,
             0.1999826 ,  0.200033  ,  0.19975102,  0.20015055,  0.20008283,
             0.20010919,  0.19999163,  0.19997979,  0.19991168,  0.2000077 ,
             0.19986932,  0.19993655,  0.20007863,  0.20002541,  0.20009008,
             0.20015793,  0.19984711,  0.19998832,  0.19990176,  0.20010488,
             0.199872  ,  0.19997953,  0.20008662,  0.20005012,  0.20001173;
    floatN loss=1.60920315915;
    MatrixN dx(10,5);
    dx << 0.01999066,  0.0200014 , -0.07997868,  0.01997534,  0.02001128,
          0.02003383,  0.02001397, -0.07999656,  0.01997136,  0.01997739,
          0.01999779, -0.07998739,  0.02000038,  0.0199709 ,  0.02001832,
          0.02000279,  0.02001222,  0.02000702,  0.01999459, -0.08001663,
          0.01999133,  0.02000396, -0.07999778,  0.02001264,  0.01998984,
          0.01999826,  0.0200033 ,  0.0199751 , -0.07998494,  0.02000828,
          0.02001092,  0.01999916, -0.08000202,  0.01999117,  0.02000077,
          0.01998693,  0.01999366,  0.02000786, -0.07999746,  0.02000901,
          0.02001579,  0.01998471,  0.01999883,  0.01999018, -0.07998951,
          0.0199872 , -0.08000205,  0.02000866,  0.02000501,  0.02000117;

    Softmax sm("{inputShape=[5]}");
    t_cppl cache;
    t_cppl grads;
    MatrixN probs0=sm.forward(x, y, &cache);
    bool ret=matComp(probs,probs0,"Softmax probabilities",eps);
    if (!ret) allOk=false;
    floatN loss0=sm.loss(y, &cache);
    floatN d=loss-loss0;
    floatN err=std::abs(d);
    if (err > eps) {
        cerr << "Loss error: correct:" << loss << " got: " << loss0 << ", err=" << err << endl;
        allOk=false;
    } else {
        cerr << "Loss ok, loss=" << loss0 << " (ref: " << loss << "), err=" << err << endl;
    }
    //MatrixN dchain=x;
    //dchain.setOnes();
    MatrixN dx0=sm.backward(y, &cache, &grads);
    ret=matComp(dx,dx0,"Softmax dx",eps);
    if (!ret) allOk=false;
    cppl_delete(&grads);
    cppl_delete(&cache);
    return allOk;
}


bool checkSvm(float eps=CP_DEFAULT_NUM_EPS) {
    bool allOk=true;
    MatrixN x(10,5);
    x << 2.48040968e-04,   5.60446668e-04,  -3.52994957e-04,
         1.01572982e-03,   4.14494264e-04,
        -6.31693635e-04,  -8.15563788e-04,  -1.20636602e-03,
         -2.10174557e-03,   5.53294928e-04,
          1.14679595e-03,   1.24827753e-03,  -6.61989763e-04,
          9.55559461e-04,  -4.28180029e-04,
          4.46347111e-04,   6.23103141e-04,  -8.31752231e-04,
         -8.16901550e-04,  -3.51481858e-04,
          5.99420847e-04,   7.99136992e-04,   7.48694922e-04,
         -1.31792142e-03,  -1.41278790e-03,
          7.83720049e-04,  -1.87400705e-03,   6.83413931e-04,
         -3.33278182e-05,  -8.23791353e-04,
          4.48433013e-04,  -1.90826829e-04,  -1.18725164e-03,
          8.57369270e-04,  -2.03127259e-04,
         -8.12742999e-04,  -8.77664600e-04,   9.59702869e-04,
         -4.21470554e-05,  -1.26450252e-04,
          7.75822790e-04,  -9.17338786e-04,   6.60689034e-04,
          2.50740181e-04,   1.58892909e-03,
         -1.07719599e-03,  -1.12323192e-04,   7.62566128e-06,
         -2.26193130e-04,   9.21699517e-04;
    MatrixN y(10,1);
    y << 2, 3, 0, 2, 4, 3, 1, 0, 1, 4;
    MatrixN margins(10,5);
    margins << 1.00060104,  1.00091344,  0.        ,  1.00136872,  1.00076749,
               1.00147005,  1.00128618,  1.00089538,  0.        ,  1.00265504,
               0.        ,  1.00010148,  0.99819121,  0.99980876,  0.99842502,
               1.0012781 ,  1.00145486,  0.        ,  1.00001485,  1.00048027,
               1.00201221,  1.00221192,  1.00216148,  1.00009487,  0.        ,
               1.00081705,  0.99815932,  1.00071674,  0.        ,  0.99920954,
               1.00063926,  0.        ,  0.99900358,  1.0010482 ,  0.9999877 ,
               0.        ,  0.99993508,  1.00177245,  1.0007706 ,  1.00068629,
               1.00169316,  0.        ,  1.00157803,  1.00116808,  1.00250627,
               0.9980011 ,  0.99896598,  0.99908593,  0.99885211,  0.;
    floatN loss=4.00207888295;
    MatrixN dx(10,5);
    dx << 0.1,  0.1, -0.4,  0.1,  0.1,
          0.1,  0.1,  0.1, -0.4,  0.1,
         -0.4,  0.1,  0.1,  0.1,  0.1,
          0.1,  0.1, -0.4,  0.1,  0.1,
          0.1,  0.1,  0.1,  0.1, -0.4,
          0.1,  0.1,  0.1, -0.4,  0.1,
          0.1, -0.4,  0.1,  0.1,  0.1,
         -0.4,  0.1,  0.1,  0.1,  0.1,
          0.1, -0.4,  0.1,  0.1,  0.1,
          0.1,  0.1,  0.1,  0.1, -0.4;

    Svm sv("{inputShape=[5]}");
    t_cppl cache;
    t_cppl grads;
    MatrixN margins0=sv.forward(x, y, &cache);
    bool ret=matComp(margins,margins0,"Svm probabilities",eps);
    if (!ret) allOk=false;
    floatN loss0=sv.loss(y, &cache);
    floatN d=loss-loss0;
    floatN err=std::abs(d);
    if (err > eps) {
        cerr << "Loss error: correct:" << loss << " got: " << loss0 << ", err=" << err << endl;
        allOk=false;
    } else {
        cerr << "Loss ok, loss=" << loss0 << " (ref: " << loss << "), err=" << err << endl;
    }
    MatrixN dx0=sv.backward(y, &cache, &grads);
    ret=matComp(dx,dx0,"Softmax dx",eps);
    if (!ret) allOk=false;
    cppl_delete(&grads);
    cppl_delete(&cache);
    return allOk;
}

bool checkTwoLayer(float eps=CP_DEFAULT_NUM_EPS) {
    bool allOk=true;   // N=3, D=5, H=4, C=2
    int N=3, D=5, H=4, C=2;
    MatrixN x(N,D);
    x << -5.5       , -3.35714286, -1.21428571,  0.92857143,  3.07142857,
         -4.78571429, -2.64285714, -0.5       ,  1.64285714,  3.78571429,
         -4.07142857, -1.92857143,  0.21428571,  2.35714286,  4.5;
    MatrixN yc(N,1);
    yc << 0, 1, 1;
    MatrixN W1(D,H);
    W1 << -0.7       , -0.64736842, -0.59473684, -0.54210526,
          -0.48947368, -0.43684211, -0.38421053, -0.33157895,
          -0.27894737, -0.22631579, -0.17368421, -0.12105263,
          -0.06842105, -0.01578947,  0.03684211,  0.08947368,
           0.14210526,  0.19473684,  0.24736842,  0.3;
    MatrixN b1(1,H);
    b1 << -0.1       ,  0.23333333,  0.56666667,  0.9;
    MatrixN W2(H,C);
    W2 << -0.3, -0.2,
          -0.1,  0.,
           0.1,  0.2,
           0.3,  0.4;
    MatrixN b2(1,C);
    b2 << -0.9,  0.1;

    MatrixN sc(N,C); // Scores
    sc << -0.88621554,  2.56401003,
         -0.69824561,  2.46626566,
         -0.51027569,  2.3685213;

    CpParams cp;
    cp.setPar("inputShape",vector<int>{D});
    cp.setPar("hidden",vector<int>{H,C});
    TwoLayerNet tln(cp);

    *(tln.params["af1-W"])=W1;
    *(tln.params["af1-b"])=b1;
    *(tln.params["af2-W"])=W2;
    *(tln.params["af2-b"])=b2;

    t_cppl cache;
    t_cppl grads;
    MatrixN sc0=tln.forward(x,yc,&cache);
    bool ret=matComp(sc,sc0,"TwoLayerNetScores",eps);
    if (!ret) allOk=false;

    MatrixN dW1(D,H);
    dW1 << -0.16400759, -0.16400759, -0.16400759, -0.16400759,
           -0.10147167, -0.10147167, -0.10147167, -0.10147167,
           -0.03893575, -0.03893575, -0.03893575, -0.03893575,
            0.02360017,  0.02360017,  0.02360017,  0.02360017,
            0.08613609,  0.08613609,  0.08613609,  0.08613609;
    MatrixN db1(1,H);
    db1 << 0.02918343,  0.02918343,  0.02918343,  0.02918343;
    MatrixN dW2(H,C);
    dW2 << -1.83041352,  1.83041352,
           -1.82522911,  1.82522911,
           -1.8200447 ,  1.8200447 ,
           -1.81486029,  1.81486029;
    MatrixN db2(1,C);
    db2 << -0.29183429,  0.29183429;

    // XXX reg parameter
    floatN reg=0.0;
    floatN ls = tln.loss(yc,&cache);
    floatN lsc = 1.1925059294331903;
    floatN lse=std::abs(ls-lsc);
    if (lse < eps) {
        cerr << "TwoLayerNet: loss-err: " << lse << " for reg=" << reg << " OK." << endl;
    } else {
        cerr << "TwoLayerNet: loss-err: " << lse << " for reg=" << reg << " incorrect: " << ls << ", expected: " << lsc << endl;
        allOk=false;
    }
    MatrixN dx0=tln.backward(yc,&cache,&grads);

    cerr << "Got grads: ";
    for (auto gi : grads) {
        cerr << gi.first << " ";
    }
    cerr << endl;
    ret=matComp(dW1,*(grads["af1-W"]),"TwoLayerNet dW1",eps);
    if (!ret) allOk=false;
    ret=matComp(db1,*(grads["af1-b"]),"TwoLayerNet db1",eps);
    if (!ret) allOk=false;
    ret=matComp(dW2,*(grads["af2-W"]),"TwoLayerNet dW2",eps);
    if (!ret) allOk=false;
    ret=matComp(db2,*(grads["af2-b"]),"TwoLayerNet db2",eps);
    if (!ret) allOk=false;

    cppl_delete(&cache);
    cppl_delete(&grads);
    return allOk;
}

bool checkRNNStepForward(floatN eps=CP_DEFAULT_NUM_EPS) {
    MatrixN x(3,10);     // N, D, H = 3, 10, 4
    x << -0.4       , -0.36206897, -0.32413793, -0.2862069 , -0.24827586,
        -0.21034483, -0.17241379, -0.13448276, -0.09655172, -0.05862069,
        -0.02068966,  0.01724138,  0.05517241,  0.09310345,  0.13103448,
         0.16896552,  0.20689655,  0.24482759,  0.28275862,  0.32068966,
         0.35862069,  0.39655172,  0.43448276,  0.47241379,  0.51034483,
         0.54827586,  0.5862069 ,  0.62413793,  0.66206897,  0.7;
    MatrixN Wxh(10,4);
    MatrixN Whh(4,4);
    Wxh << -0.1       , -0.07435897, -0.04871795, -0.02307692,
         0.0025641 ,  0.02820513,  0.05384615,  0.07948718,
         0.10512821,  0.13076923,  0.15641026,  0.18205128,
         0.20769231,  0.23333333,  0.25897436,  0.28461538,
         0.31025641,  0.33589744,  0.36153846,  0.38717949,
         0.41282051,  0.43846154,  0.46410256,  0.48974359,
         0.51538462,  0.54102564,  0.56666667,  0.59230769,
         0.61794872,  0.64358974,  0.66923077,  0.69487179,
         0.72051282,  0.74615385,  0.77179487,  0.7974359 ,
         0.82307692,  0.84871795,  0.87435897,  0.9;
    Whh << -0.3       , -0.23333333, -0.16666667, -0.1,
        -0.03333333,  0.03333333,  0.1       ,  0.16666667,
         0.23333333,  0.3       ,  0.36666667,  0.43333333,
         0.5       ,  0.56666667,  0.63333333,  0.7;
    MatrixN bh(1,4);
    bh << -2.00000000e-01,   2.77555756e-17,   2.00000000e-01,
         4.00000000e-01;
    MatrixN hn(3,4);
    hn << -0.58172089, -0.50182032, -0.41232771, -0.31410098,
         0.66854692,  0.79562378,  0.87755553,  0.92795967,
         0.97934501,  0.99144213,  0.99646691,  0.99854353;
    MatrixN h(3,4);
    h << -0.2       , -0.13636364, -0.07272727, -0.00909091,
        0.05454545,  0.11818182,  0.18181818,  0.24545455,
        0.30909091,  0.37272727,  0.43636364,  0.5;

    RNN rnn("{inputShape=[10,1];H=4;N=3}");
    *(rnn.params["Wxh"])= Wxh;
    *(rnn.params["Whh"])= Whh;
    *(rnn.params["bh"])=bh;
    t_cppl cache;
    cppl_set(&cache,"h",new MatrixN(h));
    MatrixN hn0=rnn.forward_step(x, &cache, 0);
    cppl_delete(&cache);
    return matComp(hn,hn0,"RNNForwardStep",eps);
}

bool checkRNNStepBackward(float eps=CP_DEFAULT_NUM_EPS) {
    MatrixN x(4,5);     // N, D, H = 4, 5, 6
    x << .12416358,  1.69843114,  0.26088349,  0.61809901,  1.29498102,
         1.04395433,  0.345587  ,  1.82379102,  0.67565083,  1.19980857,
        -0.48936451,  1.3795558 , -0.44039028, -0.98906461,  0.11292283,
         0.10746271, -0.82250932, -0.94761786, -2.23684026,  0.3908439;
    MatrixN Wxh(5,6);
    Wxh << -1.64795906,  1.55945931,  1.1616202 ,  0.22775023,  1.12451202,
         0.98383165,
         0.24272267, -0.40812982,  0.6039808 , -0.53279051,  0.66677079,
        -1.47248404,
        -2.08350468, -1.6813117 , -0.27377932, -0.07012035,  1.5234011 ,
         0.86024426,
         1.23121803,  0.51911896,  0.91276421,  0.20830086, -0.5131898 ,
         1.41621487,
        -0.63816806, -1.15880041,  1.24110808,  0.71208072, -0.26885643,
        -0.08518922;
    MatrixN Whh(6,6);
    Whh << 0.16756294, -1.00421206, -0.55025714,  0.9548442 , -2.18848119,
        -0.21309667,
         0.91026643,  1.28894004, -0.05304641,  0.69584409, -2.08627571,
        -1.38057313,
        -0.41090696, -0.26789992,  0.80390613,  1.5490817 , -0.43289072,
         3.17763158,
         0.54785261,  0.33228893,  0.33076176, -1.98406491, -0.08705545,
         1.33665719,
         0.18163407, -1.24020649,  0.86931067,  0.24373755, -0.637415  ,
        -0.49735824,
        -0.2467502 ,  0.28155415, -0.4062929 , -0.41010748, -0.33394647,
         0.99012546;
    MatrixN bh(1,6);
    bh <<  -2.24794308, -0.62115254,  0.3501973 , -0.01646389,  0.194781  ,
       -0.25476446;
    MatrixN h(4,6);
    h << 0.20024643,  1.40404312,  0.90177809, -1.23836782,  0.45040351,
         0.30889824,
        -0.09773321,  0.95785224,  0.59524814,  0.37567379,  0.67724748,
        -0.17839568,
         0.82151731, -2.16273274, -0.09992387, -0.35646773,  0.45099308,
         0.82678519,
        -0.94719149,  0.33138745, -1.53005522, -0.35261536,  0.29428635,
         1.49343694;

    MatrixN dx(4,5);
    dx << 0.05355669,  0.00464208, -0.06477791, -0.01111023, -0.0360655 ,
         0.50184965,  0.34297347,  0.83113146, -0.27801017, -0.06762191,
        -0.72487278, -0.46041568,  0.21955765, -0.55215642, -0.81686803,
        -0.46403852, -0.13747293, -0.20508103,  0.07899213,  0.20784653;
    MatrixN dWxh(5,6);
    dWxh << 4.16418675e-04,  -5.13777667e-02,   3.24080758e-01,
          2.35841191e-02,   4.95674789e-01,  -2.33743709e-02,
         -2.05667097e-02,   1.41571185e-01,  -9.09284030e-01,
          5.45687584e-04,   3.77206048e-01,   2.37304013e-02,
         -6.98110649e-03,   3.90700222e-02,   2.96873214e-01,
          1.32621137e-02,   1.15021702e+00,  -2.59606027e-02,
         -1.65688000e-02,   2.45353911e-01,   6.66110961e-01,
         -5.87466851e-02,   8.93706625e-01,  -4.89838207e-02,
         -8.18931445e-03,  -4.55617030e-02,  -7.57228635e-02,
          4.23928761e-02,   5.01266495e-01,  -1.98823763e-02;
    MatrixN dWhh(6,6);
    dWhh << -0.00848549,  0.11776217, -0.53975722, -0.0203512 ,  0.18871361,
         0.02795506,
        -0.00581244, -0.02458641,  1.43203792,  0.0087548 ,  0.38935482,
        -0.10644723,
        -0.01606056,  0.1802694 ,  0.073881  , -0.03033707,  0.67807337,
        -0.01986724,
         0.00834544, -0.02302092,  0.23743425, -0.00472736,  0.27917948,
         0.00529606,
        -0.0025646 , -0.04454486, -0.29973302,  0.03047122,  0.26617567,
         0.0078099 ,
         0.00505057, -0.14811397, -0.55461388,  0.04787431, -0.4614312 ,
         0.02665341;
    MatrixN dbh(1,6);
    dbh << -0.00364437, -0.1164864 , -0.66639534,  0.06503021,  0.25166159,
        0.01873921;
    MatrixN dh(4,6);
    dh << -0.03007664,  0.06901193, -0.05617264, -0.01267693, -0.03818692,
        -0.002447  ,
        -1.03171308, -1.08006156, -0.17614215, -0.11097753, -0.25979309,
        -0.19269291,
         0.36227216, -0.01487735, -0.395828  , -0.1925051 , -0.59349363,
         0.30134821,
         0.68991653,  0.40216012,  0.17646913, -0.07084702,  0.30209163,
         0.04048871;

    MatrixN dchain(4,6);
    dchain << -0.23699244,  0.87596245,  0.29952303, -0.51286232, -0.20223674,
        -0.43225121,
        -0.31857928, -3.06145789,  0.91069566,  0.28754103,  1.82427869,
        -0.49471658,
        -0.51559122, -0.02988897, -0.84745675,  0.04859102,  0.10035852,
         0.47915608,
         1.30290015, -0.72761588, -0.17990189,  1.2176583 , -0.42103704,
         0.61638331;
    RNN rnn("{inputShape=[5,1];H=6;N=4}");
    *(rnn.params["Wxh"])=Wxh;
    *(rnn.params["Whh"])=Whh;
    *(rnn.params["bh"])=bh;
    t_cppl cache;
    t_cppl grads;
    cppl_set(&cache,"h",new MatrixN(h));
    MatrixN y=rnn.forward_step(x, &cache);
    MatrixN dx0=rnn.backward_step(dchain, &cache, &grads);
    bool allOk=true;
    bool ret=matComp(dx,dx0,"RNNStepBackward dx",eps);
    if (!ret) allOk=false;
    ret=matComp(dWxh,*(grads["Wxh"]),"RNNStepBackward dWxh",eps);
    if (!ret) allOk=false;
    ret=matComp(dWhh,*(grads["Whh"]),"RNNStepBackward dWhh",eps);
    if (!ret) allOk=false;
    ret=matComp(dbh,*(grads["bh"]),"RNNStepBackward bh",eps);
    if (!ret) allOk=false;
    ret=matComp(dh,*(grads["ho"]),"RNNStepBackward h",eps);
    if (!ret) allOk=false;
    cppl_delete(&cache);
    cppl_delete(&grads);
    return allOk;
}

bool checkRNNForward(floatN eps=CP_DEFAULT_NUM_EPS) {
    MatrixN x(2,12);   // N, T, D, H = 2, 3, 4, 5
    x << -0.1       , -0.0826087 , -0.06521739, -0.04782609,
         -0.03043478, -0.01304348,  0.00434783,  0.02173913,
          0.03913043,  0.05652174,  0.07391304,  0.09130435,

          0.10869565,  0.12608696,  0.14347826,  0.16086957,
          0.17826087,  0.19565217,  0.21304348,  0.23043478,
          0.24782609,  0.26521739,  0.2826087 ,  0.3;
    MatrixN Wxh(4,5);
    MatrixN Whh(5,5);
    Wxh << -0.2       , -0.16842105, -0.13684211, -0.10526316, -0.07368421,
        -0.04210526, -0.01052632,  0.02105263,  0.05263158,  0.08421053,
         0.11578947,  0.14736842,  0.17894737,  0.21052632,  0.24210526,
         0.27368421,  0.30526316,  0.33684211,  0.36842105,  0.4;
    Whh << -0.4       , -0.37916667, -0.35833333, -0.3375    , -0.31666667,
        -0.29583333, -0.275     , -0.25416667, -0.23333333, -0.2125    ,
        -0.19166667, -0.17083333, -0.15      , -0.12916667, -0.10833333,
        -0.0875    , -0.06666667, -0.04583333, -0.025     , -0.00416667,
         0.01666667,  0.0375    ,  0.05833333,  0.07916667,  0.1;
    MatrixN bh(1,5);
    bh << -0.7, -0.5, -0.3, -0.1,  0.1;
    MatrixN h0(2,5);
    h0 << -0.3       , -0.25555556, -0.21111111, -0.16666667, -0.12222222,
        -0.07777778, -0.03333333,  0.01111111,  0.05555556,  0.1;
    MatrixN hn(2,15);
    hn << -0.42070749, -0.27279261, -0.11074945,  0.05740409,  0.22236251,
         -0.39525808, -0.22554661, -0.0409454 ,  0.14649412,  0.32397316,
         -0.42305111, -0.24223728, -0.04287027,  0.15997045,  0.35014525,

         -0.55857474, -0.39065825, -0.19198182,  0.02378408,  0.23735671,
         -0.27150199, -0.07088804,  0.13562939,  0.33099728,  0.50158768,
         -0.51014825, -0.30524429, -0.06755202,  0.17806392,  0.40333043;

//                        D,T
    RNN rnn("{inputShape=[4,3];H=5;N=2}");
    *(rnn.params["Wxh"])= Wxh;
    *(rnn.params["Whh"])= Whh;
    *(rnn.params["bh"])=bh;
    *(rnn.params)["ho"]=h0;
    t_cppl cache;
    MatrixN hn0=rnn.forward(x, &cache, 0);
    cppl_delete(&cache);
    return matComp(hn,hn0,"RNNForward",eps);
}

bool checkRNNBackward(float eps=CP_DEFAULT_NUM_EPS) {
    MatrixN x(2,30);   // N, D, T, H = 2, 3, 10, 5
    x << 1.42672007, -0.31937729, -0.86722593,
         -0.3784268 ,  0.87693254,  0.2210269 ,
         -1.08824345, -0.64407614,  1.43759927,
          0.28193136,  0.90717448,  1.25334125,
          2.39574773, -0.53590331, -0.50877974,
          0.27627503, -1.54064355,  1.32773898,
          1.07066922,  0.47327451,  1.29784147,
          0.653452  ,  0.70564059, -0.5578014 ,
          0.91983003, -0.2737394 ,  1.35892918,
          0.14778309,  0.98816614, -0.45552004,

         -0.87659908, -0.13201754,  1.06957197,
         -1.73428816, -1.13787752, -0.32563472,
          0.3202495 ,  0.13322343, -0.23705645,
          0.58770287,  0.07230072,  0.46665993,
         -0.29843096,  1.1122521 , -1.04458566,
         -0.84414253,  1.29579053,  0.85666362,
          1.01854585, -1.18368473,  0.93243884,
         -1.04041553, -1.12849339, -1.16842107,
          0.73113213,  0.85136499, -0.75428242,
         -0.39766453, -0.80114799,  0.31273153;
    MatrixN Wxh(3,5);
    Wxh << -0.12927579,  0.02471624,  1.61513095,  1.3376178 , -0.30023422,
         0.18728971,  0.88365881, -1.86947193, -1.57685207, -1.88697211,
        -0.42622774,  0.24390712, -0.30269361, -0.82475517,  0.43530684;
    MatrixN Whh(5,5);
    Whh << -0.81872798,  1.75444781,  0.08371593,  0.31629015, -1.63821244,
         1.85686335,  0.93631439, -0.53924214,  2.10224397,  0.83180435,
        -0.96315752, -0.66511744, -0.51743317,  0.4169285 ,  1.24867564,
         1.11834023,  0.61104288, -0.44082918,  0.05147677, -0.14183355,
         1.95697013,  1.58587945,  0.42601047, -0.38505994,  0.5758465;
    MatrixN bh(1,5);
    bh <<  -0.10951104,  0.24564546, -0.04626534,  0.68796566, -0.39304148;
    MatrixN h0(2,5);
    h0 << -0.20544637, -2.39043536, -0.33572273, -1.18048126,  0.2297227 ,
         0.00381195,  0.03485593,  0.45290272,  0.79040557,  0.53839077;

    MatrixN dx(2,30);
    dx << 2.83128334e-01,  -1.54396850e-01,  -2.03125890e-01,
           6.94499354e-01,   3.01747775e+00,  -7.83933285e-01,
          -3.85263109e+00,   4.52928685e+00,   6.59063543e-01,
           6.76851234e-01,   3.60756930e+00,  -1.36185681e+00,
           2.27191281e-01,   1.56398512e+00,  -2.25846567e-01,
           2.90811795e+00,  -3.40271758e+00,  -1.94746068e+00,
           3.53118649e+00,  -2.14451558e+00,  -1.07039645e+00,
           1.09935009e+00,  -2.13232708e+00,  -4.05936258e-01,
          -3.89871631e-02,   7.22680234e-02,   6.76815753e-02,
          -6.16315132e-01,  -2.11488618e+00,   6.61024864e-01,

           4.46130762e-01,   7.74248100e-02,  -4.61603013e-01,
          -3.38102735e+00,   4.42030626e+00,   5.70856460e-01,
           4.12266541e-01,  -9.11480589e-01,  -4.26059339e-03,
           4.32154518e-01,  -4.01449803e-01,   1.16172226e-03,
          -2.04333431e-01,   1.02275556e-01,   9.03355839e-02,
           2.19409870e-01,  -3.08578310e-01,   6.37864318e-01,
          -8.13136499e-01,  -4.82807046e+00,   1.06850626e+00,
           1.46153717e+00,  -1.68080991e+00,  -2.90687490e-01,
          -6.82187205e-01,   7.73966451e-01,   4.48969735e-01,
          -5.41287668e-01,   3.53712331e-01,   1.45758858e-02;
    MatrixN dWxh(3,5);
    dWxh << 1.41100052,  2.30220308,  7.29105998,  1.65324031,  1.71677344,
        -2.28393701,  0.57435196,  3.80965606, -2.81654354, -4.2065373 ,
         2.74039663,  0.8240278 , -0.38057752,  2.63125111, -1.8409216;
    MatrixN dWhh(5,5);
    dWhh << -4.0249321 , -1.58481823, -2.12826938, -2.49071418,  5.26850575,
        -3.077585  , -1.63456328, -0.69028048, -3.26015838,  6.25998547,
         3.13983089,  1.40499983,  7.08516274,  3.32499551, -3.39536687,
        -0.81957002,  0.92643005,  6.71996282,  0.39861412,  3.64331512,
         2.55450033,  1.99612196,  0.10288017,  1.84617216, -1.71983855;
    MatrixN dbh(1,5);
    dbh << -0.43575312,  1.35447753, -2.15414294,  4.02873156, -0.87407764;
    MatrixN dh0(2,5);
    dh0 << 0.16711121,  0.31080126, -0.01686812,  0.00980601, -0.1593779 ,
         0.37557634,  1.14471162, -0.53727051,  0.46902922,  0.55879207;

    MatrixN dchain(2,50);
    dchain << -0.12362327, -0.5674421 ,  0.8745609 ,  0.99932555, -1.63738807,
         -0.1352751 , -1.2843702 ,  2.3930869 , -0.08575731, -0.91934747,
          0.47303269, -0.3042664 ,  0.38503377,  0.01363704,  0.80027367,
          0.35418033, -0.26913838,  1.0614795 ,  0.13038746, -1.94323539,
         -0.900087  ,  1.14850186,  0.29905769, -1.92197358, -0.20150144,
         -0.37826346,  0.54382004,  0.15650663,  1.40933799,  2.09452943,
          0.41538121, -1.56705624,  0.92238285, -0.48502851,  0.07744951,
         -1.06722454,  0.79639577, -1.0321276 ,  1.77888984,  1.17946414,
          0.33070105, -1.46128781, -1.5602019 ,  0.58954647, -1.37958465,
          1.3165491 ,  0.23054624, -0.60895932, -0.70316943,  1.47789572,

          0.69971466, -0.3180744 , -0.69633622, -0.14756601,  0.08137661,
         -0.62384849, -0.78764898, -2.25953134, -0.18996891, -0.79340542,
          0.84748535, -0.72047164,  0.28052885, -0.24627851,  0.98943121,
          0.00872582, -0.57133626,  0.24619932, -0.19455666, -1.29171457,
         -1.31839253,  0.17045328, -0.29057405, -0.09411389, -0.6696823 ,
          0.74507544, -0.21036976,  0.62691113,  0.12732844,  0.76161537,
          0.89503194,  0.50062137,  0.02643405, -0.89958641,  2.1985117 ,
         -0.05634623,  1.31969603,  0.6188371 , -1.31854328, -1.27689832,
         -1.37433812,  0.19777929, -0.91821752, -0.54890713, -0.72215917,
         -1.38988503, -0.43959209, -0.33943549,  1.15280127, -0.06320341;
//                        D,T
    RNN rnn("{inputShape=[3,10];H=5;N=2}");   //inputShape=D, hidden=H
    *(rnn.params["Wxh"])=Wxh;
    *(rnn.params["Whh"])=Whh;
    *(rnn.params["bh"])=bh;
    *(rnn.params["ho"])=h0;

    t_cppl cache;
    t_cppl grads;
    MatrixN y=rnn.forward(x, &cache);
    // for (auto ci : cache) cerr << ci.first << shape(*(ci.second))<< " ";
    //cerr << endl;
    MatrixN dx0=rnn.backward(dchain, &cache, &grads);
    bool allOk=true;
    bool ret=matComp(dx,dx0,"RNNBackward dx",eps);
    if (!ret) allOk=false;
    ret=matComp(dWxh,*(grads["Wxh"]),"RNNBackward dWxh",eps);
    if (!ret) allOk=false;
    ret=matComp(dWhh,*(grads["Whh"]),"RNNBackward dWhh",eps);
    if (!ret) allOk=false;
    ret=matComp(dbh,*(grads["bh"]),"RNNBackward bh",eps);
    if (!ret) allOk=false;
    ret=matComp(dh0,*(grads["ho"]),"RNNBackward h",eps);
    if (!ret) allOk=false;

    cppl_delete(&cache);
    //for (auto ci : cache) {
    //    cerr << ci.first << " ";
    //}
    //cerr << endl;
    cppl_delete(&grads);
    return allOk;
}

bool checkWordEmbeddingForward(floatN eps=CP_DEFAULT_NUM_EPS) {
    MatrixN x(2,4);  // N, T, V, D = 2, 4, 5, 3
    x << 0, 3, 1, 2,
         2, 1, 0, 3;
    MatrixN W(5,3);
    W << 0.        ,  0.07142857,  0.14285714,
         0.21428571,  0.28571429,  0.35714286,
         0.42857143,  0.5       ,  0.57142857,
         0.64285714,  0.71428571,  0.78571429,
         0.85714286,  0.92857143,  1.;
    MatrixN y(2,12);
    y << 0.        ,  0.07142857,  0.14285714,
         0.64285714,  0.71428571,  0.78571429,
         0.21428571,  0.28571429,  0.35714286,
         0.42857143,  0.5       ,  0.57142857,

         0.42857143,  0.5       ,  0.57142857,
         0.21428571,  0.28571429,  0.35714286,
         0.        ,  0.07142857,  0.14285714,
         0.64285714,  0.71428571,  0.78571429;

    CpParams cp("{inputShape=[4];V=5;D=3}");
    WordEmbedding we(cp);
    *(we.params["W"])= W;
    t_cppl cache;
    MatrixN y0=we.forward(x, &cache, 0);
    cppl_delete(&cache);
    return matComp(y,y0,"WordEmbeddingForward",eps);
}


bool checkWordEmbeddingBackward(float eps=CP_DEFAULT_NUM_EPS) {
    MatrixN x(50,3);   // N, T, V, D = 50, 3, 5, 6
    x << 2, 2, 4,       2, 2, 3,       2, 2, 4,       4, 3, 3,       3, 2, 2,
       1, 4, 1,       3, 3, 3,       4, 4, 3,       1, 1, 4,       2, 2, 2,
       2, 0, 1,       0, 2, 4,       3, 3, 2,       2, 2, 1,       3, 4, 3,
       2, 0, 4,       0, 1, 1,       0, 2, 3,       0, 3, 3,       2, 1, 1,
       3, 3, 1,       2, 3, 2,       4, 0, 4,       4, 1, 2,       0, 2, 3,
       2, 4, 3,       3, 2, 1,       2, 2, 3,       0, 2, 4,       1, 0, 1,
       3, 0, 4,       1, 2, 1,       2, 2, 1,       2, 2, 3,       1, 4, 0,
       3, 1, 4,       3, 2, 0,       4, 3, 0,       3, 0, 2,       4, 1, 4,
       3, 0, 0,       0, 2, 0,       4, 0, 3,       0, 3, 1,       2, 4, 3,
       4, 3, 3,       3, 0, 1,       2, 1, 2,       3, 1, 3,       4, 2, 0;
    MatrixN W(5,6);
    W << 1.18430336,  1.31756768, -0.06487105,  0.1958007 ,  1.16720325, -1.34495095,
       -1.1158534 , -0.26445229, -1.27061146, -0.10336515,  1.45402224, -0.1962724 ,
        0.87099429,  2.71394073, -0.56817905,  0.2253223 ,  1.24964303, 1.39740524,
       -0.44248965,  0.51079833, -0.80662343,  2.64545322, -1.02161667, -1.59424371,
       -0.35918011,  0.95326196,  1.11169519,  0.86099973,  0.65080126, 0.51127197;
    MatrixN y(50,18);
    y << 0.87099429,  2.71394073, -0.56817905,  0.2253223 ,  1.24964303, 1.39740524,
         0.87099429,  2.71394073, -0.56817905,  0.2253223 ,  1.24964303, 1.39740524,
        -0.35918011,  0.95326196,  1.11169519,  0.86099973,  0.65080126, 0.51127197,

        0.87099429,  2.71394073, -0.56817905,  0.2253223 ,  1.24964303, 1.39740524,
         0.87099429,  2.71394073, -0.56817905,  0.2253223 ,  1.24964303, 1.39740524,
        -0.44248965,  0.51079833, -0.80662343,  2.64545322, -1.02161667, -1.59424371,

        0.87099429,  2.71394073, -0.56817905,  0.2253223 ,  1.24964303, 1.39740524,
         0.87099429,  2.71394073, -0.56817905,  0.2253223 ,  1.24964303, 1.39740524,
        -0.35918011,  0.95326196,  1.11169519,  0.86099973,  0.65080126, 0.51127197,

       -0.35918011,  0.95326196,  1.11169519,  0.86099973,  0.65080126, 0.51127197,
        -0.44248965,  0.51079833, -0.80662343,  2.64545322, -1.02161667, -1.59424371,
        -0.44248965,  0.51079833, -0.80662343,  2.64545322, -1.02161667, -1.59424371,

       -0.44248965,  0.51079833, -0.80662343,  2.64545322, -1.02161667, -1.59424371,
         0.87099429,  2.71394073, -0.56817905,  0.2253223 ,  1.24964303, 1.39740524,
         0.87099429,  2.71394073, -0.56817905,  0.2253223 ,  1.24964303, 1.39740524,

       -1.1158534 , -0.26445229, -1.27061146, -0.10336515,  1.45402224, -0.1962724 ,
        -0.35918011,  0.95326196,  1.11169519,  0.86099973,  0.65080126, 0.51127197,
        -1.1158534 , -0.26445229, -1.27061146, -0.10336515,  1.45402224, -0.1962724 ,

       -0.44248965,  0.51079833, -0.80662343,  2.64545322, -1.02161667, -1.59424371,
        -0.44248965,  0.51079833, -0.80662343,  2.64545322, -1.02161667, -1.59424371,
        -0.44248965,  0.51079833, -0.80662343,  2.64545322, -1.02161667, -1.59424371,

       -0.35918011,  0.95326196,  1.11169519,  0.86099973,  0.65080126, 0.51127197,
        -0.35918011,  0.95326196,  1.11169519,  0.86099973,  0.65080126, 0.51127197,
        -0.44248965,  0.51079833, -0.80662343,  2.64545322, -1.02161667, -1.59424371,

       -1.1158534 , -0.26445229, -1.27061146, -0.10336515,  1.45402224, -0.1962724 ,
        -1.1158534 , -0.26445229, -1.27061146, -0.10336515,  1.45402224, -0.1962724 ,
        -0.35918011,  0.95326196,  1.11169519,  0.86099973,  0.65080126, 0.51127197,

        0.87099429,  2.71394073, -0.56817905,  0.2253223 ,  1.24964303, 1.39740524,
         0.87099429,  2.71394073, -0.56817905,  0.2253223 ,  1.24964303, 1.39740524,
         0.87099429,  2.71394073, -0.56817905,  0.2253223 ,  1.24964303, 1.39740524,

        0.87099429,  2.71394073, -0.56817905,  0.2253223 ,  1.24964303, 1.39740524,
         1.18430336,  1.31756768, -0.06487105,  0.1958007 ,  1.16720325, -1.34495095,
        -1.1158534 , -0.26445229, -1.27061146, -0.10336515,  1.45402224, -0.1962724 ,

        1.18430336,  1.31756768, -0.06487105,  0.1958007 ,  1.16720325, -1.34495095,
         0.87099429,  2.71394073, -0.56817905,  0.2253223 ,  1.24964303, 1.39740524,
        -0.35918011,  0.95326196,  1.11169519,  0.86099973,  0.65080126, 0.51127197,

       -0.44248965,  0.51079833, -0.80662343,  2.64545322, -1.02161667, -1.59424371,
        -0.44248965,  0.51079833, -0.80662343,  2.64545322, -1.02161667, -1.59424371,
         0.87099429,  2.71394073, -0.56817905,  0.2253223 ,  1.24964303, 1.39740524,

        0.87099429,  2.71394073, -0.56817905,  0.2253223 ,  1.24964303, 1.39740524,
         0.87099429,  2.71394073, -0.56817905,  0.2253223 ,  1.24964303, 1.39740524,
        -1.1158534 , -0.26445229, -1.27061146, -0.10336515,  1.45402224, -0.1962724 ,

       -0.44248965,  0.51079833, -0.80662343,  2.64545322, -1.02161667, -1.59424371,
        -0.35918011,  0.95326196,  1.11169519,  0.86099973,  0.65080126, 0.51127197,
        -0.44248965,  0.51079833, -0.80662343,  2.64545322, -1.02161667, -1.59424371,

        0.87099429,  2.71394073, -0.56817905,  0.2253223 ,  1.24964303, 1.39740524,
         1.18430336,  1.31756768, -0.06487105,  0.1958007 ,  1.16720325, -1.34495095,
        -0.35918011,  0.95326196,  1.11169519,  0.86099973,  0.65080126, 0.51127197,

        1.18430336,  1.31756768, -0.06487105,  0.1958007 ,  1.16720325, -1.34495095,
        -1.1158534 , -0.26445229, -1.27061146, -0.10336515,  1.45402224, -0.1962724 ,
        -1.1158534 , -0.26445229, -1.27061146, -0.10336515,  1.45402224, -0.1962724 ,

        1.18430336,  1.31756768, -0.06487105,  0.1958007 ,  1.16720325, -1.34495095,
         0.87099429,  2.71394073, -0.56817905,  0.2253223 ,  1.24964303, 1.39740524,
        -0.44248965,  0.51079833, -0.80662343,  2.64545322, -1.02161667, -1.59424371,

        1.18430336,  1.31756768, -0.06487105,  0.1958007 ,  1.16720325, -1.34495095,
        -0.44248965,  0.51079833, -0.80662343,  2.64545322, -1.02161667, -1.59424371,
        -0.44248965,  0.51079833, -0.80662343,  2.64545322, -1.02161667, -1.59424371,

        0.87099429,  2.71394073, -0.56817905,  0.2253223 ,  1.24964303, 1.39740524,
        -1.1158534 , -0.26445229, -1.27061146, -0.10336515,  1.45402224, -0.1962724 ,
        -1.1158534 , -0.26445229, -1.27061146, -0.10336515,  1.45402224, -0.1962724 ,

       -0.44248965,  0.51079833, -0.80662343,  2.64545322, -1.02161667, -1.59424371,
        -0.44248965,  0.51079833, -0.80662343,  2.64545322, -1.02161667, -1.59424371,
        -1.1158534 , -0.26445229, -1.27061146, -0.10336515,  1.45402224, -0.1962724 ,

        0.87099429,  2.71394073, -0.56817905,  0.2253223 ,  1.24964303, 1.39740524,
        -0.44248965,  0.51079833, -0.80662343,  2.64545322, -1.02161667, -1.59424371,
         0.87099429,  2.71394073, -0.56817905,  0.2253223 ,  1.24964303, 1.39740524,

       -0.35918011,  0.95326196,  1.11169519,  0.86099973,  0.65080126, 0.51127197,
         1.18430336,  1.31756768, -0.06487105,  0.1958007 ,  1.16720325, -1.34495095,
        -0.35918011,  0.95326196,  1.11169519,  0.86099973,  0.65080126, 0.51127197,

       -0.35918011,  0.95326196,  1.11169519,  0.86099973,  0.65080126, 0.51127197,
        -1.1158534 , -0.26445229, -1.27061146, -0.10336515,  1.45402224, -0.1962724 ,
         0.87099429,  2.71394073, -0.56817905,  0.2253223 ,  1.24964303, 1.39740524,

        1.18430336,  1.31756768, -0.06487105,  0.1958007 ,  1.16720325, -1.34495095,
         0.87099429,  2.71394073, -0.56817905,  0.2253223 ,  1.24964303, 1.39740524,
        -0.44248965,  0.51079833, -0.80662343,  2.64545322, -1.02161667, -1.59424371,

        0.87099429,  2.71394073, -0.56817905,  0.2253223 ,  1.24964303, 1.39740524,
        -0.35918011,  0.95326196,  1.11169519,  0.86099973,  0.65080126, 0.51127197,
        -0.44248965,  0.51079833, -0.80662343,  2.64545322, -1.02161667, -1.59424371,

       -0.44248965,  0.51079833, -0.80662343,  2.64545322, -1.02161667, -1.59424371,
         0.87099429,  2.71394073, -0.56817905,  0.2253223 ,  1.24964303, 1.39740524,
        -1.1158534 , -0.26445229, -1.27061146, -0.10336515,  1.45402224, -0.1962724 ,

        0.87099429,  2.71394073, -0.56817905,  0.2253223 ,  1.24964303, 1.39740524,
         0.87099429,  2.71394073, -0.56817905,  0.2253223 ,  1.24964303, 1.39740524,
        -0.44248965,  0.51079833, -0.80662343,  2.64545322, -1.02161667, -1.59424371,

        1.18430336,  1.31756768, -0.06487105,  0.1958007 ,  1.16720325, -1.34495095,
         0.87099429,  2.71394073, -0.56817905,  0.2253223 ,  1.24964303, 1.39740524,
        -0.35918011,  0.95326196,  1.11169519,  0.86099973,  0.65080126, 0.51127197,

       -1.1158534 , -0.26445229, -1.27061146, -0.10336515,  1.45402224, -0.1962724 ,
         1.18430336,  1.31756768, -0.06487105,  0.1958007 ,  1.16720325, -1.34495095,
        -1.1158534 , -0.26445229, -1.27061146, -0.10336515,  1.45402224, -0.1962724 ,

       -0.44248965,  0.51079833, -0.80662343,  2.64545322, -1.02161667, -1.59424371,
         1.18430336,  1.31756768, -0.06487105,  0.1958007 ,  1.16720325, -1.34495095,
        -0.35918011,  0.95326196,  1.11169519,  0.86099973,  0.65080126, 0.51127197,

       -1.1158534 , -0.26445229, -1.27061146, -0.10336515,  1.45402224, -0.1962724 ,
         0.87099429,  2.71394073, -0.56817905,  0.2253223 ,  1.24964303, 1.39740524,
        -1.1158534 , -0.26445229, -1.27061146, -0.10336515,  1.45402224, -0.1962724 ,

        0.87099429,  2.71394073, -0.56817905,  0.2253223 ,  1.24964303, 1.39740524,
         0.87099429,  2.71394073, -0.56817905,  0.2253223 ,  1.24964303, 1.39740524,
        -1.1158534 , -0.26445229, -1.27061146, -0.10336515,  1.45402224, -0.1962724 ,

        0.87099429,  2.71394073, -0.56817905,  0.2253223 ,  1.24964303, 1.39740524,
         0.87099429,  2.71394073, -0.56817905,  0.2253223 ,  1.24964303, 1.39740524,
        -0.44248965,  0.51079833, -0.80662343,  2.64545322, -1.02161667, -1.59424371,

       -1.1158534 , -0.26445229, -1.27061146, -0.10336515,  1.45402224, -0.1962724 ,
        -0.35918011,  0.95326196,  1.11169519,  0.86099973,  0.65080126, 0.51127197,
         1.18430336,  1.31756768, -0.06487105,  0.1958007 ,  1.16720325, -1.34495095,

       -0.44248965,  0.51079833, -0.80662343,  2.64545322, -1.02161667, -1.59424371,
        -1.1158534 , -0.26445229, -1.27061146, -0.10336515,  1.45402224, -0.1962724 ,
        -0.35918011,  0.95326196,  1.11169519,  0.86099973,  0.65080126, 0.51127197,

       -0.44248965,  0.51079833, -0.80662343,  2.64545322, -1.02161667, -1.59424371,
         0.87099429,  2.71394073, -0.56817905,  0.2253223 ,  1.24964303, 1.39740524,
         1.18430336,  1.31756768, -0.06487105,  0.1958007 ,  1.16720325, -1.34495095,

       -0.35918011,  0.95326196,  1.11169519,  0.86099973,  0.65080126, 0.51127197,
        -0.44248965,  0.51079833, -0.80662343,  2.64545322, -1.02161667, -1.59424371,
         1.18430336,  1.31756768, -0.06487105,  0.1958007 ,  1.16720325, -1.34495095,

       -0.44248965,  0.51079833, -0.80662343,  2.64545322, -1.02161667, -1.59424371,
         1.18430336,  1.31756768, -0.06487105,  0.1958007 ,  1.16720325, -1.34495095,
         0.87099429,  2.71394073, -0.56817905,  0.2253223 ,  1.24964303, 1.39740524,

       -0.35918011,  0.95326196,  1.11169519,  0.86099973,  0.65080126, 0.51127197,
        -1.1158534 , -0.26445229, -1.27061146, -0.10336515,  1.45402224, -0.1962724 ,
        -0.35918011,  0.95326196,  1.11169519,  0.86099973,  0.65080126, 0.51127197,

       -0.44248965,  0.51079833, -0.80662343,  2.64545322, -1.02161667, -1.59424371,
         1.18430336,  1.31756768, -0.06487105,  0.1958007 ,  1.16720325, -1.34495095,
         1.18430336,  1.31756768, -0.06487105,  0.1958007 ,  1.16720325, -1.34495095,

        1.18430336,  1.31756768, -0.06487105,  0.1958007 ,  1.16720325, -1.34495095,
         0.87099429,  2.71394073, -0.56817905,  0.2253223 ,  1.24964303, 1.39740524,
         1.18430336,  1.31756768, -0.06487105,  0.1958007 ,  1.16720325, -1.34495095,

       -0.35918011,  0.95326196,  1.11169519,  0.86099973,  0.65080126, 0.51127197,
         1.18430336,  1.31756768, -0.06487105,  0.1958007 ,  1.16720325, -1.34495095,
        -0.44248965,  0.51079833, -0.80662343,  2.64545322, -1.02161667, -1.59424371,

        1.18430336,  1.31756768, -0.06487105,  0.1958007 ,  1.16720325, -1.34495095,
        -0.44248965,  0.51079833, -0.80662343,  2.64545322, -1.02161667, -1.59424371,
        -1.1158534 , -0.26445229, -1.27061146, -0.10336515,  1.45402224, -0.1962724 ,

        0.87099429,  2.71394073, -0.56817905,  0.2253223 ,  1.24964303, 1.39740524,
        -0.35918011,  0.95326196,  1.11169519,  0.86099973,  0.65080126, 0.51127197,
        -0.44248965,  0.51079833, -0.80662343,  2.64545322, -1.02161667, -1.59424371,

       -0.35918011,  0.95326196,  1.11169519,  0.86099973,  0.65080126, 0.51127197,
        -0.44248965,  0.51079833, -0.80662343,  2.64545322, -1.02161667, -1.59424371,
        -0.44248965,  0.51079833, -0.80662343,  2.64545322, -1.02161667, -1.59424371,

       -0.44248965,  0.51079833, -0.80662343,  2.64545322, -1.02161667, -1.59424371,
         1.18430336,  1.31756768, -0.06487105,  0.1958007 ,  1.16720325, -1.34495095,
        -1.1158534 , -0.26445229, -1.27061146, -0.10336515,  1.45402224, -0.1962724 ,

        0.87099429,  2.71394073, -0.56817905,  0.2253223 ,  1.24964303, 1.39740524,
        -1.1158534 , -0.26445229, -1.27061146, -0.10336515,  1.45402224, -0.1962724 ,
         0.87099429,  2.71394073, -0.56817905,  0.2253223 ,  1.24964303, 1.39740524,

       -0.44248965,  0.51079833, -0.80662343,  2.64545322, -1.02161667, -1.59424371,
        -1.1158534 , -0.26445229, -1.27061146, -0.10336515,  1.45402224, -0.1962724 ,
        -0.44248965,  0.51079833, -0.80662343,  2.64545322, -1.02161667, -1.59424371,

       -0.35918011,  0.95326196,  1.11169519,  0.86099973,  0.65080126, 0.51127197,
         0.87099429,  2.71394073, -0.56817905,  0.2253223 ,  1.24964303, 1.39740524,
         1.18430336,  1.31756768, -0.06487105,  0.1958007 ,  1.16720325, -1.34495095;

    MatrixN dW(5,6);
    dW << 6.57703128,  -2.5158619 ,  -2.4048323 ,  -0.56046221, 1.9801882 ,  -7.03243431,
        -1.84139006,   5.53064019,  -7.90375968,  -4.15784493, -2.30048648, -10.60339139,
        -5.55600265,  -0.9809074 ,  11.56072571,  -1.1762269 , 14.89790292,  -7.59683227,
         0.02152891,  -0.98163116, -11.09325249,  12.89208802, -1.65953027,  -3.5457068 ,
         1.43047737, -10.66973898,  -4.09373739,   2.97128051, 5.48698808,  -2.42671394;

    MatrixN dchain(50,18);
    dchain << -4.31155985e-01,   3.04636116e-01,  -5.76036452e-01,
           1.34346217e+00,  -1.56977803e+00,   9.53062177e-01,
         -2.32527497e+00,  -1.91471618e+00,  -2.23224566e-01,
          -2.79988843e-01,  -7.34309976e-01,   7.37927616e-01,
         -3.81669556e-01,   3.07820528e-01,  -6.87853455e-01,
          -1.61981965e+00,   5.85127848e-02,   3.78730241e-01,

         1.90289061e-01,  -1.55883636e-02,   8.04767034e-01,
           8.29089195e-01,   1.29019073e+00,  -5.63624744e-01,
         -2.33491388e-01,   1.52531133e-01,  -4.42511101e-02,
          -1.39082483e+00,   2.11108474e+00,  -2.58427740e-01,
         -4.47108702e-01,   7.56842126e-02,   1.49815291e+00,
          -5.39383034e-01,   1.02081198e+00,  -2.36163700e-01,

         2.02371465e+00,  -2.34775058e+00,  -6.06310613e-01,
          -1.68303430e+00,   5.60491549e-01,   5.27199086e-01,
          5.74884404e-01,   5.98690055e-01,   9.25041080e-01,
           7.87760208e-01,  -1.36248721e-01,  -8.53732031e-01,
         -8.31088195e-01,   6.26089578e-01,   2.64855320e-01,
           1.12364711e-01,  -9.13073760e-01,   1.27975795e+00,

         1.00601557e-02,  -1.98668877e+00,  -5.57599685e-01,
           4.78387318e-01,  -9.76566817e-01,  -9.18192710e-01,
          9.06480642e-01,  -2.24908254e-01,  -5.33321669e-01,
          -4.81308512e-01,  -2.26368467e+00,   7.89044520e-01,
         -1.18255292e+00,   5.58188271e-01,   9.81720080e-01,
           1.47957999e+00,   1.97878002e-01,   1.12246513e+00,

        -6.59341773e-01,   7.63327393e-03,  -1.52244908e-01,
          -3.60423371e-01,  -1.08592186e+00,   9.17466891e-01,
          2.68432999e-01,   1.27750788e+00,   9.15166611e-01,
           9.57232438e-01,  -2.37903705e-01,  -1.39957238e+00,
         -1.67472236e-01,   1.61770940e+00,   1.49172783e+00,
           1.19321012e+00,   1.56968395e+00,  -3.19518134e-01,

         6.80717138e-01,  -6.67328846e-01,  -3.27716535e-01,
          -1.56949245e+00,   2.45367186e-01,  -1.55173667e-01,
          2.88742508e+00,   4.36435583e-01,  -6.17818659e-01,
           7.58711394e-01,  -1.13301868e+00,  -1.74221495e+00,
         -2.56915283e-01,   7.21472851e-01,  -1.93810128e+00,
          -9.38594675e-02,  -5.44652561e-01,  -1.94294431e+00,

        -4.62143598e-01,   1.37253967e-01,  -2.19816209e+00,
           6.47737672e-01,  -7.82904954e-01,  -1.04598675e-01,
         -1.14095200e+00,   3.49037530e-01,  -1.44708129e-01,
          -3.92119785e-01,  -4.04236484e-02,  -2.42980254e+00,
          2.08226455e-01,  -2.90385801e-01,  -1.27331429e+00,
           1.84686068e+00,   9.30755617e-01,  -2.35213452e+00,

         1.10188719e+00,  -8.63828523e-01,   1.43500050e+00,
          -1.63094860e-01,  -1.22637523e+00,  -1.91542876e+00,
          4.25101830e-02,  -5.87506970e-02,  -1.32045131e-01,
          -2.52622917e-01,  -8.48834712e-02,  -2.75771951e-01,
         -4.82452528e-01,  -1.38499456e+00,  -1.30047378e+00,
          -3.14372319e-01,  -6.56342465e-01,  -2.86317281e-01,

        -5.01194680e-01,   1.77994514e+00,  -7.28210954e-01,
          -7.33354324e-01,   3.08099251e-02,  -1.74096074e+00,
          1.15229675e-01,  -7.02812892e-01,   2.35613995e-01,
          -7.93552931e-02,  -4.70763126e-01,  -9.43951979e-01,
          2.59696787e-01,   7.01485180e-01,  -4.42082725e-01,
           1.92474471e-01,   1.99831158e+00,  -4.09887202e-01,

        -1.60099700e+00,  -1.71078217e+00,  -2.10558049e-01,
          -7.86149055e-01,   8.11518314e-01,  -1.29208361e+00,
          2.33709652e-01,  -8.99147388e-01,   2.10547794e-01,
          -1.68970891e-01,   2.33205059e-01,   6.74205734e-01,
         -1.64560083e+00,  -9.56919391e-01,   1.21230116e-01,
          -8.17079918e-01,  -1.76318025e-01,   2.00245174e+00,

         9.20730450e-01,  -1.30244925e+00,   1.22923051e+00,
          -1.23278978e-01,   1.53396985e+00,   1.31861844e+00,
         -7.01539987e-02,  -7.55039499e-01,   3.74019452e-01,
           3.46426908e-01,   5.90105281e-01,  -4.90502179e-01,
         -8.77754481e-01,  -4.66997383e-01,  -1.14501742e+00,
          -1.98899308e+00,   7.95462750e-01,  -7.88303110e-01,

        -1.01827272e+00,   2.17948816e+00,  -1.63726171e+00,
          -6.29299177e-01,   3.83652836e-02,  -9.69518947e-01,
          1.98857448e+00,   5.01936554e-01,  -4.24739386e-01,
           5.09527578e-01,   2.25761862e+00,  -1.24957199e-01,
         -2.48292588e-01,  -6.34693387e-01,  -9.73808602e-01,
          -8.57785211e-01,  -6.51783398e-01,   8.88913291e-01,

        -8.69043854e-01,  -1.18082282e+00,  -1.00065755e+00,
           1.30612560e+00,  -7.35031228e-01,   3.51137480e-01,
          4.71057143e-01,   5.12555515e-01,  -1.24871457e+00,
          -3.79658033e-01,   1.53845868e+00,  -2.05896678e-01,
          2.42117705e-01,   4.51551558e-01,  -1.10265006e-01,
          -7.91071177e-01,  -4.60139033e-01,  -1.64217486e+00,

         4.16404343e-01,  -7.99662060e-02,   3.16352483e-01,
           1.24280766e+00,  -3.78544912e-01,   1.07051918e+00,
          1.45119245e+00,   1.60576962e+00,  -5.16557790e-02,
          -5.19180833e-01,   3.33977606e-01,  -2.78177114e-01,
          2.46509043e-01,  -1.60257957e+00,  -5.85733961e-01,
          -1.72968151e+00,   7.08844788e-01,  -5.55529974e-01,

        -1.18041168e+00,  -1.77204146e+00,   1.70359432e+00,
           7.81898343e-01,   1.39156902e-02,  -2.38538499e+00,
         -5.33143019e-01,  -3.59604610e-01,   6.01056947e-01,
           1.68336988e+00,   1.71382882e+00,   1.55079778e+00,
         -1.63876737e-01,  -2.65244545e-01,  -1.33640849e+00,
           5.34370484e-01,   1.19901242e+00,  -6.02268724e-01,

        -2.45733248e-01,  -1.11441850e+00,  -3.74565789e-01,
           1.02722478e+00,  -5.00240737e-01,  -5.47721665e-01,
          3.43180157e-01,  -1.55243231e+00,  -6.04782011e-01,
           2.93012617e-01,   1.52629182e-01,  -1.47540996e+00,
          1.39324638e+00,  -8.71598140e-01,  -1.07690997e+00,
           7.59412602e-01,   2.09194012e+00,  -2.35064032e-01,

        -6.17372383e-01,   5.83530438e-01,  -8.80439192e-01,
           1.63966294e+00,   1.62337292e+00,  -9.10417218e-01,
          1.50690327e-01,   3.75330517e-01,   3.73452502e-01,
           1.09048308e+00,   1.59408559e+00,  -6.15533305e-01,
         -1.81834987e+00,   6.60315264e-02,   1.12634877e+00,
          -1.23865268e-02,  -1.13301253e+00,   4.44399499e-01,

         2.85169082e+00,  -3.25845406e-01,  -1.17709389e+00,
          -5.00034576e-01,   3.02898730e-01,   2.65687401e+00,
         -3.00545865e-01,  -4.15632556e-02,   1.20526914e+00,
           1.86551716e+00,   1.80932662e+00,  -1.08486197e+00,
          7.05953120e-01,  -8.93633065e-01,   1.03929389e+00,
           2.48829528e-01,   2.22148469e+00,  -5.85659948e-01,

         4.85048540e-01,   1.95669064e-01,   2.30574640e-01,
           2.43485955e-01,   3.20092286e-01,  -3.88626678e-01,
         -5.18286839e-01,  -2.99327823e-01,  -6.62539167e-01,
           3.60854916e-01,  -3.12667827e+00,   8.62987225e-01,
          7.27701476e-03,  -1.24710380e+00,   8.72597138e-01,
           2.33068982e+00,   3.54560475e-01,   8.08633044e-01,

         1.04326507e-01,   9.96614805e-02,   1.56206420e+00,
          -6.91838304e-01,  -4.38314048e-01,  -5.60759297e-01,
          5.96399408e-01,   6.87212410e-01,   4.27442042e-01,
           7.09631094e-01,  -3.03716330e-01,  -1.64813415e+00,
          4.63246890e-01,  -9.58905474e-01,  -7.41542084e-02,
           7.53824848e-01,  -6.45040571e-01,  -1.04761720e+00,

        -7.97772043e-01,   7.56043633e-01,  -3.13538952e-01,
          -3.27113755e-01,  -5.34633671e-01,  -1.91239022e+00,
         -6.86930292e-01,   1.14497282e+00,  -1.27122705e-01,
          -1.37972925e+00,  -6.95752397e-01,   2.29591352e+00,
          7.43228271e-01,  -1.57762341e+00,  -1.18439019e-01,
           5.60208717e-01,  -1.83815984e-01,  -5.13840852e-01,

         4.80426739e-01,   2.57299970e-01,  -1.51983379e+00,
           5.91255282e-01,  -1.86778892e-01,   8.44151108e-01,
          4.89950721e-01,  -3.43092457e-01,  -7.99817978e-01,
           4.45890222e-01,  -5.33600821e-01,  -4.12436211e-01,
          7.55738416e-01,   2.65854528e-01,  -1.26638674e+00,
           6.15897300e-01,  -2.08655573e+00,   1.06886231e+00,

        -8.01182027e-01,  -1.36524223e+00,  -1.69508564e+00,
           7.15379996e-01,  -1.02324027e+00,   1.58388116e+00,
          9.39420468e-01,   1.00690727e+00,  -1.47562968e+00,
           5.99650449e-01,  -8.96991965e-01,   4.04578969e-01,
         -1.40572648e+00,   3.28092042e-01,   7.99283792e-01,
          -2.00610783e-01,   2.18081645e+00,   6.07040833e-01,

        -1.41067127e-01,  -2.89636363e+00,  -8.14486863e-01,
           1.11354820e+00,   1.08883180e+00,   3.29342459e-01,
          4.66141525e-01,  -9.41647420e-02,  -1.32366764e+00,
          -1.19784479e+00,  -5.74595698e-01,   1.44654042e+00,
         -2.34073098e-01,  -1.23510611e+00,   3.33662605e-01,
          -8.42515982e-01,  -9.27645805e-01,  -5.43829052e-01,

         1.66846974e+00,  -6.17165823e-01,   5.20159596e-01,
          -6.90550329e-01,  -5.53225066e-01,  -2.58081077e-01,
         -8.55913161e-01,  -2.59879714e+00,   1.85448811e+00,
          -1.65008497e+00,   2.86250911e-01,  -1.55193990e+00,
          7.97035277e-01,   8.03993399e-01,   1.58189731e+00,
          -1.04787223e+00,  -1.03317820e+00,   7.05538751e-01,

        -8.58641278e-01,  -7.51694530e-02,   3.15983282e-02,
          -1.48941466e+00,   1.87727238e+00,   4.45810803e-01,
          1.20476455e+00,   1.46131201e+00,  -1.02806399e+00,
          -1.00274660e+00,   2.37073636e-01,  -1.03836418e+00,
         -1.93235403e-01,   6.87801258e-01,  -8.90048204e-01,
          -1.56307597e+00,  -1.02969197e-01,   1.07914042e-01,

         1.09516309e+00,  -4.13849881e-01,  -1.31508580e+00,
           1.42043280e+00,   5.67935552e-01,  -7.59876869e-02,
         -1.14673619e-02,   1.03043727e+00,   1.00052554e+00,
           2.74062274e-01,   5.79066586e-02,   1.07412225e-01,
          1.18430114e+00,  -1.55253963e-01,   1.66042019e+00,
          -1.28020907e-01,  -1.45891693e+00,   1.13836616e-01,

        -1.76449390e+00,   5.59409958e-01,   1.53815988e+00,
          -5.28984763e-01,   2.14618254e-01,  -3.81240902e-01,
         -7.20836145e-01,   2.00749846e+00,   1.06266899e+00,
          -1.91243152e+00,   2.24428758e+00,  -1.84409679e-01,
          5.87125633e-01,   8.58309020e-01,  -6.25143154e-01,
           2.78875376e-01,  -7.28348108e-01,   8.76485552e-01,

        -9.71892496e-01,   4.93841898e-01,  -5.31220360e-01,
           1.48819888e+00,  -6.38715876e-01,  -1.28166762e+00,
          1.07312775e+00,   1.72347992e+00,  -1.28664706e+00,
          -2.87010026e-02,  -6.85000229e-01,   9.14587829e-01,
          1.13514272e+00,  -1.62642377e+00,   6.32414478e-01,
           6.62588852e-01,  -6.35134787e-01,   7.85343454e-02,

        -1.76154743e-01,  -1.83328255e+00,  -8.53166674e-01,
          -6.66539525e-01,  -6.38514647e-01,  -1.40667093e-01,
          7.69376292e-01,  -1.40979261e-03,   2.07010626e+00,
          -6.25688429e-01,   4.83686014e-02,  -1.44576524e+00,
         -6.94438732e-01,   1.31752347e+00,   4.02502872e-01,
           4.33088146e-01,   2.87726384e-01,   1.66192612e+00,

         1.26162206e+00,  -8.96723746e-01,   8.35230254e-01,
           1.47025882e+00,   1.71444727e+00,  -1.03640153e-01,
         -8.79136396e-01,  -1.92114534e+00,   6.29989104e-02,
           1.56201374e+00,  -1.20923770e+00,  -1.32235992e+00,
         -7.00343744e-01,  -9.76031002e-01,  -4.42578184e-01,
           5.92290783e-01,   5.04465392e-01,  -3.14701445e-01,

        -2.70210054e+00,   3.13530562e-01,  -1.68982765e-01,
           5.03908530e-01,   4.08762574e-01,  -1.81977196e-02,
         -1.05873476e+00,  -4.17967001e-01,   1.16710891e+00,
          -2.00788229e+00,  -1.35538324e-01,  -1.19768922e+00,
         -3.44087208e-01,   5.06142503e-02,  -1.75154789e+00,
          -2.86670530e-01,  -3.06521392e-02,  -3.18090898e-02,

        -1.68178474e+00,   8.86468127e-01,  -1.03306690e+00,
           6.39593730e-01,   2.50691289e+00,  -3.06308787e-01,
         -7.96919999e-01,   8.93006061e-01,  -5.73288451e-01,
           3.00361732e-01,   2.79256662e-01,   2.97500409e-01,
         -9.81403355e-01,  -8.26994056e-03,   4.12317813e-01,
           9.30744436e-01,   1.73777926e-01,   2.16947574e-01,

        -1.31396150e+00,   9.02684556e-01,   8.64829920e-02,
          -1.09038751e+00,   3.37682535e-01,   2.83330036e-01,
          4.52457427e-01,  -2.00937621e-01,   4.76759775e-02,
          -4.45976623e-01,   1.45060397e-01,  -7.67886737e-01,
          5.67260067e-03,  -1.39369096e+00,   9.86038404e-03,
          -2.12737133e-01,   5.06914561e-02,  -9.75780800e-01,

         2.68497225e-01,   1.34625917e+00,  -1.58330136e+00,
          -3.29170732e-01,   8.97748995e-01,  -4.90358088e-01,
         -3.26167673e+00,   9.49439013e-01,   1.40708968e+00,
          -1.04728946e+00,   3.31646766e-01,   9.26756913e-01,
          1.02516536e-01,   1.38081940e+00,  -4.95855548e-01,
           2.42014772e-04,   2.34133845e-01,   4.58466128e-01,

        -1.66809941e+00,   5.88892636e-01,  -3.12137454e-01,
           1.48730246e-01,   1.42263147e+00,   1.19499367e-01,
         -8.54124348e-01,  -4.23469119e-01,   1.64702244e+00,
           1.54750829e+00,   7.39997107e-01,  -1.68630886e-01,
         -5.21372722e-02,  -3.08620934e-01,   4.22296503e-01,
           9.60835767e-01,   1.51067087e+00,  -5.46959842e-01,

        -1.40799506e+00,   5.07759445e-01,  -1.13270527e+00,
           9.50769408e-01,  -2.81832891e-01,   1.03635456e+00,
          5.34666859e-01,  -1.40730495e+00,  -8.09130724e-01,
           1.94701557e+00,   2.38326132e+00,   8.51644737e-01,
          1.86043655e+00,  -5.99178208e-01,  -3.75475302e-01,
          -1.16102567e+00,   1.22690094e+00,  -1.26601806e+00,

         1.67082777e+00,  -2.02325570e+00,  -9.18473614e-01,
          -6.86102628e-01,  -6.55003285e-01,  -7.37611899e-01,
          5.41049350e-01,   6.71355582e-01,  -8.46476232e-01,
           1.00316212e+00,   7.54535946e-01,  -7.74631571e-01,
          1.97348655e+00,  -1.18932731e-01,  -1.61503824e-01,
          -1.72299691e+00,  -1.14258003e+00,  -8.51547499e-01,

         1.08355337e+00,   9.33029423e-01,   7.37857535e-01,
           5.31297388e-01,  -2.99338721e-01,   1.10068392e+00,
         -7.69485619e-01,  -9.69027786e-02,   1.25405241e+00,
           1.37377197e+00,   1.44505481e+00,  -4.33491718e-01,
          2.04579425e+00,   1.10390315e+00,   8.54738530e-01,
           1.94192759e+00,   1.69539374e+00,  -1.26602577e+00,

        -4.57146673e-01,  -4.32562358e-01,  -2.81212058e-01,
          -9.61253115e-01,   7.09052725e-01,  -1.07568844e+00,
          1.21488628e+00,   2.34088395e+00,   1.18562004e+00,
           9.84519835e-02,  -5.69680149e-01,  -7.15518147e-01,
          4.96674060e-01,   1.30273540e-01,  -4.09324988e-01,
           7.39761886e-01,   1.32087135e+00,   3.77679567e-02,

         4.74987061e-01,  -2.02344888e+00,  -5.53750929e-01,
           1.57065275e-01,   3.84381608e-02,  -1.96494877e+00,
         -6.42659484e-01,  -8.25548291e-01,   5.02974462e-01,
          -1.28704546e-01,   6.01095830e-01,  -1.35059747e-01,
          4.71842519e-01,  -7.66394036e-01,  -2.57184489e-01,
          -1.98630312e+00,  -1.33835038e+00,   5.96336269e-01,

        -8.98934777e-01,  -8.32161183e-02,  -2.09237579e-01,
           6.90660304e-01,   8.47626846e-01,   1.01753613e-01,
         -1.39954884e+00,  -6.36478569e-01,   8.77917229e-01,
          -1.28850812e-01,  -1.50988394e+00,  -8.25078605e-01,
         -1.63744849e-01,  -1.39236187e+00,   7.45789972e-01,
          -5.82983563e-01,  -1.51873307e+00,  -5.35550506e-01,

         2.58524195e-01,  -1.90148884e+00,  -4.11906015e-01,
           1.07156531e+00,  -7.54493310e-01,  -1.16096069e+00,
         -2.20507568e-01,  -1.99413892e-01,  -5.97949055e-01,
           1.22513747e-01,  -7.58802739e-01,  -7.86321555e-01,
         -2.02968119e-01,   8.93187510e-01,  -3.56893065e-01,
           2.03121085e+00,   2.42405615e-01,   1.29199491e+00,

         2.25457336e-01,   1.30154339e+00,   6.07148640e-01,
          -5.95070426e-02,   6.21800593e-01,   1.57120710e+00,
          4.73504692e-01,   2.80268269e-01,  -9.44800133e-01,
          -1.38897006e+00,  -4.98320363e-01,   1.28625539e+00,
          7.92799822e-01,   1.25427742e+00,  -1.46892775e+00,
          -7.10541491e-01,  -3.65164634e-01,  -2.23467372e+00,

         1.13939645e+00,  -6.25826583e-01,   1.78198625e+00,
          -7.23262968e-02,   1.51546700e+00,  -3.74091024e-01,
          7.12866053e-02,   5.90149131e-01,   1.46031185e+00,
           8.76569968e-01,   2.87027567e-01,   7.89182456e-01,
         -1.34081620e+00,   7.98113003e-01,  -1.07803672e+00,
           4.92875900e-01,  -1.32762168e+00,  -1.31367497e+00,

         5.39240538e-01,  -6.74600551e-02,  -9.43384491e-01,
          -6.86552679e-01,   5.51378962e-01,   6.11858733e-01,
          8.87442300e-01,   5.52169782e-01,  -8.68143198e-01,
           1.89453070e-01,  -7.49185201e-01,  -1.44401744e+00,
          2.53292360e-01,  -2.48348866e-01,   5.52728868e-01,
           2.19671888e-03,   7.23640248e-01,   8.11576948e-01,

         1.77428801e+00,  -2.05153034e-01,  -4.92266266e-01,
           6.22191196e-01,  -9.17633549e-01,   3.53273308e-02,
          1.10851817e+00,   6.89986079e-01,  -3.29444595e-01,
           2.44250685e-02,   7.35834706e-01,   2.08749448e-01,
          7.04143250e-02,   9.92143864e-01,  -8.36567603e-01,
          -1.56015937e+00,  -9.91827434e-01,  -1.94415148e-01,

        -2.17932534e+00,   8.97398792e-01,   7.77070084e-01,
           1.37404702e+00,  -7.12934367e-01,   2.68901816e-01,
          9.16604920e-01,   6.87416231e-01,  -1.45759058e+00,
           6.99007330e-01,  -5.29149364e-01,   9.08301088e-02,
         -1.30014785e+00,  -5.42448743e-01,  -4.09521083e-01,
          -2.92314732e-02,  -1.10292940e+00,  -2.73228033e+00,

         9.50606039e-01,   4.58779516e-01,  -4.13384478e-01,
           8.98967895e-01,   2.14491377e+00,   9.32765864e-01,
         -5.44532811e-01,   2.08868672e+00,  -1.01337471e+00,
          -3.98631382e-01,   2.56432400e-01,  -6.31612556e-01,
          4.51229144e-01,   5.26110725e-01,   1.37100007e-02,
           1.09852716e+00,  -4.02645395e-01,  -8.32016376e-01,

        -8.27335442e-01,   1.71777065e-01,   3.16587615e-01,
          -2.68102708e-01,  -1.04386775e+00,  -1.11843196e+00,
          6.74132256e-01,   4.99546300e-03,   8.84726997e-01,
          -1.13801366e+00,   8.22529430e-01,  -9.06626773e-01,
          2.97478930e-02,  -1.09266151e+00,  -3.95794124e-02,
          -8.57433423e-01,   1.24854517e+00,  -4.80061940e-01;
    WordEmbedding we("{inputShape=[3];hidden=5;V=5;D=6}");   //inputShape=T
    *(we.params["W"])=W;

    t_cppl cache;
    t_cppl grads;
    MatrixN y0=we.forward(x, &cache);
    bool allOk=true;
    bool ret=matComp(y,y0,"WordEmbeddingBackward forward consistency check",eps);
    if (!ret) allOk=false;
    MatrixN dx0=we.backward(dchain, &cache, &grads);
    //bool ret=matComp(dx,dx0,"WordEmbeddingBackward dx",eps);
    //if (!ret) allOk=false;
    ret=matComp(dW,*(grads["W"]),"WordEmbeddingBackward dW",eps);
    if (!ret) allOk=false;

    cppl_delete(&cache);
    cppl_delete(&grads);
    return allOk;
}

bool checkTemporalAffineForward(floatN eps=CP_DEFAULT_NUM_EPS) {
    // N, T, D, M = 2, 3, 4, 5
    MatrixN x(2,3*4);  // (N, T*D)
    x << -0.7461612 , -1.55144546,  1.82876302,  0.5294384,
          0.64588784,  1.28880436, -1.13547596, -1.49195431,
         -0.12854723,  0.02965153,  0.27540986, -0.16085281,

          0.9820497 ,  0.17045352, -1.58826521, -0.75047715,
         -0.44713369,  1.18263892,  0.51718481, -1.91610422,
         -0.6941147 , -1.27365114, -0.44673534, -1.04071134;
    MatrixN W(4,5); // (D,M)
    W << -0.11804466,  0.60008559,  0.64535532, -1.34411199,  0.9097930,
        -0.53677237,  1.63487183,  0.07272647, -0.70552658,  0.23083179,
        -1.31014264,  0.66858958,  0.48717484, -3.41804233,  0.99484487,
         0.62353267,  1.7368257 , -2.51836522,  0.33305551,  1.7699659;
    MatrixN b(1,5);
    b << -0.09637528,  0.23096641,  0.12591043,  0.06687821, -0.91183218;
    MatrixN y(2,3*5); // (N, T*M)
    y << -1.24134016, -0.61097456, -0.91085174, -3.9100686 ,  0.80761607,
         -0.30706023, -0.62484764,  3.84057832,  1.67364817, -3.79704162,
         -0.55824027,  0.10706638,  0.58436712, -0.77619534, -1.03265294,

          1.30911123, -1.26639562,  1.88829062,  3.80544112, -2.88742059,
         -2.55074087, -1.08604371,  5.00076914, -2.57243587, -3.92256111,
          0.6055915 , -4.37403498,  1.98858468,  3.0787865 , -4.12378799;

     TemporalAffine pe("{inputShape=[12];T=3;D=4;M=5}");  // 12=T*D
    *(pe.params["W"])=W;
    *(pe.params["b"])=b;
    MatrixN y0=pe.forward(x, nullptr);
    return matComp(y,y0,"TemporalAffineForward",eps);
}

bool checkTemporalAffineBackward(float eps=CP_DEFAULT_NUM_EPS) {
    // N, T, D, M = 2, 3, 4, 5
    MatrixN x(2,3*4);  // (N, T*D)
    x << -0.7461612 , -1.55144546,  1.82876302,  0.5294384,
          0.64588784,  1.28880436, -1.13547596, -1.49195431,
         -0.12854723,  0.02965153,  0.27540986, -0.16085281,

          0.9820497 ,  0.17045352, -1.58826521, -0.75047715,
         -0.44713369,  1.18263892,  0.51718481, -1.91610422,
         -0.6941147 , -1.27365114, -0.44673534, -1.04071134;
    MatrixN W(4,5); // (D,M)
    W << -0.11804466,  0.60008559,  0.64535532, -1.34411199,  0.9097930,
        -0.53677237,  1.63487183,  0.07272647, -0.70552658,  0.23083179,
        -1.31014264,  0.66858958,  0.48717484, -3.41804233,  0.99484487,
         0.62353267,  1.7368257 , -2.51836522,  0.33305551,  1.7699659;
    MatrixN b(1,5);
    b << -0.09637528,  0.23096641,  0.12591043,  0.06687821, -0.91183218;
    MatrixN y(2,3*5); // (N, T*M)
    y << -1.24134016, -0.61097456, -0.91085174, -3.9100686 ,  0.80761607,
         -0.30706023, -0.62484764,  3.84057832,  1.67364817, -3.79704162,
         -0.55824027,  0.10706638,  0.58436712, -0.77619534, -1.03265294,

          1.30911123, -1.26639562,  1.88829062,  3.80544112, -2.88742059,
         -2.55074087, -1.08604371,  5.00076914, -2.57243587, -3.92256111,
          0.6055915 , -4.37403498,  1.98858468,  3.0787865 , -4.12378799;

     TemporalAffine pe("{inputShape=[12];T=3;D=4;M=5}");  // 12=T*D, M=5
    *(pe.params["W"])=W;
    *(pe.params["b"])=b;
    t_cppl cache;
    MatrixN y0=pe.forward(x, &cache);

    MatrixN dx(2,3*4);
    dx << -3.98456076,  -8.08466677, -10.98578141,  -5.24138688,
           0.22149385,   0.35130136,  -0.92980791,   0.1392131,
          -0.46269609,   0.62604295,  -1.37580256,   0.03723776,

           0.71871108,  -1.41956731,   3.26066682,  -6.19821418,
           0.83919535,   0.62097009,   4.20262083,   3.38660663,
          -0.38954197,  -1.41253428,  -2.45415827,   6.17485966;
    MatrixN dW(4,5);
    dW << -1.34217907,  2.02018413,  1.84852028, -2.80448865, -2.81008126,
       -3.66688543,  6.23758417, -1.04163871, -5.64704509, -3.32964834,
        1.50638603, -4.72100215, -0.13201567,  5.41395045,  2.38929841,
       -0.89459742, -0.77936534,  3.71094687,  4.05376848, -0.76022841;
    MatrixN db(1,5);
    db << 2.41756125, -4.69466384, -0.43658263,  1.08861002,  1.96764153;
    MatrixN dchain(2,15);
    dchain << 2.10790832, -3.50494649,  0.85018549,  2.00685021,  0.5674853,
          1.22151635,  0.59387383,  0.3102907 , -0.16995239, -0.46095165,
         -1.60655573,  0.31897037,  0.50353471,  1.36593723,  0.73342271,

         -0.11640313, -1.39148743,  0.7655294 , -1.29438842, -0.76265654,
         -0.35433334, -0.26196855, -1.59524514, -1.29404341,  0.26899792,
          1.16542877, -0.44910557, -1.27087778,  0.4742068 ,  1.6213438;

    t_cppl grads;
    MatrixN dx0=pe.backward(dchain, &cache, &grads);
    bool allOk=true;
    bool ret=matComp(dx,dx0,"TemporalAffineBackward dx",eps);
    if (!ret) allOk=false;
    ret=matComp(dW,*(grads["W"]),"TemporalAffineBackward dW",eps);
    if (!ret) allOk=false;
    ret=matComp(db,*(grads["b"]),"TemporalAffineBackward bx",eps);
    if (!ret) allOk=false;
    cppl_delete(&cache);
    cppl_delete(&grads);
    return allOk;
}

bool registerTest() {
    bool allOk=true;
    cerr << "Registered Layers:" << endl;
    int nr=1;
    for (auto it : _syncogniteLayerFactory.mapl) {
        cerr << nr << ".: " << it.first << " ";
        t_layer_props_entry te=_syncogniteLayerFactory.mapprops[it.first];
        CpParams cp;
        cp.setPar("inputShape",std::vector<int>(te));
        Layer *l = CREATE_LAYER(it.first, cp)
        if (l->layerType == LT_NORMAL) {
            cerr << "normal layer" << endl;
        } else if (l->layerType==LT_LOSS) {
            cerr << "loss-layer (final)" << endl;
        } else {
            cerr << "unspecified layer -- ERROR!" << endl;
            allOk=false;
        }
        delete l;
        ++nr;
    }
    return allOk;
}

int tFunc(floatN x, int c) {
    int y=(int)(((sin(x/5.0)+1.0)/2.0)*(floatN)c);
    //cerr << x << ":" << y << " " << endl;
    return y;
}

bool trainTest() {
    bool allOk=true;
    CpParams cp;
    int N=300,NV=30,NT=30,I=5,H=20,C=4;
    cp.setPar("inputShape",vector<int>{I});
    cp.setPar("hidden",vector<int>{H,C});
    TwoLayerNet tln(cp);

    MatrixN X(N,I);
    X.setRandom();
    MatrixN y(N,1);
    for (unsigned i=0; i<y.rows(); i++) y(i,0)=tFunc(X(i,0),C);

    MatrixN Xv(NV,I);
    Xv.setRandom();
    MatrixN yv(NV,1);
    for (unsigned i=0; i<yv.rows(); i++) yv(i,0)=tFunc(Xv(i,0),C);

    MatrixN Xt(NT,I);
    Xt.setRandom();
    MatrixN yt(NT,1);
    for (unsigned i=0; i<yt.rows(); i++) yt(i,0)=tFunc(Xt(i,0),C);

    CpParams cpo("{verbose=false;epochs=200.0;batch_size=20;learning_rate=1e-2;"\
                "lr_decay=1.0;momentum=0.9;decay_rate=0.98;epsilon=1e-8;threads=2}");

    floatN train_err,test_err,val_err;

    tln.train(X, y, Xv, yv, "Adam", cpo);
    //tln.train(X, y, Xv, yv, "Sdg", cpo);
    train_err=tln.test(X, y);
    val_err=tln.test(Xv, yv);
    test_err=tln.test(Xt, yt);

    cerr << "Train-test, train-err=" << train_err << endl;
    cerr << "       validation-err=" << val_err << endl;
    cerr << "       final test-err=" << val_err << endl;
    if (test_err>0.2 || val_err>0.2 || train_err>0.2) allOk=false;
    return allOk;
}

int doTests() {
    MatrixN yz=MatrixN(0,0);
    cerr << "=== 0.: Init: registering layers" << endl;
    registerLayers();
    cerr << "=== 1.: Numerical gradient tests" << endl;
    bool allOk=true;
    Color::Modifier red(Color::FG_RED);
    Color::Modifier green(Color::FG_GREEN);
    Color::Modifier def(Color::FG_DEFAULT);

    Affine pc(CpParams("{inputShape=[30];hidden=20}"));
    MatrixN x(10,30);
    x.setRandom();
    if (!pc.selfTest(x,yz)) {
        allOk=false;
    }

    Relu rl(CpParams("{inputShape=[20]}"));
    MatrixN xr(10,20);
    xr.setRandom();
    if (!rl.selfTest(xr,yz)) {
        allOk=false;
    }

    vector<string> nls={"relu","sigmoid","tanh"};
    for (string nlsi : nls) {
        CpParams cp("{inputShape=[20]}");
        cp.setPar("type", nlsi);
        Nonlinearity nlr(cp);
        MatrixN xnl(10,20);
        xnl.setRandom();
        if (!nlr.selfTest(xnl,yz)) {
            allOk=false;
        }
    }

    // Batchnorm - still some strangities:
    BatchNorm bn("{inputShape=[10];train=true;noVectorizationTests=true}");
    MatrixN xbr(20,10);
    xbr.setRandom();
    if (!bn.selfTest(xbr,yz, 1e-4, 1e-3)) {
        allOk=false;
    }

    // Dropout
    Dropout dp("{inputShape=[5];train=true;noVectorizationTests=true;freeze=true;drop=0.8}");
    MatrixN xdp(3,5);
    xdp.setRandom();
    floatN h=1e-6; if (h<CP_DEFAULT_NUM_H) h=CP_DEFAULT_NUM_H;
    floatN eps=1e-8; if (eps<CP_DEFAULT_NUM_EPS) eps=CP_DEFAULT_NUM_EPS;
    if (!dp.selfTest(xdp,yz, h, eps)) {
        allOk=false;
    }

    // Convolution
    //Convolution cv("{inputShape=[3,4,4,16,3,3];stride=1;pad=0}");
    //MatrixN xcv(20,48);
    Convolution cv("{inputShape=[3,5,5];kernel=[2,3,3];stride=1;pad=1}");
    MatrixN xcv(2,75);
    xcv.setRandom();
    if (!cv.selfTest(xcv, yz, 1e-2, 1e-3)) {
        allOk=false;
    }

    // Pooling
    Pooling pl("{inputShape=[3,4,4];stride=2}");
    MatrixN xpl(20,48);
    xpl.setRandom();
    if (!pl.selfTest(xpl, yz)) {
        allOk=false;
    }

    // SpatialBatchNorm
    SpatialBatchNorm sbn("{inputShape=[3,4,4];train=true;N=2;noVectorizationTests=true}");
    MatrixN xsbn(2,3*4*4);
    xsbn.setRandom();
    if (!sbn.selfTest(xsbn, yz)) {
        allOk=false;
    }

    // RNN
    int rnnN=4;
    MatrixN xrnn(rnnN,5*7);
    MatrixN h0(rnnN,6);
    xrnn.setRandom();
    h0.setRandom();
    //                    D,T
    RNN rnn("{inputShape=[5,7];H=6;N=4;noVectorizationTests=true}");
    *(rnn.params["ho"])=h0;
    if (!rnn.selfTest(xrnn, yz, 1e-2, 1e-3)) {
        allOk=false;
    }

    // WordEmbedding
    int weN=4, weT=3, weV=10, weD=8;
    MatrixN xwe(weN,weT);
    MatrixN weW(weV,weD);
    xwe.setRandom();
    weW.setRandom();
    WordEmbedding we("{inputShape=[3];V=10;D=8;noVectorizationTests=true}");
    *(we.params["W"])=weW;
    if (!we.selfTest(xwe, yz, 1e-2, 1e-3)) {
        allOk=false;
    }

    // N=10; T=5; D=6; M=7
    // TemporalAffine pct(CpParams("{inputShape=[30];T=5;D=6;M=7;noVectorizationTests=true}")); // 30=T*D
    TemporalAffine pct(CpParams("{inputShape=[30];T=5;D=6;M=7}")); // 30=T*D
    MatrixN xtt(10,30);
    xtt.setRandom();
    if (!pct.selfTest(xtt,yz)) {
        allOk=false;
    }

    AffineRelu rx("{inputShape=[2];hidden=3}");
    MatrixN xarl(30,2);
    xarl.setRandom();
    h=1e-6; if (h<CP_DEFAULT_NUM_H) h=CP_DEFAULT_NUM_H;
    eps=1e-6; if (eps<CP_DEFAULT_NUM_EPS) eps=CP_DEFAULT_NUM_EPS;
    if (!rx.selfTest(xarl,yz, h, eps)) {
        allOk=false;
    }

    // TwoLayerNet
    int ntl1=4, ntl2=5, ntl3=6, ntlN=30;
    CpParams tcp;
    tcp.setPar("inputShape",vector<int>{ntl1});
    tcp.setPar("hidden",vector<int>{ntl2,ntl3});
    TwoLayerNet tl(tcp);
    MatrixN xtl(ntlN,ntl1);
    xtl.setRandom();
    MatrixN y2(ntlN,1);
    for (unsigned i=0; i<y2.rows(); i++) y2(i,0)=(rand()%ntl3);
    h=1e-3; if (h<CP_DEFAULT_NUM_H) h=CP_DEFAULT_NUM_H;
    eps=1e-5; if (eps<CP_DEFAULT_NUM_EPS) eps=CP_DEFAULT_NUM_EPS;
    if (!tl.selfTest(xtl,y2, h, eps)) {
        allOk=false;
        cerr << red << "Numerical gradient for TwoLayerNet: ERROR." << def << endl;
    }

    // Softmax
    int smN=10, smC=4;
    CpParams c1;
    c1.setPar("inputShape",vector<int>{smC});
    Softmax mx(c1);
    MatrixN xmx(smN,smC);
    xmx.setRandom();
    MatrixN y(smN,1);
    for (unsigned i=0; i<y.rows(); i++) y(i,0)=(rand()%smC);
    h=1e-3; if (h<CP_DEFAULT_NUM_H) h=CP_DEFAULT_NUM_H;
    eps=1e-6; if (eps<CP_DEFAULT_NUM_EPS) eps=CP_DEFAULT_NUM_EPS;
    if (!mx.selfTest(xmx, y, h, eps)) {
        allOk=false;
    }

    // SVM
    int svN=10, svC=5;
    CpParams c2;
    c2.setPar("inputShape",vector<int>{svC});
    Svm sv(c2);
    MatrixN xsv(svN,svC);
    xsv.setRandom();
    MatrixN yv(svN,1);
    for (unsigned i=0; i<yv.rows(); i++) yv(i,0)=(rand()%svC);
    h=1e-3; if (h<CP_DEFAULT_NUM_H) h=CP_DEFAULT_NUM_H;
    eps=1e-6; if (eps<CP_DEFAULT_NUM_EPS) eps=CP_DEFAULT_NUM_EPS;
    if (!sv.selfTest(xsv, yv, h, eps)) {
        allOk=false;
    }

    //LayerBlock1
    LayerBlock lb("{name='testblock'}");
    cerr << "LayerName for lb: " << lb.layerName << endl;
    lb.addLayer("Affine","af1","{inputShape=[10]}",{"input"});
    lb.addLayer("Relu","rl1","",{"af1"});
    lb.addLayer("Affine","af2","{hidden=10}",{"rl1"});
    lb.addLayer("Softmax","sm1","",{"af2"});
    if (!lb.checkTopology(true)) {
        allOk=false;
        cerr << red << "Topology-check for LayerBlock: ERROR." << def << endl;
    } else {
        cerr << green << "Topology-check for LayerBlock: ok." << def << endl;
    }
    MatrixN xml(5,10);
    xml.setRandom();
    MatrixN yml(5,1);
    for (unsigned i=0; i<yml.rows(); i++) yml(i,0)=(rand()%10);

    h=1e-3; if (h<CP_DEFAULT_NUM_H) h=CP_DEFAULT_NUM_H;
    eps=1e-5; if (eps<CP_DEFAULT_NUM_EPS) eps=CP_DEFAULT_NUM_EPS;
    if (!lb.selfTest(xml,yml, h, eps)) {
        allOk=false;
        cerr << red << "Numerical gradient for LayerBlock: ERROR." << def << endl;
    }

    cerr << "=== 2.: Test-data tests" << endl;

    if (checkAffineForward()) {
        cerr << green << "AffineForward (Affine) with test data: OK." << def << endl;
    } else {
        cerr << red << "AffineForward (Affine) with test data: ERROR." << def << endl;
        allOk=false;
    }

    if (checkAffineBackward()) {
        cerr << green << "AffineBackward (Affine) with test data: OK." << def << endl;
    } else {
        cerr << red << "AffineBackward (Affine) with test data: ERROR." << def << endl;
        allOk=false;
    }

    if (checkReluForward()) {
        cerr << green << "ReluForward with test data: OK." << def << endl;
    } else {
        cerr << red << "ReluForward with test data: ERROR." << def << endl;
        allOk=false;
    }

    if (checkReluBackward()) {
        cerr << green << "ReluBackward (Affine) with test data: OK." << def << endl;
    } else {
        cerr << red << "ReluBackward (Affine) with test data: ERROR." << def << endl;
        allOk=false;
    }

    if (checkNonlinearityForward()) {
        cerr << green << "NonlinearityForward with test data: OK." << def << endl;
    } else {
        cerr << red << "NonlinearityForward with test data: ERROR." << def << endl;
        allOk=false;
    }

    if (checkNonlinearityBackward()) {
        cerr << green << "NonlinearityBackward with test data: OK." << def << endl;
    } else {
        cerr << red << "NonlinearityBackward with test data: ERROR." << def << endl;
        allOk=false;
    }

    if (checkBatchNormForward()) {
        cerr << green << "BatchNormForward with test data: OK." << def << endl;
    } else {
        cerr << red << "BatchNormForward with test data: ERROR." << def << endl;
        allOk=false;
    }

    if (checkBatchNormBackward()) {
        cerr << green << "BatchNormBackward with test data: OK." << def << endl;
    } else {
        cerr << red << "BatchNormBackward with test data: ERROR." << def << endl;
        allOk=false;
    }

    if (checkDropout()) {
        cerr << green << "Dropout with test data: OK." << def << endl;
    } else {
        cerr << red << "Dropout with test data: ERROR." << def << endl;
        allOk=false;
    }

    if (checkConvolutionForward()) {
        cerr << green << "ConvolutionForward (Convolution) with test data: OK." << def << endl;
    } else {
        cerr << red << "ConvolutionForward (Convolution) with test data: ERROR." << def << endl;
        allOk=false;
        exit(-1);
    }
    if (checkConvolutionBackward()) {
        cerr << green << "ConvolutionBackward (Convolution) with test data: OK." << def << endl;
    } else {
        cerr << red << "ConvolutionBackward (Convolution) with test data: ERROR." << def << endl;
        allOk=false;
    }

    if (checkPoolingForward()) {
        cerr << green << "PoolingForward with test data: OK." << def << endl;
    } else {
        cerr << red << "PoolingForward with test data: ERROR." << def << endl;
        allOk=false;
        exit(-1);
    }
    if (checkPoolingBackward()) {
        cerr << green << "PoolingBackward with test data: OK." << def << endl;
    } else {
        cerr << red << "PoolingBackward with test data: ERROR." << def << endl;
        allOk=false;
    }

    if (checkAffineRelu()) {
        cerr << green << "AffineRelu with test data: OK." << def << endl;
    } else {
        cerr << red << "AffineRelu with test data: ERROR." << def << endl;
        allOk=false;
    }

    if (checkSoftmax()) {
        cerr << green << "Softmax with test data: OK." << def << endl;
    } else {
        cerr << red << "Softmax with test data: ERROR." << def << endl;
        allOk=false;
    }
    if (checkSvm()) {
        cerr << green << "Svm with test data: OK." << def << endl;
    } else {
        cerr << red << "Svm with test data: ERROR." << def << endl;
        allOk=false;
    }

    if (checkTwoLayer()) {
        cerr << green << "TwoLayerNet with test data: OK." << def << endl;
    } else {
        cerr << red << "TwoLayerNet with test data: ERROR." << def << endl;
        allOk=false;
    }

    if (checkRNNStepForward()) {
        cerr << green << "RNNForwardStep with test data: OK." << def << endl;
    } else {
        cerr << red << "RNNForwardStep with test data: ERROR." << def << endl;
        allOk=false;
    }
    if (checkRNNStepBackward()) {
        cerr << green << "RNNBackwardStep with test data: OK." << def << endl;
    } else {
        cerr << red << "RNNBackwardStep with test data: ERROR." << def << endl;
        allOk=false;
    }
    if (checkRNNForward()) {
        cerr << green << "RNNForward with test data: OK." << def << endl;
    } else {
        cerr << red << "RNNForward with test data: ERROR." << def << endl;
        allOk=false;
    }
    if (checkRNNBackward()) {
        cerr << green << "RNNBackward with test data: OK." << def << endl;
    } else {
        cerr << red << "RNNBackward with test data: ERROR." << def << endl;
        allOk=false;
    }

    if (checkWordEmbeddingForward()) {
        cerr << green << "WordEmbeddingForward with test data: OK." << def << endl;
    } else {
        cerr << red << "WordEmbeddingForward with test data: ERROR." << def << endl;
        allOk=false;
    }
    if (checkWordEmbeddingBackward()) {
        cerr << green << "WordEmbeddingBackward with test data: OK." << def << endl;
    } else {
        cerr << red << "WordEmbeddingBackward with test data: ERROR." << def << endl;
        allOk=false;
    }

    if (checkTemporalAffineForward()) {
        cerr << green << "TemporalAffineForward with test data: OK." << def << endl;
    } else {
        cerr << red << "TemporalAffineForward with test data: ERROR." << def << endl;
        allOk=false;
    }

    if (checkTemporalAffineBackward()) {
        cerr << green << "TemporalAffineBackward with test data: OK." << def << endl;
    } else {
        cerr << red << "TemporalAffineBackward with test data: ERROR." << def << endl;
        allOk=false;
    }

    if (trainTest()) {
        cerr << green << "TrainTest: OK." << def << endl;
    } else {
        cerr << red << "TrainTest: ERROR." << def << endl;
        allOk=false;
    }


    if (registerTest()) {
        cerr << green << "RegisterTest: OK." << def << endl;
    } else {
        cerr << red << "RegisterTest: ERROR." << def << endl;
        allOk=false;
    }

    if (allOk) {
        cerr << green << "All tests ok." << def << endl;
    } else {
        cerr << red << "Tests failed." << def << endl;
    }

    return 0;
}

int main(int argc, char *argv[]) {
    string name="test";
    cpInitCompute(name);
    int ret=0;
    ret=doTests();
    cpExitCompute();
    return ret;
}
